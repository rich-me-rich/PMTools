<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Project Status Report (PSR) Builder ‚Äî Summary (v0.24)</title>
  <!--
  Hidden Change Log (do not render in UI)
  v0.24
   - Moved dates/period/phase directly under the ID/Sponsor/PM line in the report header
   - Removed numeric status labels (4.1‚Äì4.7) everywhere
   - Excluded ‚ÄúReport Preview‚Ä¶‚Äù helper text from print
   - Budget row styling tightened to reduce wrapping in print; variance pill set to no-wrap
   - Added theme toggle (light/dark) in top toolbar with persistence
   - Print: Risks truncation mitigated (page-break avoidance, wrapping, grid stacking on print)
   - Print: Further tightened budget variance no-wrap on narrow margins
  Notes
   - All new rules follow existing style unless requested otherwise.
  -->
  <style>
    :root {
      --bg: #ffffff;
      --fg: #1f2937; /* slate-800 */
      --muted: #6b7280; /* gray-500 */
      --card: #f8fafc; /* slate-50 */
      --chip-bg: #f1f5f9; /* slate-100 */
      --border: #e5e7eb; /* gray-200 */
      --accent: #2563eb; /* blue-600 */
      --success: #16a34a; /* green-600 */
      --warn: #f59e0b; /* amber-500 */
      --error: #dc2626; /* red-600 */
      --blue: #2563eb;
      --shadow: 0 1px 2px rgba(0,0,0,0.06), 0 1px 3px rgba(0,0,0,0.1);
    }
    [data-theme="dark"] {
      --bg: #0b0f14;
      --fg: #e5e7eb;
      --muted: #9ca3af;
      --card: #0f172a; /* slate-900 */
      --chip-bg: #111827; /* gray-900 */
      --border: #1f2937;
      --accent: #60a5fa;
      --success: #22c55e;
      --warn: #fbbf24;
      --error: #ef4444;
      --blue: #60a5fa;
      --shadow: 0 1px 2px rgba(0,0,0,0.4), 0 1px 3px rgba(0,0,0,0.5);
    }
    html, body { margin:0; height:100%; }
    body {
      background: var(--bg);
      color: var(--fg);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Ubuntu, Cantarell, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      line-height: 1.35;
    }
    .container { max-width: 1200px; margin: 0 auto; padding: 16px; }
    header.toolbar {
      position: sticky; top: 0; z-index: 30; background: var(--bg);
      border-bottom: 1px solid var(--border); padding: 8px 16px; box-shadow: var(--shadow);
      display:flex; align-items:center; gap: 8px; flex-wrap: wrap;
    }
    .title { font-weight: 700; letter-spacing: 0.2px; }
    .btn { border: 1px solid var(--border); background: var(--card); color: var(--fg); padding: 6px 10px; border-radius: 8px; cursor: pointer; box-shadow: var(--shadow); }
    .btn:hover { border-color: var(--accent); }
    .btn-primary { background: var(--accent); color: white; border-color: transparent; }
    .row { display:grid; grid-template-columns: repeat(12, 1fr); gap: 12px; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 12px; box-shadow: var(--shadow); }
    .card h2 { margin: 0 0 8px; font-size: 1.05rem; }
    label { font-size: 0.85rem; color: var(--muted); display:block; margin-bottom:4px; }
    input[type="text"], input[type="date"], select, textarea, input[type="number"] {
      width: 100%; background: var(--bg); color: var(--fg); border: 1px solid var(--border); border-radius: 8px; padding: 8px; box-sizing: border-box;
    }
    textarea { min-height: 84px; resize: vertical; }
    .chip { display:inline-flex; align-items:center; gap:6px; background: var(--chip-bg); border:1px solid var(--border); padding: 6px 10px; border-radius: 999px; white-space: nowrap; }
    .nowrap { white-space: nowrap; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .subtle { color: var(--muted); font-size: 0.9rem; }
    table { width:100%; border-collapse: collapse; }
    th, td { border: 1px solid var(--border); padding: 8px; vertical-align: top; }
    th { background: var(--bg); text-align: left; }
    .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .grid-3 { display:grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
    .grid-4 { display:grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }

    .status-chip { display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; color:#fff; font-weight:600; }
    .G { background: var(--success); }
    .A { background: var(--warn); }
    .R { background: var(--error); }
    .B { background: var(--blue); }
    .hidden { display:none; }

    /* Report (print) layout */
    #report { display:none; }
    #report h1 { margin: 0 0 4px; font-size: 1.6rem; }
    .report-header { display:grid; grid-template-columns: 1fr; gap: 6px; margin-bottom: 12px; }
    .report-line { display:flex; flex-wrap: wrap; gap: 10px; align-items:center; }
    .divider::after { content: "‚Ä¢"; margin: 0 6px; color: var(--muted); }
    .budget-row { display:flex; flex-wrap: wrap; gap: 8px; margin: 6px 0 12px; }
    .budget-chip { display:inline-flex; align-items:center; gap:6px; background: var(--chip-bg); border: 1px solid var(--border); padding: 6px 10px; border-radius: 999px; box-shadow: var(--shadow); }
    .budget-chip .label { color: var(--muted); }
    .budget-chip .value { font-weight: 700; }
    .budget-chip.variance { white-space: nowrap; }

    .report-sections { display:grid; grid-template-columns: 1.35fr 1fr; gap: 12px; }
    .section { border: 1px solid var(--border); border-radius: 10px; padding: 10px; background: var(--bg); }
    .section h3 { margin: 0 0 8px; font-size: 1.05rem; }

    /* Risk/Issue print safety: avoid truncation */
    .no-break { break-inside: avoid; page-break-inside: avoid; }

    @media print {
      body { background: #fff; }
      header.toolbar, #builder { display:none !important; }
      #report { display:block; }
      .report-sections { grid-template-columns: 1fr 1fr; }
      /* Stack wide tables on print to prevent truncation */
      .stack-on-print { display:grid; grid-template-columns: 1fr; }
      .budget-chip.variance { white-space: nowrap !important; }
      table td, table th { word-wrap: anywhere; }
      .no-break { break-inside: avoid; page-break-inside: avoid; }
    }
  </style>
</head>
<body>
  <header class="toolbar" role="banner">
    <div class="title">PSR Builder ‚Äî Summary <span class="subtle">(v0.24)</span></div>
    <div style="flex:1"></div>
    <button class="btn" id="btnNew">New</button>
    <input type="file" id="importFile" accept="application/json" class="hidden" />
    <button class="btn" id="btnImport">Import JSON</button>
    <button class="btn" id="btnSave">Save JSON</button>
    <button class="btn" id="btnCSV">Export CSV</button>
    <button class="btn" id="btnJump">Jump to Report</button>
    <button class="btn" id="btnPrint">Print Report</button>
    <button class="btn" id="btnTheme" title="Toggle theme">üåô / ‚òÄÔ∏è</button>
  </header>

  <main class="container">
    <section id="builder" aria-label="Status Builder">
      <!-- Base Project Information -->
      <div class="card" style="margin-top:12px;">
        <h2>Base Project Information</h2>
        <div class="row">
          <div class="col" style="grid-column: span 6;">
            <label>Project Name</label>
            <input id="projectName" type="text" placeholder="e.g., Core Banking Upgrade" />
          </div>
          <div class="col" style="grid-column: span 3;">
            <label>Project ID</label>
            <input id="projectId" type="text" />
          </div>
          <div class="col" style="grid-column: span 3;">
            <label>Project Sponsor</label>
            <input id="sponsor" type="text" />
          </div>
          <div class="col" style="grid-column: span 3;">
            <label>Project Manager</label>
            <input id="pm" type="text" />
          </div>
          <div class="col" style="grid-column: span 3;">
            <label>Current Phase</label>
            <input id="phase" type="text" placeholder="e.g., Build" />
          </div>
          <div class="col" style="grid-column: span 3;">
            <label>Report Date</label>
            <input id="reportDate" type="date" />
          </div>
          <div class="col" style="grid-column: span 3;">
            <label>Reporting Period</label>
            <input id="reportingPeriod" type="text" placeholder="e.g., 10‚Äì16 Aug 2025" />
          </div>
        </div>
      </div>

      <!-- Budget (000's) -->
      <div class="card">
        <h2>Budget (000‚Äôs)</h2>
        <div class="grid-4">
          <div>
            <label>Approved</label>
            <input id="budgetApproved" type="number" step="0.01" />
          </div>
          <div>
            <label>Spent</label>
            <input id="budgetSpent" type="number" step="0.01" />
          </div>
          <div>
            <label>ETC</label>
            <input id="budgetETC" type="number" step="0.01" />
          </div>
          <div>
            <label>EAC (auto)</label>
            <input id="budgetEAC" type="number" step="0.01" disabled />
          </div>
        </div>
        <div style="margin-top:8px;" class="grid-2">
          <div>
            <label>Variance (auto)</label>
            <input id="budgetVar" type="text" disabled />
          </div>
        </div>
      </div>

      <!-- Narrative -->
      <div class="card">
        <h2>Narrative</h2>
        <div class="grid-2">
          <div>
            <label>Key achievements</label>
            <textarea id="achievements" placeholder="Bullet points recommended"></textarea>
          </div>
          <div>
            <label>Next period</label>
            <textarea id="nextPeriod" placeholder="Upcoming activities"></textarea>
          </div>
        </div>
      </div>

      <!-- Status Summary -->
      <div class="card">
        <h2>Status Summary</h2>
        <div class="subtle" style="margin-bottom:6px;">Current vs Previous with notes (no numeric prefixes)</div>
        <table>
          <thead>
            <tr>
              <th>Area</th>
              <th>Current</th>
              <th>Previous</th>
              <th>Notes</th>
            </tr>
          </thead>
          <tbody id="statusBody"></tbody>
        </table>
      </div>

      <!-- Milestones -->
      <div class="card">
        <h2>Milestones</h2>
        <button class="btn" id="addMilestone">Add Milestone</button>
        <table style="margin-top:8px;">
          <thead>
            <tr>
              <th>Include</th>
              <th>Milestone</th>
              <th>Date</th>
              <th>Status</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="milestoneBody"></tbody>
        </table>
      </div>

      <!-- Issues & Risks -->
      <div class="grid-2">
        <div class="card">
          <h2>Issues</h2>
          <button class="btn" id="addIssue">Add Issue</button>
          <table style="margin-top:8px;">
            <thead>
              <tr>
                <th>Include</th>
                <th>ID</th>
                <th>Description</th>
                <th>Impact</th>
                <th>Owner</th>
                <th>Status</th>
                <th>Next steps</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="issueBody"></tbody>
          </table>
        </div>
        <div class="card">
          <h2>Risks</h2>
          <button class="btn" id="addRisk">Add Risk</button>
          <table style="margin-top:8px;">
            <thead>
              <tr>
                <th>Include</th>
                <th>ID</th>
                <th>Description</th>
                <th>Rating</th>
                <th>Mitigation</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="riskBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Decisions -->
      <div class="card">
        <h2>Decisions</h2>
        <button class="btn" id="addDecision">Add Decision</button>
        <table style="margin-top:8px;">
          <thead>
            <tr>
              <th>Include</th>
              <th>Decision</th>
              <th>Required by</th>
              <th>Owner</th>
              <th>Status</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="decisionBody"></tbody>
        </table>
      </div>

      <!-- Dependencies & Constraints -->
      <div class="card">
        <h2>Dependencies & Constraints</h2>
        <button class="btn" id="addDep">Add Item</button>
        <table style="margin-top:8px;">
          <thead>
            <tr>
              <th>Include</th>
              <th>Ref/ID</th>
              <th>Dependency</th>
              <th>Impact</th>
              <th>Owner</th>
              <th>Actions</th>
              <th>Status</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="depBody"></tbody>
        </table>
      </div>
    </section>

    <!-- REPORT / PRINT -->
    <section id="report" aria-label="Project Status Report">
      <h1>Project Status Report ‚Äì Project <span id="r_projectName">[Name]</span></h1>
      <div class="report-header">
        <div class="report-line">
          <span id="r_projectId"></span>
          <span class="divider"></span>
          <span id="r_sponsor"></span>
          <span class="divider"></span>
          <span id="r_pm"></span>
        </div>
        <div class="report-line">
          <span id="r_reportDate"></span>
          <span class="divider"></span>
          <span id="r_reportingPeriod"></span>
          <span class="divider"></span>
          <span id="r_phase"></span>
        </div>
      </div>

      <div class="budget-row">
        <div class="budget-chip"><span class="label">Approved</span> <span class="value" id="r_appr"></span></div>
        <div class="budget-chip"><span class="label">Spent</span> <span class="value" id="r_spent"></span></div>
        <div class="budget-chip"><span class="label">ETC</span> <span class="value" id="r_etc"></span></div>
        <div class="budget-chip"><span class="label">EAC</span> <span class="value" id="r_eac"></span></div>
        <div class="budget-chip variance nowrap"><span class="label">Variance</span> <span class="value" id="r_var"></span></div>
      </div>

      <div class="section no-break">
        <h3>Overall Project Status</h3>
        <div id="r_overall"></div>
      </div>

      <div class="report-sections" style="margin-top:12px;">
        <div class="section no-break">
          <h3>Status (detail)</h3>
          <div id="r_statusTable"></div>
          <h3 style="margin-top:12px;">Issues</h3>
          <div id="r_issues" class="stack-on-print"></div>
          <h3 style="margin-top:12px;">Decisions</h3>
          <div id="r_decisions" class="stack-on-print"></div>
          <h3 style="margin-top:12px;">Dependencies & Constraints</h3>
          <div id="r_deps" class="stack-on-print"></div>
        </div>
        <div class="section no-break">
          <h3>Milestones</h3>
          <div id="r_milestones" class="stack-on-print"></div>
          <h3 style="margin-top:12px;">Risks</h3>
          <div id="r_risks" class="stack-on-print"></div>
        </div>
      </div>
    </section>
  </main>

  <script>
    // Theme persistence
    const root = document.documentElement;
    const savedTheme = localStorage.getItem('psr_theme');
    if (savedTheme) root.setAttribute('data-theme', savedTheme);
    document.getElementById('btnTheme').addEventListener('click', () => {
      const next = root.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
      root.setAttribute('data-theme', next);
      localStorage.setItem('psr_theme', next);
    });

    // Helpers
    const el = id => document.getElementById(id);
    const money = v => (isNaN(v) || v === null) ? '' : Number(v).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 });

    // Initialize status rows (no numeric labels)
    const statusAreas = ['Overall','Scope','Schedule','Budget','Quality','Risk','Stakeholder'];
    const statusOptions = ['G','A','R','B'];

    function statusRow(area){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${area}</td>
        <td>
          <select>${statusOptions.map(s=>`<option value="${s}">${s}</option>`).join('')}</select>
        </td>
        <td>
          <select>${statusOptions.map(s=>`<option value="${s}">${s}</option>`).join('')}</select>
        </td>
        <td><input type="text" placeholder="Notes"/></td>`;
      return tr;
    }

    const statusBody = el('statusBody');
    statusAreas.forEach(a=>statusBody.appendChild(statusRow(a)));

    // Dynamic tables
    function addRow(tbody, cells){
      const tr = document.createElement('tr');
      tr.innerHTML = cells + '<td><button class="btn" type="button">Remove</button></td>';
      tr.querySelector('button').addEventListener('click',()=> tr.remove());
      tbody.appendChild(tr);
    }

    el('addMilestone').addEventListener('click',()=>{
      addRow(el('milestoneBody'),`
        <td><input type="checkbox" checked /></td>
        <td><input type="text" placeholder="Milestone"/></td>
        <td><input type="date"/></td>
        <td><select><option>On Track</option><option>At Risk</option><option>Delayed</option><option>Complete</option></select></td>
      `);
    });

    el('addIssue').addEventListener('click',()=>{
      addRow(el('issueBody'),`
        <td><input type="checkbox" checked /></td>
        <td><input type="text" class="mono" placeholder="ISS-001"/></td>
        <td><input type="text" placeholder="Description"/></td>
        <td>
          <select>
            <option>Schedule</option>
            <option>Budget</option>
            <option>Scope</option>
            <option>Quality</option>
          </select>
        </td>
        <td><input type="text" placeholder="Owner"/></td>
        <td><select><option>Open</option><option>In Progress</option><option>Blocked</option><option>Closed</option></select></td>
        <td><input type="text" placeholder="Next steps"/></td>
      `);
    });

    el('addRisk').addEventListener('click',()=>{
      addRow(el('riskBody'),`
        <td><input type="checkbox" checked /></td>
        <td><input type="text" class="mono" placeholder="RSK-001"/></td>
        <td><input type="text" placeholder="Description"/></td>
        <td><select><option>Very Low</option><option>Low</option><option>Medium</option><option>High</option><option>Critical</option></select></td>
        <td><input type="text" placeholder="Mitigation"/></td>
      `);
    });

    el('addDecision').addEventListener('click',()=>{
      addRow(el('decisionBody'),`
        <td><input type="checkbox" checked /></td>
        <td><input type="text" placeholder="Decision"/></td>
        <td><input type="date"/></td>
        <td><input type="text" placeholder="Owner"/></td>
        <td><select><option>Pending</option><option>Approved</option><option>Rejected</option><option>Deferred</option></select></td>
      `);
    });

    el('addDep').addEventListener('click',()=>{
      addRow(el('depBody'),`
        <td><input type="checkbox" checked /></td>
        <td><input type="text" class="mono" placeholder="DEP-001"/></td>
        <td><input type="text" placeholder="Dependency / Constraint"/></td>
        <td>
          <select>
            <option>Schedule</option>
            <option>Budget</option>
            <option>Scope</option>
            <option>Quality</option>
          </select>
        </td>
        <td><input type="text" placeholder="Owner"/></td>
        <td><input type="text" placeholder="Actions"/></td>
        <td><select><option>Open</option><option>In Progress</option><option>Blocked</option><option>Closed</option></select></td>
      `);
    });

    // Budget auto-calc
    function recalcBudget(){
      const appr = parseFloat(el('budgetApproved').value)||0;
      const spent = parseFloat(el('budgetSpent').value)||0;
      const etc = parseFloat(el('budgetETC').value)||0;
      const eac = spent + etc;
      const variance = appr - eac; // positive = under
      el('budgetEAC').value = eac.toFixed(0);
      el('budgetVar').value = `${variance>=0?'+':''}${variance.toFixed(0)} (${variance>=0? 'under':'over'})`;
    }
    ['budgetApproved','budgetSpent','budgetETC'].forEach(id=> el(id).addEventListener('input', recalcBudget));

    // Gather data
    function gather(){
      const getRows = (tbodyId, map) => Array.from(el(tbodyId).querySelectorAll('tr')).map(tr=> map(tr));
      const statuses = {};
      Array.from(statusBody.querySelectorAll('tr')).forEach((tr,i)=>{
        const area = statusAreas[i];
        const [curSel, prevSel, note] = [tr.children[1].querySelector('select'), tr.children[2].querySelector('select'), tr.children[3].querySelector('input')];
        statuses[area] = { current: curSel.value, previous: prevSel.value, notes: note.value };
      });
      return {
        meta: {
          name: el('projectName').value.trim(), id: el('projectId').value.trim(), sponsor: el('sponsor').value.trim(), pm: el('pm').value.trim(),
          phase: el('phase').value.trim(), reportDate: el('reportDate').value, reportingPeriod: el('reportingPeriod').value.trim()
        },
        budget: { approved: el('budgetApproved').value, spent: el('budgetSpent').value, etc: el('budgetETC').value, eac: el('budgetEAC').value, variance: el('budgetVar').value },
        narrative: { achievements: el('achievements').value, next: el('nextPeriod').value },
        status: statuses,
        milestones: getRows('milestoneBody', tr=> ({ include: tr.children[0].querySelector('input').checked, name: tr.children[1].querySelector('input').value, date: tr.children[2].querySelector('input').value, status: tr.children[3].querySelector('select').value })),
        issues: getRows('issueBody', tr=> ({ include: tr.children[0].querySelector('input').checked, id: tr.children[1].querySelector('input').value, desc: tr.children[2].querySelector('input').value, impact: tr.children[3].querySelector('select').value, owner: tr.children[4].querySelector('input').value, status: tr.children[5].querySelector('select').value, next: tr.children[6].querySelector('input').value })),
        risks: getRows('riskBody', tr=> ({ include: tr.children[0].querySelector('input').checked, id: tr.children[1].querySelector('input').value, desc: tr.children[2].querySelector('input').value, rating: tr.children[3].querySelector('select').value, mitigation: tr.children[4].querySelector('input').value })),
        decisions: getRows('decisionBody', tr=> ({ include: tr.children[0].querySelector('input').checked, decision: tr.children[1].querySelector('input').value, requiredBy: tr.children[2].querySelector('input').value, owner: tr.children[3].querySelector('input').value, status: tr.children[4].querySelector('select').value })),
        deps: getRows('depBody', tr=> ({ include: tr.children[0].querySelector('input').checked, ref: tr.children[1].querySelector('input').value, dep: tr.children[2].querySelector('input').value, impact: tr.children[3].querySelector('select').value, owner: tr.children[4].querySelector('input').value, actions: tr.children[5].querySelector('input').value, status: tr.children[6].querySelector('select').value }))
      };
    }

    // Render report
    function renderReport(d){
      el('r_projectName').textContent = d.meta.name || '[Name]';
      el('r_projectId').textContent = d.meta.id ? `Project ID: ${d.meta.id}` : '';
      el('r_sponsor').textContent = d.meta.sponsor ? `Sponsor: ${d.meta.sponsor}` : '';
      el('r_pm').textContent = d.meta.pm ? `PM: ${d.meta.pm}` : '';
      el('r_reportDate').textContent = d.meta.reportDate ? `Report date: ${d.meta.reportDate}` : '';
      el('r_reportingPeriod').textContent = d.meta.reportingPeriod ? `Reporting period: ${d.meta.reportingPeriod}` : '';
      el('r_phase').textContent = d.meta.phase ? `Phase: ${d.meta.phase}` : '';

      const appr = Number(d.budget.approved||0), spent = Number(d.budget.spent||0), etc = Number(d.budget.etc||0);
      const eac = spent + etc; const variance = appr - eac;
      el('r_appr').textContent = `$${money(appr)}k`;
      el('r_spent').textContent = `$${money(spent)}k`;
      el('r_etc').textContent = `$${money(etc)}k`;
      el('r_eac').textContent = `$${money(eac)}k`;
      el('r_var').textContent = `${variance>=0?'+':''}$${money(variance)}k ${variance>=0? '(under)':'(over)'}`;

      // Overall chip
      const overall = d.status['Overall']?.current || 'G';
      el('r_overall').innerHTML = `<span class="status-chip ${overall}">${overall === 'G' ? 'Green' : overall === 'A' ? 'Amber' : overall === 'R' ? 'Red' : 'Blue'}</span>`;

      // Status detail table
      const rows = statusAreas.filter(a=>a!=='Overall').map(a=>{
        const cur = d.status[a]?.current || 'G';
        const prev = d.status[a]?.previous || 'G';
        const notes = d.status[a]?.notes || '';
        const chip = s=>`<span class="status-chip ${s}">${s==='G'?'Green':s==='A'?'Amber':s==='R'?'Red':'Blue'}</span>`;
        return `<tr><td>${a}</td><td>${chip(cur)}</td><td>${chip(prev)}</td><td>${notes}</td></tr>`;
      }).join('');
      el('r_statusTable').innerHTML = `<table><thead><tr><th>Area</th><th>Current</th><th>Previous</th><th>Notes</th></tr></thead><tbody>${rows}</tbody></table>`;

      // Milestones
      const msRows = d.milestones.filter(m=>m.include).map(m=>`<tr><td>${m.name||''}</td><td>${m.date||''}</td><td>${m.status||''}</td></tr>`).join('');
      el('r_milestones').innerHTML = `<table><thead><tr><th>Milestone</th><th>Date</th><th>Status</th></tr></thead><tbody>${msRows||''}</tbody></table>`;

      // Issues
      const isRows = d.issues.filter(i=>i.include).map(i=>`<tr><td class="mono">${i.id||''}</td><td>${i.desc||''}</td><td>${i.impact||''}</td><td>${i.owner||''}</td><td>${i.status||''}</td><td>${i.next||''}</td></tr>`).join('');
      el('r_issues').innerHTML = `<table class="no-break"><thead><tr><th>ID</th><th>Description</th><th>Impact</th><th>Owner</th><th>Status</th><th>Next steps</th></tr></thead><tbody>${isRows||''}</tbody></table>`;

      // Risks (print-safe)
      const rkRows = d.risks.filter(r=>r.include).map(r=>`<tr><td class="mono">${r.id||''}</td><td>${r.desc||''}</td><td>${r.rating||''}</td><td>${r.mitigation||''}</td></tr>`).join('');
      el('r_risks').innerHTML = `<table class="no-break"><thead><tr><th>ID</th><th>Description</th><th>Rating</th><th>Mitigation</th></tr></thead><tbody>${rkRows||''}</tbody></table>`;

      // Decisions
      const dcRows = d.decisions.filter(c=>c.include).map(c=>`<tr><td>${c.decision||''}</td><td>${c.requiredBy||''}</td><td>${c.owner||''}</td><td>${c.status||''}</td></tr>`).join('');
      el('r_decisions').innerHTML = `<table class="no-break"><thead><tr><th>Decision</th><th>Required by</th><th>Owner</th><th>Status</th></tr></thead><tbody>${dcRows||''}</tbody></table>`;

      // Dependencies
      const dpRows = d.deps.filter(dp=>dp.include).map(dp=>`<tr><td class="mono">${dp.ref||''}</td><td>${dp.dep||''}</td><td>${dp.impact||''}</td><td>${dp.owner||''}</td><td>${dp.actions||''}</td><td>${dp.status||''}</td></tr>`).join('');
      el('r_deps').innerHTML = `<table class="no-break"><thead><tr><th>Ref/ID</th><th>Dependency</th><th>Impact</th><th>Owner</th><th>Actions</th><th>Status</th></tr></thead><tbody>${dpRows||''}</tbody></table>`;
    }

    // Toolbar actions
    el('btnNew').addEventListener('click', ()=>{
      if (!confirm('Clear all fields?')) return;
      location.reload();
    });

    el('btnJump').addEventListener('click', ()=>{
      renderReport(gather());
      document.getElementById('report').scrollIntoView({ behavior: 'smooth' });
    });

    el('btnPrint').addEventListener('click', ()=>{
      renderReport(gather());
      window.print();
    });

    el('btnImport').addEventListener('click', ()=> el('importFile').click());
    el('importFile').addEventListener('change', async (e)=>{
      const file = e.target.files[0]; if(!file) return;
      const text = await file.text();
      try { const d = JSON.parse(text); load(d); } catch(err){ alert('Invalid JSON'); }
    });

    el('btnSave').addEventListener('click', ()=>{
      const d = gather();
      const name = d.meta.name || prompt('Enter Project Name for filename:','') || 'project';
      const blob = new Blob([JSON.stringify(d,null,2)], {type:'application/json'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `${name}.psr.json`; a.click(); URL.revokeObjectURL(a.href);
    });

    el('btnCSV').addEventListener('click', ()=>{
      const d = gather();
      const lines = [];
      const push = arr => lines.push(arr.map(v=>`"${(v??'').toString().replaceAll('"','""')}"`).join(','));
      // Meta & Budget
      push(['Project Name','Project ID','Sponsor','PM','Report Date','Reporting Period','Phase','Approved(k)','Spent(k)','ETC(k)','EAC(k)','Variance']);
      const appr = Number(d.budget.approved||0), spent = Number(d.budget.spent||0), etc = Number(d.budget.etc||0), eac = spent+etc, variance = appr - eac;
      push([d.meta.name,d.meta.id,d.meta.sponsor,d.meta.pm,d.meta.reportDate,d.meta.reportingPeriod,d.meta.phase,appr,spent,etc,eac,`${variance>=0?'+':''}${variance}`]);
      lines.push('');
      // Status
      push(['Status Area','Current','Previous','Notes']);
      statusAreas.forEach(a=> push([a, d.status[a]?.current||'', d.status[a]?.previous||'', d.status[a]?.notes||'']));
      lines.push('');
      // Milestones
      push(['Milestone (Included Only)']);
      push(['Milestone','Date','Status']);
      d.milestones.filter(m=>m.include).forEach(m=> push([m.name,m.date,m.status]));
      lines.push('');
      // Issues
      push(['Issues (Included Only)']);
      push(['ID','Description','Impact','Owner','Status','Next steps']);
      d.issues.filter(i=>i.include).forEach(i=> push([i.id,i.desc,i.impact,i.owner,i.status,i.next]));
      lines.push('');
      // Risks
      push(['Risks (Included Only)']);
      push(['ID','Description','Rating','Mitigation']);
      d.risks.filter(r=>r.include).forEach(r=> push([r.id,r.desc,r.rating,r.mitigation]));
      lines.push('');
      // Decisions
      push(['Decisions (Included Only)']);
      push(['Decision','Required by','Owner','Status']);
      d.decisions.filter(c=>c.include).forEach(c=> push([c.decision,c.requiredBy,c.owner,c.status]));
      lines.push('');
      // Dependencies
      push(['Dependencies & Constraints (Included Only)']);
      push(['Ref/ID','Dependency','Impact','Owner','Actions','Status']);
      d.deps.filter(dp=>dp.include).forEach(dp=> push([dp.ref,dp.dep,dp.impact,dp.owner,dp.actions,dp.status]));

      const blob = new Blob([lines.join('\n')], {type:'text/csv'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
      const name = d.meta.name || 'project';
      a.download = `${name}.psr.summary.csv`; a.click(); URL.revokeObjectURL(a.href);
    });

    // Load from data object
    function load(d){
      const set = (id,val)=>{ if(el(id)) el(id).value = val||''; };
      set('projectName', d.meta?.name);
      set('projectId', d.meta?.id);
      set('sponsor', d.meta?.sponsor);
      set('pm', d.meta?.pm);
      set('phase', d.meta?.phase);
      set('reportDate', d.meta?.reportDate);
      set('reportingPeriod', d.meta?.reportingPeriod);
      set('budgetApproved', d.budget?.approved);
      set('budgetSpent', d.budget?.spent);
      set('budgetETC', d.budget?.etc);
      recalcBudget();

      // Status
      Array.from(statusBody.querySelectorAll('tr')).forEach((tr,i)=>{
        const area = statusAreas[i];
        const st = d.status?.[area] || {};
        tr.children[1].querySelector('select').value = st.current || 'G';
        tr.children[2].querySelector('select').value = st.previous || 'G';
        tr.children[3].querySelector('input').value = st.notes || '';
      });

      // Tables
      const fill = (tbodyId, rows, tpl)=>{
        el(tbodyId).innerHTML = ''; (rows||[]).forEach(r=> addRow(el(tbodyId), tpl(r)));
      };

      fill('milestoneBody', d.milestones, (m)=>`
        <td><input type="checkbox" ${m.include? 'checked':''} /></td>
        <td><input type="text" value="${m.name||''}"/></td>
        <td><input type="date" value="${m.date||''}"/></td>
        <td><select>
            <option ${m.status==='On Track'?'selected':''}>On Track</option>
            <option ${m.status==='At Risk'?'selected':''}>At Risk</option>
            <option ${m.status==='Delayed'?'selected':''}>Delayed</option>
            <option ${m.status==='Complete'?'selected':''}>Complete</option>
          </select></td>
      `);

      fill('issueBody', d.issues, (i)=>`
        <td><input type="checkbox" ${i.include? 'checked':''} /></td>
        <td><input type="text" class="mono" value="${i.id||''}"/></td>
        <td><input type="text" value="${i.desc||''}"/></td>
        <td>
          <select>
            <option ${i.impact==='Schedule'?'selected':''}>Schedule</option>
            <option ${i.impact==='Budget'?'selected':''}>Budget</option>
            <option ${i.impact==='Scope'?'selected':''}>Scope</option>
            <option ${i.impact==='Quality'?'selected':''}>Quality</option>
          </select>
        </td>
        <td><input type="text" value="${i.owner||''}"/></td>
        <td><select>
            <option ${i.status==='Open'?'selected':''}>Open</option>
            <option ${i.status==='In Progress'?'selected':''}>In Progress</option>
            <option ${i.status==='Blocked'?'selected':''}>Blocked</option>
            <option ${i.status==='Closed'?'selected':''}>Closed</option>
          </select></td>
        <td><input type="text" value="${i.next||''}"/></td>
      `);

      fill('riskBody', d.risks, (r)=>`
        <td><input type="checkbox" ${r.include? 'checked':''} /></td>
        <td><input type="text" class="mono" value="${r.id||''}"/></td>
        <td><input type="text" value="${r.desc||''}"/></td>
        <td><select>
            <option ${r.rating==='Very Low'?'selected':''}>Very Low</option>
            <option ${r.rating==='Low'?'selected':''}>Low</option>
            <option ${r.rating==='Medium'?'selected':''}>Medium</option>
            <option ${r.rating==='High'?'selected':''}>High</option>
            <option ${r.rating==='Critical'?'selected':''}>Critical</option>
          </select></td>
        <td><input type="text" value="${r.mitigation||''}"/></td>
      `);

      fill('decisionBody', d.decisions, (c)=>`
        <td><input type="checkbox" ${c.include? 'checked':''} /></td>
        <td><input type="text" value="${c.decision||''}"/></td>
        <td><input type="date" value="${c.requiredBy||''}"/></td>
        <td><input type="text" value="${c.owner||''}"/></td>
        <td><select>
            <option ${c.status==='Pending'?'selected':''}>Pending</option>
            <option ${c.status==='Approved'?'selected':''}>Approved</option>
            <option ${c.status==='Rejected'?'selected':''}>Rejected</option>
            <option ${c.status==='Deferred'?'selected':''}>Deferred</option>
          </select></td>
      `);

      fill('depBody', d.deps, (dp)=>`
        <td><input type="checkbox" ${dp.include? 'checked':''} /></td>
        <td><input type="text" class="mono" value="${dp.ref||''}"/></td>
        <td><input type="text" value="${dp.dep||''}"/></td>
        <td>
          <select>
            <option ${dp.impact==='Schedule'?'selected':''}>Schedule</option>
            <option ${dp.impact==='Budget'?'selected':''}>Budget</option>
            <option ${dp.impact==='Scope'?'selected':''}>Scope</option>
            <option ${dp.impact==='Quality'?'selected':''}>Quality</option>
          </select>
        </td>
        <td><input type="text" value="${dp.owner||''}"/></td>
        <td><input type="text" value="${dp.actions||''}"/></td>
        <td><select>
            <option ${dp.status==='Open'?'selected':''}>Open</option>
            <option ${dp.status==='In Progress'?'selected':''}>In Progress</option>
            <option ${dp.status==='Blocked'?'selected':''}>Blocked</option>
            <option ${dp.status==='Closed'?'selected':''}>Closed</option>
          </select></td>
      `);
    }

    // Seed with one empty row for each table for usability
    ['addMilestone','addIssue','addRisk','addDecision','addDep'].forEach(id=> el(id).click());
  </script>
</body>
</html>
