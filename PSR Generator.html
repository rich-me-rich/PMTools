<!--
Mini Change Log:
v0.25 – Added theme toggle (light/dark) with persisted selection; Print: ensured Risks section doesn't truncate by avoiding page-breaks and stacking to one column when printing; Budget Variance pill tightened to prevent wrapping in print. Version bump.
v0.25 – Print: keep Budget Variance on one line; removed preview... ID row; removed 4.x numbering from Status labels. Version bump.
v0.23 – Section 6: Issue Impact & Status now dropdowns; Risk Rat...h full names; Status & Milestones now equal width. Version bump.
v0.22 – General: right-align numeric fields (inputs & report) wi.../ Risk ID / Risk rating. Section 5 (report) shows overall commen
v0.21 – Issues/Risks IDs + rating; larger icons; wider Item col; emphasize Overall status; removed per-item comments in report.
v0.20 – Report wording/ordering updates; jump-to-report; print-only shows report.
v0.19 – Initial canvas build.
-->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Project Status Report (PSR) Builder — Summary (v0.25)</title>
<style>
  :root{
    --bg:#f8fafc; --card:#ffffff; --border:#e5e7eb; --text:#0f172a; --text-dim:#475569; --chip:#f1f5f9;
    --shadow: 0 6px 24px rgba(15,23,42,.06), 0 2px 8px rgba(15,23,42,.04);
    --btn:#2563eb; --btn-text:#ffffff; --btn-hover:#1e40af;
    --btn-alt:#059669; --btn-alt-hover:#047857
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;line-height:1.45;transition:background .25s,color .25s}
  h1{font-size:1.4rem;margin:.25rem 0 .5rem}
  h2{font-size:1.1rem;font-weight:700}
  h3{font-size:1rem;color:var(--text-dim);font-weight:600}
  .container{max-width:1200px;margin:0 auto;padding:24px}
  .grid{display:grid;gap:16px}
  .cols-2{grid-template-columns:1fr 1fr}
  .cols-2-slim{grid-template-columns:1fr 1fr}
  .cols-4{grid-template-columns:repeat(4,1fr)}
  .cols-5-tight{grid-template-columns:repeat(5,minmax(0,1fr))}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:16px;margin-bottom:12px}
  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .toolbar .spacer{flex:1}
  .field{display:flex;flex-direction:column;gap:6px}
  label{font-size:.85rem;color:var(--text-dim)}
  input[type="text"],input[type="date"],input[type="number"],select,textarea{
    width:100%;border:1px solid var(--border);background:#fff;color:var(--text);border-radius:12px;padding:10px 12px
  }
  textarea{min-height:80px}
  table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--border);border-radius:14px;overflow:hidden}
  th,td{border-bottom:1px solid var(--border);padding:10px;background:#fff}
  th{background:#f8fafc;font-weight:700;text-align:left}
  tr:last-child td{border-bottom:none}
  .btn{appearance:none;border:1px solid var(--border);background:var(--btn);color:var(--btn-text);padding:9px 12px;border-radius:12px;font-weight:600;cursor:pointer}
  .btn:hover{background:var(--btn-hover)}
  .btn.alt{background:var(--btn-alt)}
  .btn.alt:hover{background:var(--btn-alt-hover)}
  .btn.ghost{background:transparent;color:var(--text);border-color:var(--border)}
  .status-pill{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:4px 10px;border:1px solid var(--border);background:var(--chip)}
  .budget-row{display:flex;flex-wrap:wrap;gap:10px}
  .pill{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--border);border-radius:999px;padding:6px 10px;background:var(--chip)}
  .tnum{font-variant-numeric:tabular-nums}
  .status-chip{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:var(--chip)}
  .chip{display:inline-flex;gap:6px;align-items:center;padding:4px 8px;border-radius:999px;background:var(--chip);border:1px solid var(--border)}
  .guidance{background:#f1f5f9;padding:10px;border-left:3px solid #cbd5e1;border-radius:10px;color:#334155}
  .narrow input,.narrow select{padding:8px 10px}
  .cols-stack{grid-template-columns:1fr}

  /* ===== Dark Theme Overrides ===== */
  body.dark{
    --bg:#0b1220; --card:#0f172a; --border:#1e293b;
    --text:#e5e7eb; --text-dim:#94a3b8;
    --chip:#0b1220;
    --shadow: 0 6px 24px rgba(0,0,0,.55), 0 2px 8px rgba(0,0,0,.45);
    --btn:#3b82f6; --btn-text:#ffffff; --btn-hover:#1d4ed8;
    --btn-alt:#10b981; --btn-alt-hover:#059669;
  }
  body.dark input[type="text"], body.dark input[type="date"], body.dark input[type="number"], body.dark select, body.dark textarea{
    background:#0b1220; color:var(--text); border-color:#243244;
  }
  body.dark th, body.dark td{ background:#0f172a; border-color:#1e293b; }
  body.dark .btn{ border-color:#334155; }
  body.dark .guidance{ background:#0f172a; border-left-color:#334155; color:var(--text-dim); }

  /* Print tighten: budget pills don't wrap */
  @media print{
    .budget-row{flex-wrap:nowrap; gap:8px}
    .budget-row .status-chip, .budget-row .pill{white-space:nowrap}
    .budget-row strong{margin-right:4px}
    .budget-row .tnum{display:inline-block}
  }
  /* Avoid page breaks inside report tables and stack Issues/Risks when printing */
  .report-section table, .report-section tr, .report-section td, .report-section th{ break-inside: avoid; page-break-inside: avoid; }
  @media print{
    .issues-risks{ grid-template-columns:1fr !important; }
  }

  /* Print view only shows report */
  @media print{
    .no-print{display:none !important}
    .only-print{display:block !important}
  }
  .only-print{display:none}
</style>
</head>
<body>
<div class="container no-print">
  <h1>Project Status Report (PSR) Builder — Summary (<span class="tnum">v0.25</span>)</h1>
  <div class="guidance">Use the builder to capture this week's status, then click <strong>Jump to Report</strong> to preview and <strong>Print Report</strong> for a clean output.</div>

  <!-- Toolbar 1 -->
  <div class="toolbar" style="margin-top:8px">
    <button class="btn" id="newBtn">New</button>
    <label class="btn ghost" for="importJson" title="Import previously saved JSON">Import JSON<input id="importJson" type="file" accept="application/json" style="display:none"></label>
    <button class="btn" id="saveJsonBtn">Save JSON</button>
    <button class="btn alt" id="exportCsvBtn">Export CSV (Summary)</button>
    <div class="spacer"></div>
    <span class="chip">Report builder toolbar</span>
  </div>

  <!-- Base Info -->
  <div class="card">
    <h2>Base Project Information</h2>
    <div class="grid cols-4 narrow">
      <div class="field"><label>Project Name</label><input id="projectName" type="text" placeholder="e.g., Core Banking Upgrade"/></div>
      <div class="field"><label>Project ID</label><input id="projectId" type="text" placeholder="e.g., PRJ-042"/></div>
      <div class="field"><label>Sponsor</label><input id="sponsor" type="text"/></div>
      <div class="field"><label>Project Manager</label><input id="pm" type="text"/></div>
      <div class="field"><label>Project Phase</label><input id="phase" type="text" placeholder="e.g., Execution"/></div>
      <div class="field"><label>Report Date</label><input id="reportDate" type="date"/></div>
      <div class="field"><label>Reporting Period</label><input id="reportPeriod" type="text" placeholder="e.g., 4–10 Aug 2025"/></div>
    </div>
  </div>

  <!-- Budget -->
  <div class="card">
    <h2>Budget (000’s)</h2>
    <div class="grid cols-4 narrow">
      <div class="field"><label>Approved</label><input type="number" id="budgetApproved" value="0"/></div>
      <div class="field"><label>Spent</label><input type="number" id="budgetSpent" value="0"/></div>
      <div class="field"><label>ETC</label><input type="number" id="budgetETC" value="0"/></div>
      <div class="field"><label>Variance (auto)</label><input type="text" id="budgetVariance" disabled/></div>
    </div>
    <div class="budget-row" style="margin-top:8px">
      <span class="pill"><strong>Approved</strong> <span class="tnum" id="pillApproved">0</span></span>
      <span class="pill"><strong>Spent</strong> <span class="tnum" id="pillSpent">0</span></span>
      <span class="pill"><strong>ETC</strong> <span class="tnum" id="pillETC">0</span></span>
      <span class="pill"><strong>EAC</strong> <span class="tnum" id="pillEAC">0</span></span>
      <span class="pill"><strong>Variance</strong> <span class="tnum" id="pillVariance">0</span></span>
    </div>
  </div>

  <!-- Narrative -->
  <div class="card">
    <h2>Narrative</h2>
    <div class="grid cols-2">
      <div class="field"><label>Key achievements</label><textarea id="achievements"></textarea></div>
      <div class="field"><label>Next period activities</label><textarea id="nextActivities"></textarea></div>
    </div>
  </div>

  <!-- Status Summary -->
  <div class="card">
    <h2>Status Summary</h2>
    <div class="grid cols-2-slim">
      <table>
        <thead><tr><th>Area</th><th>Current</th><th>Previous</th><th>Notes</th></tr></thead>
        <tbody id="statusBody"></tbody>
      </table>
      <div>
        <div class="guidance">Use <em>Copy Current → Previous</em> to roll last week’s status forward.</div>
        <button class="btn" id="copyCurrentToPrev">Copy Current → Previous</button>
      </div>
    </div>
  </div>

  <!-- Milestones -->
  <div class="card">
    <h2>Milestones</h2>
    <table id="milestonesTable">
      <thead><tr><th>Milestone</th><th>Date</th><th>Status</th><th>Include</th><th></th></tr></thead>
      <tbody></tbody>
    </table>
    <div class="toolbar" style="margin-top:8px"><button class="btn" id="addMilestone">Add Milestone</button></div>
  </div>

  <!-- Issues & Risks side-by-side in builder (not print) -->
  <div class="grid cols-2 no-print">
    <div class="card">
      <h2>Issues</h2>
      <table id="issuesTable">
        <thead><tr><th>ID</th><th>Description</th><th>Impact</th><th>Owner</th><th>Status</th><th>Next Steps</th><th>Include</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="toolbar" style="margin-top:8px"><button class="btn" id="addIssue">Add Issue</button></div>
    </div>
    <div class="card">
      <h2>Risks</h2>
      <table id="risksTable">
        <thead><tr><th>ID</th><th>Description</th><th>Rating</th><th>Mitigation</th><th>Include</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="toolbar" style="margin-top:8px"><button class="btn" id="addRisk">Add Risk</button></div>
    </div>
  </div>

  <!-- Decisions -->
  <div class="card">
    <h2>Decisions</h2>
    <table id="decisionsTable">
      <thead><tr><th>Decision</th><th>Required By</th><th>Owner</th><th>Status</th><th>Include</th><th></th></tr></thead>
    <tbody></tbody></table>
    <div class="toolbar" style="margin-top:8px"><button class="btn" id="addDecision">Add Decision</button></div>
  </div>

  <!-- Dependencies & Constraints -->
  <div class="card">
    <h2>Dependencies & Constraints</h2>
    <table id="depsTable">
      <thead><tr><th>Ref/ID</th><th>Dependency</th><th>Impact</th><th>Owner</th><th>Actions</th><th>Status</th><th>Include</th><th></th></tr></thead>
      <tbody></tbody>
    </table>
    <div class="toolbar" style="margin-top:8px"><button class="btn" id="addDep">Add Dependency</button></div>
  </div>

  <!-- Toolbar 2 (controls) -->
  <div class="toolbar no-print" style="margin-top:8px">
        <button class="btn" id="themeToggle" title="Toggle light/dark theme">🌗 Theme</button>
    <div class="spacer"></div>
    <button class="btn ghost" id="jumpReportBtn">Jump to Report</button>
    <button class="btn" id="printBtn">Print Report</button>
    <span class="chip">Project Status Report — print shows only the report</span>
  </div>
</div>

<!-- PRINT / REPORT ONLY -->
<div class="only-print">
  <div class="container">
    <div id="reportCard" class="card report-section">
      <h1>Project Status Report – Project <span id="rProjectName"></span></h1>
      <div><span id="rProjectId"></span> • <span id="rSponsor"></span> • <span id="rPM"></span></div>
      <div style="margin-top:4px"><span id="rReportDate"></span> • <span id="rReportPeriod"></span> • <span id="rPhase"></span></div>

      <div style="margin-top:10px" class="budget-row">
        <span class="pill"><strong>Approved</strong> <span class="tnum" id="rApproved"></span></span>
        <span class="pill"><strong>Spent</strong> <span class="tnum" id="rSpent"></span></span>
        <span class="pill"><strong>ETC</strong> <span class="tnum" id="rETC"></span></span>
        <span class="pill"><strong>EAC</strong> <span class="tnum" id="rEAC"></span></span>
        <span class="pill"><strong>Variance</strong> <span class="tnum" id="rVariance"></span></span>
      </div>

      <h2 style="margin-top:12px">Overall Project Status</h2>
      <div class="status-chip" id="rOverallChip"><span id="rOverallIcon">⬤</span><span id="rOverallText">Green</span></div>

      <div class="grid cols-2" style="margin-top:12px">
        <div>
          <h3>Status (detail)</h3>
          <table>
            <thead><tr><th>Area</th><th>Current</th><th>Previous</th><th>Notes</th></tr></thead>
            <tbody id="rStatusBody"></tbody>
          </table>
        </div>
        <div>
          <h3>Milestones</h3>
          <table>
            <thead><tr><th>Milestone</th><th>Date</th><th>Status</th></tr></thead>
            <tbody id="rMilestones"></tbody>
          </table>
        </div>
      </div>

      <div class="grid issues-risks cols-2" style="margin-top:12px">
        <div>
          <h3>Issues</h3>
          <table>
            <thead><tr><th>ID</th><th>Description</th><th>Impact</th><th>Owner</th><th>Status</th><th>Next Steps</th></tr></thead>
            <tbody id="rIssues"></tbody>
          </table>
        </div>
        <div>
          <h3>Risks</h3>
          <table>
            <thead><tr><th>ID</th><th>Description</th><th>Rating</th><th>Mitigation</th></tr></thead>
            <tbody id="rRisks"></tbody>
          </table>
        </div>
      </div>

      <div style="margin-top:12px">
        <h3>Decisions</h3>
        <table>
          <thead><tr><th>Decision</th><th>Required By</th><th>Owner</th><th>Status</th></tr></thead>
          <tbody id="rDecisions"></tbody>
        </table>
      </div>

      <div style="margin-top:12px">
        <h3>Dependencies & Constraints</h3>
        <table>
          <thead><tr><th>Ref/ID</th><th>Dependency</th><th>Impact</th><th>Owner</th><th>Actions</th><th>Status</th></tr></thead>
          <tbody id="rDeps"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
const $=sel=>document.querySelector(sel);
const $$=sel=>Array.from(document.querySelectorAll(sel));

const statusAreas=["Overall","Scope","Schedule","Budget","Quality","Risk","Stakeholder"];
const rag=["Green","Amber","Red","Blue"];

const statusSelect=(id)=>`<select data-id="${id}" class="rag">${rag.map(r=>`<option value="${r}">${r}</option>`).join('')}</select>`;

function addRow(tbody, cells){
  const tr=document.createElement('tr');
  cells.forEach(html=>{const td=document.createElement('td');td.innerHTML=html;tr.appendChild(td)});
  tbody.appendChild(tr);
}

function initStatus(){
  const body=$('#statusBody');
  body.innerHTML='';
  statusAreas.forEach(a=>{
    addRow(body,[`<strong>${a}</strong>`,statusSelect(`${a}-current`),statusSelect(`${a}-prev`),`<input type="text" placeholder="Notes"/>`])
  })
}

function addMilestoneRow(){
  addRow($('#milestonesTable tbody'),[
    `<input type="text" placeholder="Milestone"/>`,
    `<input type="date"/>`,
    `<select><option>Not Started</option><option>On Track</option><option>At Risk</option><option>Complete</option></select>`,
    `<input type="checkbox" checked/>`,
    `<button class="btn ghost del">Remove</button>`
  ])
}
function addIssueRow(){
  addRow($('#issuesTable tbody'),[
    `<input type="text" placeholder="ID" style="max-width:80px"/>`,
    `<input type="text" placeholder="Description"/>`,
    `<select><option>Schedule</option><option>Budget</option><option>Scope</option><option>Quality</option></select>`,
    `<input type="text" placeholder="Owner"/>`,
    `<select><option>Open</option><option>In Progress</option><option>Closed</option></select>`,
    `<input type="text" placeholder="Next steps"/>`,
    `<input type="checkbox" checked/>`,
    `<button class="btn ghost del">Remove</button>`
  ])
}
function addRiskRow(){
  addRow($('#risksTable tbody'),[
    `<input type="text" placeholder="ID" style="max-width:80px"/>`,
    `<input type="text" placeholder="Description"/>`,
    `<select><option>1 (VL)</option><option>2 (L)</option><option>3 (M)</option><option>4 (H)</option><option>5 (C)</option></select>`,
    `<input type="text" placeholder="Mitigation"/>`,
    `<input type="checkbox" checked/>`,
    `<button class="btn ghost del">Remove</button>`
  ])
}
function addDecisionRow(){
  addRow($('#decisionsTable tbody'),[
    `<input type="text" placeholder="Decision"/>`,
    `<input type="date"/>`,
    `<input type="text" placeholder="Owner"/>`,
    `<select><option>Open</option><option>In Progress</option><option>Closed</option></select>`,
    `<input type="checkbox" checked/>`,
    `<button class="btn ghost del">Remove</button>`
  ])
}
function addDepRow(){
  addRow($('#depsTable tbody'),[
    `<input type="text" placeholder="Ref/ID" style="max-width:100px"/>`,
    `<input type="text" placeholder="Dependency"/>`,
    `<input type="text" placeholder="Impact"/>`,
    `<input type="text" placeholder="Owner"/>`,
    `<input type="text" placeholder="Actions"/>`,
    `<select><option>Open</option><option>In Progress</option><option>Closed</option></select>`,
    `<input type="checkbox" checked/>`,
    `<button class="btn ghost del">Remove</button>`
  ])
}

function tnum(n){return Number(n||0).toLocaleString()}
function updateBudgetPills(){
  const a=+$('#budgetApproved').value||0;
  const s=+$('#budgetSpent').value||0;
  const e=+$('#budgetETC').value||0;
  const eac=s+e;
  const varc=a-(s+e);
  $('#budgetVariance').value=tnum(varc);
  $('#pillApproved').textContent=tnum(a);
  $('#pillSpent').textContent=tnum(s);
  $('#pillETC').textContent=tnum(e);
  $('#pillEAC').textContent=tnum(eac);
  $('#pillVariance').textContent=tnum(varc);
}

function refreshPreview(){
  $('#rProjectName').textContent=$('#projectName').value||'[Project Name]';
  $('#rProjectId').textContent=$('#projectId').value||'ID —';
  $('#rSponsor').textContent=$('#sponsor').value||'Sponsor —';
  $('#rPM').textContent=$('#pm').value||'PM —';
  $('#rPhase').textContent=$('#phase').value||'Phase —';
  $('#rReportDate').textContent=$('#reportDate').value||'Report Date —';
  $('#rReportPeriod').textContent=$('#reportPeriod').value||'Reporting Period —';

  const rBody=$('#rStatusBody');
  rBody.innerHTML='';
  $$('#statusBody tr').forEach(tr=>{
    const area=tr.children[0].innerText;
    const cur=tr.children[1].querySelector('select').value;
    const prev=tr.children[2].querySelector('select').value;
    const notes=tr.children[3].querySelector('input').value;
    addRow(rBody,[`<strong>${area}</strong>`,cur,prev,notes]);
  });

  const rM=$('#rMilestones'); rM.innerHTML='';
  $$('#milestonesTable tbody tr').forEach(tr=>{
    const inc=tr.children[3].querySelector('input[type="checkbox"]').checked;
    if(!inc) return;
    const name=tr.children[0].querySelector('input').value;
    const date=tr.children[1].querySelector('input').value;
    const status=tr.children[2].querySelector('select').value;
    addRow(rM,[name,date,status]);
  });

  const rI=$('#rIssues'); rI.innerHTML='';
  $$('#issuesTable tbody tr').forEach(tr=>{
    const inc=tr.children[6].querySelector('input[type="checkbox"]').checked;
    if(!inc) return;
    const id=tr.children[0].querySelector('input').value;
    const desc=tr.children[1].querySelector('input').value;
    const impact=tr.children[2].querySelector('select').value;
    const owner=tr.children[3].querySelector('input').value;
    const status=tr.children[4].querySelector('select').value;
    const next=tr.children[5].querySelector('input').value;
    addRow(rI,[id,desc,impact,owner,status,next]);
  });

  const rR=$('#rRisks'); rR.innerHTML='';
  $$('#risksTable tbody tr').forEach(tr=>{
    const inc=tr.children[4].querySelector('input[type="checkbox"]').checked;
    if(!inc) return;
    const id=tr.children[0].querySelector('input').value;
    const desc=tr.children[1].querySelector('input').value;
    const rating=tr.children[2].querySelector('select').value;
    const mit=tr.children[3].querySelector('input').value;
    addRow(rR,[id,desc,rating,mit]);
  });

  const rD=$('#rDecisions'); rD.innerHTML='';
  $$('#decisionsTable tbody tr').forEach(tr=>{
    const inc=tr.children[4].querySelector('input[type="checkbox"]').checked;
    if(!inc) return;
    const dec=tr.children[0].querySelector('input').value;
    const req=tr.children[1].querySelector('input').value;
    const owner=tr.children[2].querySelector('input').value;
    const status=tr.children[3].querySelector('select').value;
    addRow(rD,[dec,req,owner,status]);
  });

  const rDep=$('#rDeps'); rDep.innerHTML='';
  $$('#depsTable tbody tr').forEach(tr=>{
    const inc=tr.children[6].querySelector('input[type="checkbox"]').checked;
    if(!inc) return;
    const ref=tr.children[0].querySelector('input').value;
    const dep=tr.children[1].querySelector('input').value;
    const impact=tr.children[2].querySelector('input').value;
    const owner=tr.children[3].querySelector('input').value;
    const actions=tr.children[4].querySelector('input').value;
    const status=tr.children[5].querySelector('select').value;
    addRow(rDep,[ref,dep,impact,owner,actions,status]);
  });

  // Overall chip (from Current Overall)
  const currentOverall = $$('#statusBody tr')[0].children[1].querySelector('select').value;
  const icon = {Green:'🟢',Amber:'🟠',Red:'🔴',Blue:'🔵'}[currentOverall]||'⬤';
  $('#rOverallIcon').textContent=icon;
  $('#rOverallText').textContent=currentOverall;
}

function saveJSON(){
  const data={
    projectName:$('#projectName').value,projectId:$('#projectId').value,sponsor:$('#sponsor').value,pm:$('#pm').value,phase:$('#phase').value,reportDate:$('#reportDate').value,reportPeriod:$('#reportPeriod').value,
    budget:{approved:+$('#budgetApproved').value||0,spent:+$('#budgetSpent').value||0,etc:+$('#budgetETC').value||0},
    status:$$('#statusBody tr').map(tr=>({area:tr.children[0].innerText,current:tr.children[1].querySelector('select').value,previous:tr.children[2].querySelector('select').value,notes:tr.children[3].querySelector('input').value})),
    milestones:$$('#milestonesTable tbody tr').map(tr=>({name:tr.children[0].querySelector('input').value,date:tr.children[1].querySelector('input').value,status:tr.children[2].querySelector('select').value,include:tr.children[3].querySelector('input[type="checkbox"]').checked})),
    issues:$$('#issuesTable tbody tr').map(tr=>({id:tr.children[0].querySelector('input').value,desc:tr.children[1].querySelector('input').value,impact:tr.children[2].querySelector('select').value,owner:tr.children[3].querySelector('input').value,status:tr.children[4].querySelector('select').value,next:tr.children[5].querySelector('input').value,include:tr.children[6].querySelector('input[type="checkbox"]').checked})),
    risks:$$('#risksTable tbody tr').map(tr=>({id:tr.children[0].querySelector('input').value,desc:tr.children[1].querySelector('input').value,rating:tr.children[2].querySelector('select').value,mit:tr.children[3].querySelector('input').value,include:tr.children[4].querySelector('input[type="checkbox"]').checked})),
    decisions:$$('#decisionsTable tbody tr').map(tr=>({decision:tr.children[0].querySelector('input').value,required:tr.children[1].querySelector('input').value,owner:tr.children[2].querySelector('input').value,status:tr.children[3].querySelector('select').value,include:tr.children[4].querySelector('input[type="checkbox"]').checked})),
    deps:$$('#depsTable tbody tr').map(tr=>({ref:tr.children[0].querySelector('input').value,dep:tr.children[1].querySelector('input').value,impact:tr.children[2].querySelector('input').value,owner:tr.children[3].querySelector('input').value,actions:tr.children[4].querySelector('input').value,status:tr.children[5].querySelector('select').value,include:tr.children[6].querySelector('input[type="checkbox"]').checked}))
  };
  const name=$('#projectName').value?.trim()||prompt('Filename (uses Project Name if set):','psr_data');
  if(!name) return;
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=`${name}.json`;
  a.click();
}

function exportCSV(){
  const esc=s=>`"${String(s||'').replace(/"/g,'""')}"`;
  const lines=[];
  lines.push(['Project Name','Project ID','Sponsor','PM','Phase','Report Date','Reporting Period','Approved','Spent','ETC','EAC','Variance'].map(esc).join(','));
  const approved=+$('#budgetApproved').value||0, spent=+$('#budgetSpent').value||0, etc=+$('#budgetETC').value||0, eac=spent+etc, variance=approved-eac;
  lines.push([$('#projectName').value,$('#projectId').value,$('#sponsor').value,$('#pm').value,$('#phase').value,$('#reportDate').value,$('#reportPeriod').value,approved,spent,etc,eac,variance].map(esc).join(','));

  lines.push('\nStatus');
  lines.push(['Area','Current','Previous','Notes'].map(esc).join(','));
  $$('#statusBody tr').forEach(tr=>{
    lines.push([tr.children[0].innerText,tr.children[1].querySelector('select').value,tr.children[2].querySelector('select').value,tr.children[3].querySelector('input').value].map(esc).join(','))
  });

  lines.push('\nMilestones');
  lines.push(['Milestone','Date','Status','Include'].map(esc).join(','));
  $$('#milestonesTable tbody tr').forEach(tr=>{
    lines.push([
      tr.children[0].querySelector('input').value,
      tr.children[1].querySelector('input').value,
      tr.children[2].querySelector('select').value,
      tr.children[3].querySelector('input[type="checkbox"]').checked
    ].map(esc).join(','))
  })

  lines.push('\nIssues');
  lines.push(['ID','Description','Impact','Owner','Status','Next Steps','Include'].map(esc).join(','));
  $$('#issuesTable tbody tr').forEach(tr=>{
    lines.push([
      tr.children[0].querySelector('input').value,
      tr.children[1].querySelector('input').value,
      tr.children[2].querySelector('select').value,
      tr.children[3].querySelector('input').value,
      tr.children[4].querySelector('select').value,
      tr.children[5].querySelector('input').value,
      tr.children[6].querySelector('input[type="checkbox"]').checked
    ].map(esc).join(','))
  })

  lines.push('\nRisks');
  lines.push(['ID','Description','Rating','Mitigation','Include'].map(esc).join(','));
  $$('#risksTable tbody tr').forEach(tr=>{
    lines.push([
      tr.children[0].querySelector('input').value,
      tr.children[1].querySelector('input').value,
      tr.children[2].querySelector('select').value,
      tr.children[3].querySelector('input').value,
      tr.children[4].querySelector('input[type="checkbox"]').checked
    ].map(esc).join(','))
  })

  lines.push('\nDecisions');
  lines.push(['Decision','Required By','Owner','Status','Include'].map(esc).join(','));
  $$('#decisionsTable tbody tr').forEach(tr=>{
    lines.push([
      tr.children[0].querySelector('input').value,
      tr.children[1].querySelector('input').value,
      tr.children[2].querySelector('input').value,
      tr.children[3].querySelector('select').value,
      tr.children[4].querySelector('input[type="checkbox"]').checked
    ].map(esc).join(','))
  })

  lines.push('\nDependencies & Constraints');
  lines.push(['Ref/ID','Dependency','Impact','Owner','Actions','Status','Include'].map(esc).join(','));
  $$('#depsTable tbody tr').forEach(tr=>{
    lines.push([
      tr.children[0].querySelector('input').value,
      tr.children[1].querySelector('input').value,
      tr.children[2].querySelector('input').value,
      tr.children[3].querySelector('input').value,
      tr.children[4].querySelector('input').value,
      tr.children[5].querySelector('select').value,
      tr.children[6].querySelector('input[type="checkbox"]').checked
    ].map(esc).join(','))
  })

  const blob=new Blob([lines.join('\n')],{type:'text/csv'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=($('#projectName').value||'psr_summary')+`.csv`;
  a.click();
}

function attachDelHandlers(){
  $$('.del').forEach(btn=>btn.onclick=()=>btn.closest('tr').remove());
}

function wireTables(){
  $('#addMilestone').onclick=()=>{addMilestoneRow();attachDelHandlers()}
  $('#addIssue').onclick=()=>{addIssueRow();attachDelHandlers()}
  $('#addRisk').onclick=()=>{addRiskRow();attachDelHandlers()}
  $('#addDecision').onclick=()=>{addDecisionRow();attachDelHandlers()}
  $('#addDep').onclick=()=>{addDepRow();attachDelHandlers()}
}

function loadJSON(file){
  const r=new FileReader();
  r.onload=()=>{
    const d=JSON.parse(r.result);
    $('#projectName').value=d.projectName||'';$('#projectId').value=d.projectId||'';$('#sponsor').value=d.sponsor||'';$('#pm').value=d.pm||'';$('#phase').value=d.phase||'';$('#reportDate').value=d.reportDate||'';$('#reportPeriod').value=d.reportPeriod||'';

    $('#budgetApproved').value=d.budget?.approved||0;$('#budgetSpent').value=d.budget?.spent||0;$('#budgetETC').value=d.budget?.etc||0;updateBudgetPills();

    initStatus();
    if(Array.isArray(d.status)){
      d.status.forEach((s,i)=>{
        const tr=$$('#statusBody tr')[i];
        if(!tr) return;
        tr.children[1].querySelector('select').value=s.current||'Green';
        tr.children[2].querySelector('select').value=s.previous||'Green';
        tr.children[3].querySelector('input').value=s.notes||'';
      })
    }

    $('#milestonesTable tbody').innerHTML='';
    (d.milestones||[]).forEach(m=>{addMilestoneRow();const tr=$$('#milestonesTable tbody tr').pop();
      tr.children[0].querySelector('input').value=m.name||'';
      tr.children[1].querySelector('input').value=m.date||'';
      tr.children[2].querySelector('select').value=m.status||'Not Started';
      tr.children[3].querySelector('input[type="checkbox"]').checked=!!m.include;
    });

    $('#issuesTable tbody').innerHTML='';
    (d.issues||[]).forEach(it=>{addIssueRow();const tr=$$('#issuesTable tbody tr').pop();
      tr.children[0].querySelector('input').value=it.id||'';
      tr.children[1].querySelector('input').value=it.desc||'';
      tr.children[2].querySelector('select').value=it.impact||'Schedule';
      tr.children[3].querySelector('input').value=it.owner||'';
      tr.children[4].querySelector('select').value=it.status||'Open';
      tr.children[5].querySelector('input').value=it.next||'';
      tr.children[6].querySelector('input[type="checkbox"]').checked=!!it.include;
    });

    $('#risksTable tbody').innerHTML='';
    (d.risks||[]).forEach(r=>{addRiskRow();const tr=$$('#risksTable tbody tr').pop();
      tr.children[0].querySelector('input').value=r.id||'';
      tr.children[1].querySelector('input').value=r.desc||'';
      tr.children[2].querySelector('select').value=r.rating||'3 (M)';
      tr.children[3].querySelector('input').value=r.mit||'';
      tr.children[4].querySelector('input[type="checkbox"]').checked=!!r.include;
    });

    $('#decisionsTable tbody').innerHTML='';
    (d.decisions||[]).forEach(dd=>{addDecisionRow();const tr=$$('#decisionsTable tbody tr').pop();
      tr.children[0].querySelector('input').value=dd.decision||'';
      tr.children[1].querySelector('input').value=dd.required||'';
      tr.children[2].querySelector('input').value=dd.owner||'';
      tr.children[3].querySelector('select').value=dd.status||'Open';
      tr.children[4].querySelector('input[type="checkbox"]').checked=!!dd.include;
    });

    $('#depsTable tbody').innerHTML='';
    (d.deps||[]).forEach(dp=>{addDepRow();const tr=$$('#depsTable tbody tr').pop();
      tr.children[0].querySelector('input').value=dp.ref||'';
      tr.children[1].querySelector('input').value=dp.dep||'';
      tr.children[2].querySelector('input').value=dp.impact||'';
      tr.children[3].querySelector('input').value=dp.owner||'';
      tr.children[4].querySelector('input').value=dp.actions||'';
      tr.children[5].querySelector('select').value=dp.status||'Open';
      tr.children[6].querySelector('input[type="checkbox"]').checked=!!dp.include;
    });

    refreshPreview();
  };
  r.readAsText(file);
}

function copyCurrentToPrevious(){
  $$('#statusBody tr').forEach(tr=>{
    tr.children[2].querySelector('select').value=tr.children[1].querySelector('select').value;
  });
  refreshPreview();
}

function init(){
  initStatus();
  wireTables();
  $('#budgetApproved').addEventListener('input',updateBudgetPills);
  $('#budgetSpent').addEventListener('input',updateBudgetPills);
  $('#budgetETC').addEventListener('input',updateBudgetPills);
  $$('#statusBody, #milestonesTable, #issuesTable, #risksTable, #decisionsTable, #depsTable').forEach(el=>{
    el.addEventListener('input',refreshPreview);
    el.addEventListener('change',refreshPreview);
  });
  $('#saveJsonBtn').onclick=saveJSON;
  $('#exportCsvBtn').onclick=exportCSV;
  $('#importJson').addEventListener('change',e=>{const f=e.target.files[0]; if(f) loadJSON(f)});
  $('#printBtn').onclick=()=>{ window.print() };
  $('#newBtn').onclick=()=>{ if(confirm('Clear current data and start a new report?')) location.reload(); };
  $('#copyCurrentToPrev').onclick=copyCurrentToPrevious;
  $('#jumpReportBtn').onclick=()=>{ document.getElementById('reportCard')?.scrollIntoView({behavior:'smooth', block:'start'}); };

  /* Initial calc + preview */
  updateBudgetPills(); refreshPreview();

  /* ===== Theme Toggle (persist to localStorage) ===== */
  const THEME_KEY = 'psrTheme';
  function applyTheme(theme){ document.body.classList.toggle('dark', theme === 'dark'); }
  function currentTheme(){ return document.body.classList.contains('dark') ? 'dark' : 'light'; }
  (function initTheme(){
    const saved = localStorage.getItem(THEME_KEY);
    if(saved === 'dark'){ applyTheme('dark'); }
    const toggleBtn = document.getElementById('themeToggle');
    if(toggleBtn){
      toggleBtn.addEventListener('click', ()=>{
        const next = currentTheme() === 'dark' ? 'light' : 'dark';
        applyTheme(next);
        try{ localStorage.setItem(THEME_KEY, next); }catch(e){}
      });
    }
  })();
}

document.addEventListener('DOMContentLoaded',init);
</script>
</body>
</html>
