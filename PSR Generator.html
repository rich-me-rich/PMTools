<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Project Status Report (PSR) Builder â€” Summary (v0.25)</title>
<style>
/* ===== Base styles (from v0.24, unchanged) ===== */
:root{
  --bg:#f8fafc; --card:#fff; --border:#e5e7eb; --text:#0f172a; --text-dim:#475569;
  --chip:#f1f5f9; --shadow:0 6px 24px rgba(15,23,42,.06),0 2px 8px rgba(15,23,42,.04);
  --btn:#2563eb; --btn-text:#fff; --btn-hover:#1e40af; --btn-alt:#059669; --btn-alt-hover:#047857
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;line-height:1.45}
.container{max-width:1200px;margin:0 auto;padding:24px}
.grid{display:grid;gap:16px}
.cols-2{grid-template-columns:1fr 1fr}
.cols-3{grid-template-columns:repeat(3,1fr)}
.cols-4{grid-template-columns:repeat(4,1fr)}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:16px;margin-bottom:12px}
.toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.toolbar .spacer{flex:1}
.field{display:flex;flex-direction:column;gap:6px}
label{font-size:.85rem;color:var(--text-dim)}
input[type=text],input[type=date],input[type=number],select,textarea{
  width:100%;border:1px solid var(--border);background:#fff;color:var(--text);
  border-radius:12px;padding:10px 12px
}
input[type=number]{text-align:right;font-variant-numeric:tabular-nums}
textarea{min-height:80px}
.tnum{font-variant-numeric:tabular-nums}
table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--border);border-radius:14px;overflow:hidden}
th,td{border-bottom:1px solid var(--border);padding:10px;background:#fff}
th{background:#f8fafc;font-weight:700;text-align:left}
tr:last-child td{border-bottom:none}
.btn{appearance:none;border:1px solid var(--border);background:var(--btn);color:var(--btn-text);padding:9px 12px;border-radius:12px;font-weight:600;cursor:pointer}
.btn:hover{background:var(--btn-hover)}
.btn.alt{background:var(--btn-alt)}
.btn.alt:hover{background:var(--btn-alt-hover)}
.btn.ghost{background:transparent;color:var(--text);border-color:var(--border)}
.pill{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--border);border-radius:999px;padding:6px 10px;background:var(--chip)}
.status-chip{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--border);border-radius:999px;padding:8px 12px}
.budget-row{display:flex;flex-wrap:wrap;gap:10px}
.guidance{background:#f1f5f9;padding:10px;border-left:3px solid #cbd5e1;border-radius:10px;color:#334155}
.report{background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.08);padding:20px}
.report-section{border:1px solid #e5e7eb;border-radius:12px;padding:14px;margin:12px 0}
.status-milestones,.issues-risks{display:grid;grid-template-columns:1fr 1fr;gap:12px}

/* ===== v0.25 additions only (scoped, minimal) ===== */
/* Dark theme */
body.dark{ background:#0b1220; color:#e5e7eb; transition:background .25s,color .25s }
body.dark .card, body.dark .report, body.dark th, body.dark td{ background:#0f172a }
body.dark .card, body.dark table, body.dark th, body.dark td, body.dark .report, body.dark .report-section{ border-color:#1e293b !important }
body.dark input[type="text"], body.dark input[type="date"], body.dark input[type="number"], body.dark select, body.dark textarea{
  background:#0b1220; color:#e5e7eb; border-color:#243244
}
body.dark .guidance{ background:#0f172a; color:#94a3b8; border-left-color:#334155 }
body.dark .btn{ border-color:#334155 }

/* Print: Budget Variance pill never wraps; hide builder cards */
@media print{
  .no-print{display:none !important}
  .budget-row{flex-wrap:nowrap; gap:8px}
  .budget-row .pill, .budget-row .status-chip{white-space:nowrap}
  .budget-row strong{margin-right:4px}
}

/* Print: Risks truncation fix (avoid inside breaks; stack columns) */
.report-section table, .report-section tr, .report-section td, .report-section th{ break-inside: avoid; page-break-inside: avoid }
@media print{ .issues-risks{ grid-template-columns:1fr !important } }
</style>
</head>
<body>
<div class="container">
  <div class="toolbar no-print" style="margin-top:8px">
    <button class="btn" id="themeToggle" title="Toggle light/dark theme">ðŸŒ— Theme</button>
    <button class="btn" id="newBtn">New</button>
    <label class="btn" for="importFile">Import save data (JSON)
      <input id="importFile" type="file" accept="application/json" style="display:none"/>
    </label>
    <button class="btn" id="saveBtn">Save JSON</button>
    <button class="btn alt" id="exportBtn">Export CSV (Summary)</button>
    <div class="spacer"></div>
    <button class="btn ghost" id="jumpReportBtn">Jump to Report</button>
    <button class="btn" id="printBtn">Print Report</button>
    <span class="pill">v0.25</span>
  </div>

  <!-- Base Project Information -->
  <div class="card no-print">
    <h2>Base Project Information</h2>
    <div class="grid cols-4">
      <div class="field"><label>Project Name</label><input id="projectName" type="text" placeholder="e.g., Core Banking Upgrade"/></div>
      <div class="field"><label>Project ID</label><input id="projectId" type="text" placeholder="e.g., PRJ-042"/></div>
      <div class="field"><label>Sponsor</label><input id="sponsor" type="text"/></div>
      <div class="field"><label>Project Manager</label><input id="pm" type="text"/></div>
      <div class="field"><label>Project Phase</label><input id="phase" type="text" placeholder="e.g., Execution"/></div>
      <div class="field"><label>Report Date</label><input id="reportDate" type="date"/></div>
      <div class="field"><label>Reporting Period</label><input id="reportPeriod" type="text" placeholder="e.g., 4â€“10 Aug 2025"/></div>
    </div>
  </div>

  <!-- Budget -->
  <div class="card no-print">
    <h2>Budget (000â€™s)</h2>
    <div class="grid cols-4">
      <div class="field"><label>Approved</label><input type="number" id="budgetApproved" value="0"/></div>
      <div class="field"><label>Spent</label><input type="number" id="budgetSpent" value="0"/></div>
      <div class="field"><label>ETC</label><input type="number" id="budgetETC" value="0"/></div>
      <div class="field"><label>Variance (auto)</label><input type="text" id="budgetVariance" disabled/></div>
    </div>
    <div class="budget-row" style="margin-top:8px">
      <span class="pill"><strong>Approved</strong> <span class="tnum" id="pillApproved">0</span></span>
      <span class="pill"><strong>Spent</strong> <span class="tnum" id="pillSpent">0</span></span>
      <span class="pill"><strong>ETC</strong> <span class="tnum" id="pillETC">0</span></span>
      <span class="pill"><strong>EAC</strong> <span class="tnum" id="pillEAC">0</span></span>
      <span class="pill"><strong>Variance</strong> <span class="tnum" id="pillVariance">0</span></span>
    </div>
  </div>

  <!-- Narrative -->
  <div class="card no-print">
    <h2>Narrative</h2>
    <div class="grid cols-2">
      <div class="field"><label>Key achievements</label><textarea id="achievements"></textarea></div>
      <div class="field"><label>Next period activities</label><textarea id="nextActivities"></textarea></div>
    </div>
  </div>

  <!-- Status Summary -->
  <div class="card no-print">
    <h2>Status Summary</h2>
    <div class="grid cols-2">
      <table>
        <thead><tr><th>Area</th><th>Current</th><th>Previous</th><th>Notes</th></tr></thead>
        <tbody id="statusBody"></tbody>
      </table>
      <div>
        <div class="guidance">Use <em>Copy Current â†’ Previous</em> to roll last weekâ€™s status forward.</div>
        <button class="btn" id="copyCurrentToPrev">Copy Current â†’ Previous</button>
      </div>
    </div>
  </div>

  <!-- Milestones -->
  <div class="card no-print">
    <h2>Milestones</h2>
    <table id="milestonesTable">
      <thead><tr><th>Milestone</th><th>Date</th><th>Status</th><th>Include</th><th></th></tr></thead>
      <tbody></tbody>
    </table>
    <div class="toolbar" style="margin-top:8px"><button class="btn" id="addMilestone">Add Milestone</button></div>
  </div>

  <!-- Issues & Risks -->
  <div class="grid cols-2 no-print">
    <div class="card">
      <h2>Issues</h2>
      <table id="issuesTable">
        <thead><tr><th>ID</th><th>Description</th><th>Impact</th><th>Owner</th><th>Status</th><th>Next Steps</th><th>Include</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="toolbar" style="margin-top:8px"><button class="btn" id="addIssue">Add Issue</button></div>
    </div>
    <div class="card">
      <h2>Risks</h2>
      <table id="risksTable">
        <thead><tr><th>ID</th><th>Description</th><th>Rating</th><th>Mitigation</th><th>Include</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="toolbar" style="margin-top:8px"><button class="btn" id="addRisk">Add Risk</button></div>
    </div>
  </div>

  <!-- Decisions -->
  <div class="card no-print">
    <h2>Decisions</h2>
    <table id="decisionsTable">
      <thead><tr><th>Decision</th><th>Required By</th><th>Owner</th><th>Status</th><th>Include</th><th></th></tr></thead>
      <tbody></tbody>
    </table>
    <div class="toolbar" style="margin-top:8px"><button class="btn" id="addDecision">Add Decision</button></div>
  </div>

  <!-- Dependencies -->
  <div class="card no-print">
    <h2>Dependencies & Constraints</h2>
    <table id="depsTable">
      <thead><tr><th>Ref/ID</th><th>Dependency</th><th>Impact</th><th>Owner</th><th>Actions</th><th>Status</th><th>Include</th><th></th></tr></thead>
      <tbody></tbody>
    </table>
    <div class="toolbar" style="margin-top:8px"><button class="btn" id="addDep">Add Dependency</button></div>
  </div>

  <!-- REPORT / PRINT VIEW (builder cards are .no-print; this remains visible on print) -->
  <div id="reportCard" class="report">
    <h1>Project Status Report â€“ Project <span id="rProjectName"></span></h1>
    <div><span id="rProjectId"></span> â€¢ <span id="rSponsor"></span> â€¢ <span id="rPM"></span></div>
    <div style="margin-top:4px"><span id="rReportDate"></span> â€¢ <span id="rReportPeriod"></span> â€¢ <span id="rPhase"></span></div>

    <div style="margin-top:10px" class="budget-row">
      <span class="pill"><strong>Approved</strong> <span class="tnum" id="rApproved"></span></span>
      <span class="pill"><strong>Spent</strong> <span class="tnum" id="rSpent"></span></span>
      <span class="pill"><strong>ETC</strong> <span class="tnum" id="rETC"></span></span>
      <span class="pill"><strong>EAC</strong> <span class="tnum" id="rEAC"></span></span>
      <span class="pill"><strong>Variance</strong> <span class="tnum" id="rVariance"></span></span>
    </div>

    <h2 style="margin-top:12px">Overall Project Status</h2>
    <div class="status-chip" id="rOverallChip"><span id="rOverallIcon">ðŸŸ¢</span><span id="rOverallText">Green</span></div>

    <div class="status-milestones" style="margin-top:12px">
      <div>
        <h3>Status (detail)</h3>
        <div class="report-section">
          <table>
            <thead><tr><th>Area</th><th>Current</th><th>Previous</th><th>Notes</th></tr></thead>
            <tbody id="rStatusBody"></tbody>
          </table>
        </div>
      </div>
      <div>
        <h3>Milestones</h3>
        <div class="report-section">
          <table>
            <thead><tr><th>Milestone</th><th>Date</th><th>Status</th></tr></thead>
            <tbody id="rMilestones"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="issues-risks" style="margin-top:12px">
      <div>
        <h3>Issues</h3>
        <div class="report-section">
          <table>
            <thead><tr><th>ID</th><th>Description</th><th>Impact</th><th>Owner</th><th>Status</th><th>Next Steps</th></tr></thead>
            <tbody id="rIssues"></tbody>
          </table>
        </div>
      </div>
      <div>
        <h3>Risks</h3>
        <div class="report-section">
          <table>
            <thead><tr><th>ID</th><th>Description</th><th>Rating</th><th>Mitigation</th></tr></thead>
            <tbody id="rRisks"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div style="margin-top:12px">
      <h3>Decisions</h3>
      <div class="report-section">
        <table>
          <thead><tr><th>Decision</th><th>Required By</th><th>Owner</th><th>Status</th></tr></thead>
          <tbody id="rDecisions"></tbody>
        </table>
      </div>
    </div>

    <div style="margin-top:12px">
      <h3>Dependencies & Constraints</h3>
      <div class="report-section">
        <table>
          <thead><tr><th>Ref/ID</th><th>Dependency</th><th>Impact</th><th>Owner</th><th>Actions</th><th>Status</th></tr></thead>
          <tbody id="rDeps"></tbody>
        </table>
      </div>
    </div>
  </div>
  <!-- End reportCard -->
</div> <!-- /.container -->

<script>
/* ===== Utilities ===== */
const $  = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));

const statusAreas = ["Overall","Scope","Schedule","Budget","Quality","Risk","Stakeholder"];
const rag = ["Green","Amber","Red","Blue"];
const statusSelect = (id) => `<select data-id="${id}" class="rag">${rag.map(r=>`<option value="${r}">${r}</option>`).join('')}</select>`;

/* ===== Table helpers ===== */
function addRow(tbody, cells){
  const tr = document.createElement('tr');
  cells.forEach(h=>{
    const td=document.createElement('td');
    td.innerHTML=h;
    tr.appendChild(td);
  });
  tbody.appendChild(tr);
}

function initStatus(){
  const body = $('#statusBody');
  body.innerHTML = '';
  statusAreas.forEach(a=>{
    addRow(body, [
      `<strong>${a}</strong>`,
      statusSelect(`${a}-current`),
      statusSelect(`${a}-prev`),
      `<input type="text" placeholder="Notes"/>`
    ]);
  });
}

function rowControlsTD(){
  const td=document.createElement('td');
  td.innerHTML='<button class="btn ghost del">Remove</button>';
  setTimeout(()=> td.querySelector('.del').addEventListener('click',()=> td.closest('tr').remove()));
  return td;
}

/* ===== Builder tables row adders ===== */
function addMilestoneRow(v={}){
  const tr=document.createElement('tr');
  tr.innerHTML = `
    <td><input type="text" value="${v.name||''}" placeholder="Milestone"></td>
    <td><input type="date" value="${v.date||''}"></td>
    <td>
      <select>
        <option>Not Started</option><option>On Track</option>
        <option>At Risk</option><option>Complete</option>
      </select>
    </td>
    <td class="center"><input type="checkbox" ${v.include===false?'':'checked'}></td>`;
  tr.appendChild(rowControlsTD());
  $('#milestonesTable tbody').appendChild(tr);
  tr.querySelectorAll('input,select').forEach(el=>el.addEventListener('input', refreshPreview));
}

function addIssueRow(v={}){
  const tr=document.createElement('tr');
  tr.innerHTML = `
    <td><input type="text" value="${v.id||''}" placeholder="ID"></td>
    <td><input type="text" value="${v.desc||''}" placeholder="Description"></td>
    <td>
      <select>
        <option>Schedule</option><option>Budget</option>
        <option>Scope</option><option>Quality</option>
      </select>
    </td>
    <td><input type="text" value="${v.owner||''}" placeholder="Owner"></td>
    <td><select><option>Open</option><option>In Progress</option><option>Closed</option></select></td>
    <td><input type="text" value="${v.next||''}" placeholder="Next steps"></td>
    <td class="center"><input type="checkbox" ${v.include===false?'':'checked'}></td>`;
  tr.appendChild(rowControlsTD());
  $('#issuesTable tbody').appendChild(tr);
  tr.querySelectorAll('input,select').forEach(el=>el.addEventListener('input', refreshPreview));
}

function addRiskRow(v={}){
  const tr=document.createElement('tr');
  tr.innerHTML = `
    <td><input type="text" value="${v.id||''}" placeholder="ID"></td>
    <td><input type="text" value="${v.desc||''}" placeholder="Description"></td>
    <td>
      <select>
        <option>1 (VL)</option><option>2 (L)</option><option>3 (M)</option>
        <option>4 (H)</option><option>5 (C)</option>
      </select>
    </td>
    <td><input type="text" value="${v.mit||''}" placeholder="Mitigation"></td>
    <td class="center"><input type="checkbox" ${v.include===false?'':'checked'}></td>`;
  tr.appendChild(rowControlsTD());
  $('#risksTable tbody').appendChild(tr);
  tr.querySelectorAll('input,select').forEach(el=>el.addEventListener('input', refreshPreview));
}

function addDecisionRow(v={}){
  const tr=document.createElement('tr');
  tr.innerHTML = `
    <td><input type="text" value="${v.decision||''}" placeholder="Decision"></td>
    <td><input type="date" value="${v.required||''}"></td>
    <td><input type="text" value="${v.owner||''}" placeholder="Owner"></td>
    <td><select><option>Open</option><option>In Progress</option><option>Closed</option></select></td>
    <td class="center"><input type="checkbox" ${v.include===false?'':'checked'}></td>`;
  tr.appendChild(rowControlsTD());
  $('#decisionsTable tbody').appendChild(tr);
  tr.querySelectorAll('input,select').forEach(el=>el.addEventListener('input', refreshPreview));
}

/* Dependencies */
function depStatusSelect(v){
  return `<select class="dep-status">
            <option ${v==='Open'?'selected':''}>Open</option>
            <option ${v==='In Progress'?'selected':''}>In Progress</option>
            <option ${v==='Closed'?'selected':''}>Closed</option>
          </select>`;
}
function updateDepStrike(tr){
  const sel=tr.querySelector('.dep-status');
  const depTxt=tr.children[1].querySelector('input');
  if(sel.value==='Closed'){ depTxt.classList.add('strike'); }
  else { depTxt.classList.remove('strike'); }
}
function addDepRow(v={}){
  const tr=document.createElement('tr');
  tr.innerHTML = `
    <td><input type="text" value="${v.id||''}" placeholder="ID / REF"></td>
    <td><input type="text" value="${v.dep||''}" placeholder="Dependency"></td>
    <td><input type="text" value="${v.impact||''}" placeholder="Impact if delayed"></td>
    <td><input type="text" value="${v.owner||''}" placeholder="Owner"></td>
    <td><input type="text" value="${v.actions||''}" placeholder="Actions"></td>
    <td>${depStatusSelect(v.status||'')}</td>
    <td class="center"><input type="checkbox" class="dep-include" ${v.include===false?'':'checked'}></td>`;
  tr.appendChild(rowControlsTD());
  $('#depsTable tbody').appendChild(tr);
  tr.querySelectorAll('input,select').forEach(el=>el.addEventListener('input', refreshPreview));
  updateDepStrike(tr);
  tr.querySelector('.dep-status').addEventListener('change', ()=>{ updateDepStrike(tr); refreshPreview(); });
}

/* ===== Budget and preview ===== */
function tnum(n){ return Number(n||0).toLocaleString() }

function updateBudgetPills(){
  const a = +$('#budgetApproved').value||0;
  const s = +$('#budgetSpent').value||0;
  const e = +$('#budgetETC').value||0;
  const eac = s + e;
  const variance = a - eac;

  $('#budgetVariance').value = tnum(variance);
  $('#pillApproved').textContent = tnum(a);
  $('#pillSpent').textContent   = tnum(s);
  $('#pillETC').textContent     = tnum(e);
  $('#pillEAC').textContent     = tnum(eac);
  $('#pillVariance').textContent= tnum(variance);

  $('#rApproved').textContent   = tnum(a);
  $('#rSpent').textContent      = tnum(s);
  $('#rETC').textContent        = tnum(e);
  $('#rEAC').textContent        = tnum(eac);
  $('#rVariance').textContent   = tnum(variance);
}

function refreshPreview(){
  $('#rProjectName').textContent = $('#projectName').value || '[Project Name]';
  $('#rProjectId').textContent   = $('#projectId').value   || 'ID â€”';
  $('#rSponsor').textContent     = $('#sponsor').value     || 'Sponsor â€”';
  $('#rPM').textContent          = $('#pm').value          || 'PM â€”';
  $('#rPhase').textContent       = $('#phase').value       || 'Phase â€”';
  $('#rReportDate').textContent  = $('#reportDate').value  || 'Report Date â€”';
  $('#rReportPeriod').textContent= $('#reportPeriod').value|| 'Reporting Period â€”';

  /* Status detail */
  const rBody = $('#rStatusBody'); rBody.innerHTML='';
  $$('#statusBody tr').forEach(tr=>{
    const area  = tr.children[0].innerText;
    const cur   = tr.children[1].querySelector('select').value;
    const prev  = tr.children[2].querySelector('select').value;
    const notes = tr.children[3].querySelector('input').value;
    addRow(rBody, [`<strong>${area}</strong>`, cur, prev, notes]);
  });

  /* Milestones */
  const rM = $('#rMilestones'); rM.innerHTML='';
  $$('#milestonesTable tbody tr').forEach(tr=>{
    const inc   = tr.children[3].querySelector('input[type="checkbox"]').checked;
    if(!inc) return;
    const name  = tr.children[0].querySelector('input').value;
    const date  = tr.children[1].querySelector('input').value;
    const stat  = tr.children[2].querySelector('select').value;
    addRow(rM, [name, date, stat]);
  });

  /* Issues */
  const rI = $('#rIssues'); rI.innerHTML='';
  $$('#issuesTable tbody tr').forEach(tr=>{
    const inc   = tr.children[6].querySelector('input[type="checkbox"]').checked;
    if(!inc) return;
    const id    = tr.children[0].querySelector('input').value;
    const desc  = tr.children[1].querySelector('input').value;
    const impact= tr.children[2].querySelector('select').value;
    const owner = tr.children[3].querySelector('input').value;
    const status= tr.children[4].querySelector('select').value;
    const next  = tr.children[5].querySelector('input').value;
    addRow(rI, [id, desc, impact, owner, status, next]);
  });

  /* Risks */
  const rR = $('#rRisks'); rR.innerHTML='';
  $$('#risksTable tbody tr').forEach(tr=>{
    const inc   = tr.children[4].querySelector('input[type="checkbox"]').checked;
    if(!inc) return;
    const id    = tr.children[0].querySelector('input').value;
    const desc  = tr.children[1].querySelector('input').value;
    const rate  = tr.children[2].querySelector('select').value;
    const mit   = tr.children[3].querySelector('input').value;
    addRow(rR, [id, desc, rate, mit]);
  });

  /* Decisions */
  const rD = $('#rDecisions'); rD.innerHTML='';
  $$('#decisionsTable tbody tr').forEach(tr=>{
    const inc   = tr.children[4].querySelector('input[type="checkbox"]').checked;
    if(!inc) return;
    const dec   = tr.children[0].querySelector('input').value;
    const req   = tr.children[1].querySelector('input').value;
    const owner = tr.children[2].querySelector('input').value;
    const status= tr.children[3].querySelector('select').value;
    addRow(rD, [dec, req, owner, status]);
  });

  /* Dependencies */
  const rDep = $('#rDeps'); rDep.innerHTML='';
  $$('#depsTable tbody tr').forEach(tr=>{
    const inc   = tr.children[6].querySelector('input[type="checkbox"]').checked;
    if(!inc) return;
    const ref   = tr.children[0].querySelector('input').value;
    const dep   = tr.children[1].querySelector('input').value;
    const impact= tr.children[2].querySelector('input').value;
    const owner = tr.children[3].querySelector('input').value;
    const acts  = tr.children[4].querySelector('input').value;
    const stat  = tr.children[5].querySelector('select').value;
    addRow(rDep, [ref, dep, impact, owner, acts, stat]);
  });

  /* Overall status chip (from "Overall" current value) */
  const currentOverall = $$('#statusBody tr')[0]?.children[1]?.querySelector('select')?.value || 'Green';
  const icon = {Green:'ðŸŸ¢', Amber:'ðŸŸ ', Red:'ðŸ”´', Blue:'ðŸ”µ'}[currentOverall] || 'â¬¤';
  $('#rOverallIcon').textContent = icon;
  $('#rOverallText').textContent = currentOverall;
}
/* ===== Persistence, CSV export ===== */
function saveJSON(){
  const data = {
    projectName: $('#projectName').value, projectId: $('#projectId').value,
    sponsor: $('#sponsor').value, pm: $('#pm').value, phase: $('#phase').value,
    reportDate: $('#reportDate').value, reportPeriod: $('#reportPeriod').value,
    budget:{
      approved:+$('#budgetApproved').value||0,
      spent:+$('#budgetSpent').value||0,
      etc:+$('#budgetETC').value||0
    },
    status: $$('#statusBody tr').map(tr=>({
      area: tr.children[0].innerText,
      current: tr.children[1].querySelector('select').value,
      previous: tr.children[2].querySelector('select').value,
      notes: tr.children[3].querySelector('input').value
    })),
    milestones: $$('#milestonesTable tbody tr').map(tr=>({
      name: tr.children[0].querySelector('input').value,
      date: tr.children[1].querySelector('input').value,
      status: tr.children[2].querySelector('select').value,
      include: tr.children[3].querySelector('input[type="checkbox"]').checked
    })),
    issues: $$('#issuesTable tbody tr').map(tr=>({
      id: tr.children[0].querySelector('input').value,
      desc: tr.children[1].querySelector('input').value,
      impact: tr.children[2].querySelector('select').value,
      owner: tr.children[3].querySelector('input').value,
      status: tr.children[4].querySelector('select').value,
      next: tr.children[5].querySelector('input').value,
      include: tr.children[6].querySelector('input[type="checkbox"]').checked
    })),
    risks: $$('#risksTable tbody tr').map(tr=>({
      id: tr.children[0].querySelector('input').value,
      desc: tr.children[1].querySelector('input').value,
      rating: tr.children[2].querySelector('select').value,
      mit: tr.children[3].querySelector('input').value,
      include: tr.children[4].querySelector('input[type="checkbox"]').checked
    })),
    decisions: $$('#decisionsTable tbody tr').map(tr=>({
      decision: tr.children[0].querySelector('input').value,
      required: tr.children[1].querySelector('input').value,
      owner: tr.children[2].querySelector('input').value,
      status: tr.children[3].querySelector('select').value,
      include: tr.children[4].querySelector('input[type="checkbox"]').checked
    })),
    deps: $$('#depsTable tbody tr').map(tr=>({
      ref: tr.children[0].querySelector('input').value,
      dep: tr.children[1].querySelector('input').value,
      impact: tr.children[2].querySelector('input').value,
      owner: tr.children[3].querySelector('input').value,
      actions: tr.children[4].querySelector('input').value,
      status: tr.children[5].querySelector('select').value,
      include: tr.children[6].querySelector('input[type="checkbox"]').checked
    }))
  };

  const name = $('#projectName').value?.trim() || prompt('Filename (uses Project Name if set):','psr_data');
  if(!name) return;
  const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `${name}.json`;
  a.click();
}

function loadJSON(file){
  const r = new FileReader();
  r.onload = ()=>{
    const d = JSON.parse(r.result);
    $('#projectName').value = d.projectName || '';
    $('#projectId').value   = d.projectId   || '';
    $('#sponsor').value     = d.sponsor     || '';
    $('#pm').value          = d.pm          || '';
    $('#phase').value       = d.phase       || '';
    $('#reportDate').value  = d.reportDate  || '';
    $('#reportPeriod').value= d.reportPeriod|| '';

    $('#budgetApproved').value = d.budget?.approved || 0;
    $('#budgetSpent').value    = d.budget?.spent    || 0;
    $('#budgetETC').value      = d.budget?.etc      || 0;
    updateBudgetPills();

    /* Status */
    initStatus();
    if(Array.isArray(d.status)){
      d.status.forEach((s,i)=>{
        const tr=$$('#statusBody tr')[i];
        if(!tr) return;
        tr.children[1].querySelector('select').value = s.current  || 'Green';
        tr.children[2].querySelector('select').value = s.previous || 'Green';
        tr.children[3].querySelector('input').value  = s.notes    || '';
      });
    }

    /* Milestones */
    $('#milestonesTable tbody').innerHTML='';
    (d.milestones||[]).forEach(m=> addMilestoneRow(m));

    /* Issues */
    $('#issuesTable tbody').innerHTML='';
    (d.issues||[]).forEach(it=> addIssueRow(it));

    /* Risks */
    $('#risksTable tbody').innerHTML='';
    (d.risks||[]).forEach(rk=> addRiskRow(rk));

    /* Decisions */
    $('#decisionsTable tbody').innerHTML='';
    (d.decisions||[]).forEach(dd=> addDecisionRow(dd));

    /* Deps */
    $('#depsTable tbody').innerHTML='';
    (d.deps||[]).forEach(dp=> addDepRow({ id:dp.ref, dep:dp.dep, impact:dp.impact, owner:dp.owner, actions:dp.actions, status:dp.status, include:dp.include }));

    refreshPreview();
  };
  r.readAsText(file);
}

function copyCurrentToPrevious(){
  $$('#statusBody tr').forEach(tr=>{
    tr.children[2].querySelector('select').value = tr.children[1].querySelector('select').value;
  });
  refreshPreview();
}

/* ==== CSV Export (fixed to avoid stray literal newlines) ==== */
function exportCSV(){
  const esc = s => `"${String(s || '').replace(/"/g, '""')}"`;
  const lines = [];

  /* Meta + Budget metrics */
  lines.push(['Project Name','Project ID','Sponsor','PM','Phase','Report Date','Reporting Period','Approved','Spent','ETC','EAC','Variance'].map(esc).join(','));
  const approved = +$('#budgetApproved').value || 0,
        spent    = +$('#budgetSpent').value   || 0,
        etc      = +$('#budgetETC').value     || 0,
        eac      = spent + etc,
        variance = approved - eac;
  lines.push([
    $('#projectName').value, $('#projectId').value, $('#sponsor').value, $('#pm').value,
    $('#phase').value, $('#reportDate').value, $('#reportPeriod').value,
    approved, spent, etc, eac, variance
  ].map(esc).join(','));

  /* Status */
  lines.push('\nStatus');
  lines.push(['Area','Current','Previous','Notes'].map(esc).join(','));
  $$('#statusBody tr').forEach(tr=>{
    lines.push([
      tr.children[0].innerText,
      tr.children[1].querySelector('select').value,
      tr.children[2].querySelector('select').value,
      tr.children[3].querySelector('input').value
    ].map(esc).join(','));
  });

  /* Milestones */
  lines.push('\nMilestones');
  lines.push(['Milestone','Date','Status','Include'].map(esc).join(','));
  $$('#milestonesTable tbody tr').forEach(tr=>{
    lines.push([
      tr.children[0].querySelector('input').value,
      tr.children[1].querySelector('input').value,
      tr.children[2].querySelector('select').value,
      tr.children[3].querySelector('input[type="checkbox"]').checked
    ].map(esc).join(','));
  });

  /* Issues */
  lines.push('\nIssues');
  lines.push(['ID','Description','Impact','Owner','Status','Next Steps','Include'].map(esc).join(','));
  $$('#issuesTable tbody tr').forEach(tr=>{
    lines.push([
      tr.children[0].querySelector('input').value,
      tr.children[1].querySelector('input').value,
      tr.children[2].querySelector('select').value,
      tr.children[3].querySelector('input').value,
      tr.children[4].querySelector('select').value,
      tr.children[5].querySelector('input').value,
      tr.children[6].querySelector('input[type="checkbox"]').checked
    ].map(esc).join(','));
  });

  /* Risks */
  lines.push('\nRisks');
  lines.push(['ID','Description','Rating','Mitigation','Include'].map(esc).join(','));
  $$('#risksTable tbody tr').forEach(tr=>{
    lines.push([
      tr.children[0].querySelector('input').value,
      tr.children[1].querySelector('input').value,
      tr.children[2].querySelector('select').value,
      tr.children[3].querySelector('input').value,
      tr.children[4].querySelector('input[type="checkbox"]').checked
    ].map(esc).join(','));
  });

  /* Decisions */
  lines.push('\nDecisions');
  lines.push(['Decision','Required By','Owner','Status','Include'].map(esc).join(','));
  $$('#decisionsTable tbody tr').forEach(tr=>{
    lines.push([
      tr.children[0].querySelector('input').value,
      tr.children[1].querySelector('input').value,
      tr.children[2].querySelector('input').value,
      tr.children[3].querySelector('select').value,
      tr.children[4].querySelector('input[type="checkbox"]').checked
    ].map(esc).join(','));
  });

  /* Dependencies & Constraints */
  lines.push('\nDependencies & Constraints');
  lines.push(['Ref/ID','Dependency','Impact','Owner','Actions','Status','Include'].map(esc).join(','));
  $$('#depsTable tbody tr').forEach(tr=>{
    lines.push([
      tr.children[0].querySelector('input').value,
      tr.children[1].querySelector('input').value,
      tr.children[2].querySelector('input').value,
      tr.children[3].querySelector('input').value,
      tr.children[4].querySelector('input').value,
      tr.children[5].querySelector('select').value,
      tr.children[6].querySelector('input[type="checkbox"]').checked
    ].map(esc).join(','));
  });

  const blob = new Blob([lines.join('\n')], { type: 'text/csv' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = ($('#projectName').value || 'psr_summary') + `.csv`;
  a.click();
}

/* ===== Wiring, init ===== */
function wireTables(){
  $('#addMilestone').onclick = ()=> addMilestoneRow();
  $('#addIssue').onclick     = ()=> addIssueRow();
  $('#addRisk').onclick      = ()=> addRiskRow();
  $('#addDecision').onclick  = ()=> addDecisionRow();
  $('#addDep').onclick       = ()=> addDepRow();
}

function init(){
  initStatus(); wireTables();

  /* Inputs â†’ badges + preview */
  $('#budgetApproved').addEventListener('input',updateBudgetPills);
  $('#budgetSpent').addEventListener('input',updateBudgetPills);
  $('#budgetETC').addEventListener('input',updateBudgetPills);
  $$('#statusBody, #milestonesTable, #issuesTable, #risksTable, #decisionsTable, #depsTable')
    .forEach(el=>{
      el.addEventListener('input',refreshPreview);
      el.addEventListener('change',refreshPreview);
    });

  /* Toolbar */
  $('#saveBtn').onclick = saveJSON;
  $('#exportBtn').onclick = exportCSV;
  $('#importFile').addEventListener('change',e=>{
    const f=e.target.files[0]; if(f) loadJSON(f);
  });
  $('#printBtn').onclick = ()=> window.print();
  $('#newBtn').onclick = ()=> { if(confirm('Clear current data and start a new report?')) location.reload(); };
  $('#copyCurrentToPrev').onclick = copyCurrentToPrevious;
  $('#jumpReportBtn').onclick = ()=> { document.getElementById('reportCard')?.scrollIntoView({behavior:'smooth', block:'start'}); };

  updateBudgetPills(); refreshPreview();
}
document.addEventListener('DOMContentLoaded', init);

/* ===== v0.25 Theme toggle (persisted) ===== */
(function(){
  const KEY='psrTheme';
  function apply(theme){ document.body.classList.toggle('dark', theme==='dark'); }
  function current(){ return document.body.classList.contains('dark') ? 'dark' : 'light'; }

  document.addEventListener('DOMContentLoaded', function(){
    try{ if(localStorage.getItem(KEY)==='dark') apply('dark'); }catch(e){}
    const btn=document.getElementById('themeToggle');
    if(btn){
      btn.addEventListener('click', function(){
        const next = current()==='dark' ? 'light' : 'dark';
        apply(next);
        try{ localStorage.setItem(KEY, next); }catch(e){}
      });
    }
  });
})();
</script>
</body>
</html>
