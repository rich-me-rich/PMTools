<!--
Mini Change Log:
v0.15 – Revert Section 2 to earlier layout: removed Current/Previous icon columns and header tints; restored simple G/A/R radio groups
        for Current and Previous; moved "Copy Current → Previous" back under the table.
v0.14 – Section 1: default Reporting Period to Report Date; new 2-row layout.
        General: Budget moved above Section 2; Sections 4/5 moved above Section 2; guidance text italic; print shows only Report.
        Section 2 (now reverted in v0.15): coloured subheaders; icon columns; copy button moved above the table.
        Section 9: include checkbox + comment.
v1.0  – Guidance text + Budget note/EAC row; removed number spinners; button styling.
v0.9  – Title + how-to; milestones auto-seed; decisions include+status; budget single-row; dependencies table.
v0.8  – Include flags on issues/risks; milestone strike on Completed.
v0.7  – Section 2 grouped layout tweaks; prompt when Current ≠ Green.
v0.6  – Milestone dropdowns; include flags; 4&5 side-by-side.
v0.5  – Section 2 grouped Current/Previous with G/A/R radios.
v0.4  – Copy Current → Previous; prompt when Current ≠ Green.
v0.3  – Swapped 1.6 & 1.7; removed 1.8.
v0.2  – White theme baseline; CSV exports; print-friendly report.
v0.1  – Initial functional build.
-->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Project Status Report — v0.15</title>
<style>
  :root{
    --bg:#ffffff; --card:#ffffff; --border:#e5e7eb;
    --text:#111827; --text-dim:#4b5563;
    --g:#10b981; --a:#f59e0b; --r:#ef4444; --b:#2563eb;
    --shadow: 0 6px 24px rgba(0,0,0,.08), 0 2px 8px rgba(0,0,0,.06);
    --chip:#f8fafc;
    --btn:#2563eb; --btn-text:#ffffff; --btn-hover:#1d4ed8;
    --btn-alt:#10b981; --btn-alt-hover:#059669;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;line-height:1.45}
  h1,h2,h3{margin:0 0 .5rem}
  h2{font-size:1.1rem;font-weight:700}
  h3{font-size:1rem;color:var(--text-dim);font-weight:600}
  .container{max-width:1200px;margin:0 auto;padding:24px}
  .grid{display:grid;gap:16px}
  .cols-2{grid-template-columns:1fr 1fr}
  .cols-2-slim{grid-template-columns:1fr 1fr}
  .cols-4{grid-template-columns:repeat(4,1fr)}
  .cols-5{grid-template-columns:repeat(5,1fr)}
  .cols-5-tight{grid-template-columns:repeat(5,minmax(0,1fr))}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:16px;margin-bottom:12px}
  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .toolbar .spacer{flex:1}
  .field{display:flex;flex-direction:column;gap:6px}
  label{font-size:.85rem;color:var(--text-dim)}
  input[type="text"],input[type="date"],input[type="number"],select,textarea{
    width:100%;border:1px solid var(--border);background:#fff;color:var(--text);padding:10px 12px;border-radius:10px;outline:none
  }
  textarea{min-height:140px}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}

  /* Buttons */
  .btn{border:1px solid transparent;border-radius:12px;cursor:pointer;padding:10px 14px;font-weight:600}
  .btn.filled{background:var(--btn);color:var(--btn-text)}
  .btn.filled:hover{background:var(--btn-hover)}
  .btn.alt{background:var(--btn-alt);color:#fff}
  .btn.alt:hover{background:var(--btn-alt-hover)}
  .checkbox{display:inline-flex;align-items:center;gap:8px}

  table{width:100%;border-collapse:separate;border-spacing:0 8px}
  th,td{padding:10px 12px;background:#fff;border-top:1px solid var(--border);border-bottom:1px solid var(--border);vertical-align:middle}
  th:first-child,td:first-child{border-left:1px solid var(--border);border-top-left-radius:10px;border-bottom-left-radius:10px}
  th:last-child,td:last-child{border-right:1px solid var(--border);border-top-right-radius:10px;border-bottom-right-radius:10px}
  th{font-weight:600;color:#394150}
  .center{text-align:center}

  /* Guidance now italic so it doesn't look like an input */
  .hint,.guidance{font-size:.9rem;color:#6b7280}
  .guidance{font-style:italic;background:#fff;border:0;border-left:3px solid #e5e7eb;border-radius:0;padding:8px 12px;margin:6px 0 10px}

  /* Money input with $ prefix */
  .money{display:flex;align-items:center;border:1px solid var(--border);border-radius:10px;background:#fff}
  .money > span{display:inline-block;padding:10px 10px;border-right:1px solid var(--border);color:#6b7280}
  .money > input{border:0;flex:1;padding-left:10px}

  /* Remove number spin buttons */
  input[type=number]::-webkit-outer-spin-button,
  input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
  input[type=number]{ -moz-appearance: textfield; }

  /* Variance pill */
  .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);border-radius:999px;padding:8px 12px;background:var(--chip)}
  .pill.ok{border-color:#166534;background:rgba(22,101,52,.08);color:#166534;font-weight:700}
  .pill.bad{border-color:#7f1d1d;background:rgba(127,29,29,.08);color:#7f1d1d;font-weight:700}

  /* Print: show ONLY the Report card */
  @media print{
    .no-print{display:none !important}
    .card{display:none !important}
    #reportCard{display:block !important}
    #reportCard .report{box-shadow:none;border:none}
    .container{padding:0}
    th,td{background:#fff;border-color:#ddd}
  }

  .report{background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.08);padding:20px}
  .status-chip{display:inline-flex;align-items:center;gap:8px;border:1px solid #e5e7eb;border-radius:999px;padding:6px 10px}
  .strike{ text-decoration: line-through; color:#6b7280}
  .small{font-size:.9rem}
</style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="toolbar">
        <h1>Project Status Report — Builder</h1>
        <div class="spacer"></div>
        <small class="hint">v0.15</small>
      </div>

      <div class="guidance small">
        <strong>How to use:</strong> 1) Fill Section 1 basics. 2) Set Current/Previous in Section 2 (amber/red needs a brief “path to green”).
        3) Add milestones — selecting <em>Completed</em> will strike the text. 4) Add issues/risks/decisions and tick <em>Include</em> to show in the report.
        5) Enter budget values in <em>000’s</em>; EAC is calculated and variance shows green (underrun) or red (overrun). 6) Refresh the preview and print/export.
      </div>

      <div class="toolbar no-print" style="margin-top:8px">
        <button class="btn filled" id="newBtn">New</button>
        <input class="btn filled" type="file" id="importFile" accept="application/json,text/json" value="Import JSON" />
        <button class="btn filled" id="saveJsonBtn">Save JSON</button>
        <button class="btn alt" id="exportCsvBtn">Export CSV (Summary)</button>
        <div class="spacer"></div>
        <button class="btn filled" id="printBtn">Print Report</button>
      </div>
    </div>

    <!-- 1. Base Project Information -->
    <div class="card">
      <h2>1. Base Project Information</h2>
      <div class="guidance">Enter the key identifiers and reporting dates used to label the report and period covered.</div>

      <!-- Row 1 -->
      <div class="grid cols-5-tight" style="align-items:end">
        <div class="field"><label>Project Name</label><input id="projName" type="text" /></div>
        <div class="field"><label>Project ID / Code</label><input id="projCode" type="text" /></div>
        <div class="field"><label>Sponsor Name</label><input id="sponsor" type="text" /></div>
        <div class="field"><label>Project Manager</label><input id="pm" type="text" /></div>
        <div class="field"><label>Project Phase</label>
          <select id="phase"><option>Initiation</option><option>Discovery</option><option>Planning</option><option>Execution</option><option>Closure</option></select>
        </div>
      </div>
      <!-- Row 2 -->
      <div class="grid cols-4" style="margin-top:12px">
        <div class="field"><label>Report Date</label><input id="reportDate" type="date" /></div>
        <div class="field"><label>Reporting Period (Start)</label><input id="periodStart" type="date" /></div>
        <div class="field"><label>Reporting Period (End)</label><input id="periodEnd" type="date" /></div>
      </div>
    </div>

    <!-- 8. Budget Summary (000’s) -->
    <div class="card">
      <h2>8. Budget Summary (000’s)</h2>
      <div class="guidance">Enter values in thousands. Budget includes contingency and all <em>approved</em> change requests. EAC is calculated as <strong>Spend to Date + Current ETC</strong>. Variance = <strong>Approved – EAC</strong>.</div>
      <div class="grid cols-5" style="margin-top:8px">
        <div class="field">
          <label>Approved Budget</label>
          <div class="money"><span>$</span><input id="budgetApproved" type="number" min="0" step="1" placeholder="0" /></div>
        </div>
        <div class="field">
          <label>Spend to Date</label>
          <div class="money"><span>$</span><input id="budgetSpent" type="number" min="0" step="1" placeholder="0" /></div>
        </div>
        <div class="field">
          <label>Current ETC</label>
          <div class="money"><span>$</span><input id="budgetEtc" type="number" min="0" step="1" placeholder="0" /></div>
        </div>
        <div class="field">
          <label>Estimate at Completion (EAC)</label>
          <div class="pill" id="eacPill"><strong id="eacText">$0</strong></div>
        </div>
        <div class="field">
          <label>Variance (Approved – EAC)</label>
          <div class="pill" id="variancePill"><strong id="varianceText">$0</strong></div>
        </div>
      </div>
    </div>

    <!-- 4–5. Narrative -->
    <div class="card">
      <h2>4–5. Narrative</h2>
      <div class="guidance">Summarise what was achieved this period and what’s planned next period. Keep it concise and executive-ready.</div>
      <div class="grid cols-2-slim">
        <div class="field">
          <h3>4. Key Achievements This Period</h3>
          <textarea id="achText" style="min-height:180px" placeholder="Free text…"></textarea>
        </div>
        <div class="field">
          <h3>5. Key Activities planned for Next Period</h3>
          <textarea id="nextText" style="min-height:180px" placeholder="Free text…"></textarea>
        </div>
      </div>
    </div>

    <!-- 2. Status Summary (REVERTED) -->
    <div class="card">
      <h2>2. Status Summary</h2>
      <div class="guidance">Choose one status (G/A/R) for each row under <em>Current</em> and <em>Previous</em>. If Current is Amber/Red (except 2.1) add a brief path-to-green.</div>

      <div class="field" style="margin:10px 0">
        <label>Status summary</label>
        <textarea id="execSummary" placeholder="2–3 sentences on outcomes, variances, and asks."></textarea>
      </div>

      <table id="statusTable">
        <thead>
          <tr>
            <th rowspan="2">Item</th>
            <th colspan="3">Current</th>
            <th colspan="3">Previous</th>
            <th rowspan="2">Path to green / comments</th>
          </tr>
          <tr>
            <th>Green</th><th>Amber</th><th>Red</th>
            <th>Green</th><th>Amber</th><th>Red</th>
          </tr>
        </thead>
        <tbody id="statusTableBody"></tbody>
      </table>

      <div class="row no-print" style="margin-top:8px">
        <button class="btn filled" id="copyCurrentToPrev">Copy Current → Previous</button>
      </div>
    </div>

    <!-- 3. Milestone Status -->
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h2>3. Milestone Status</h2>
        <button class="btn filled" id="addMilestone">Add Milestone</button>
      </div>
      <div class="guidance">Enter milestones with dates; first time you enter an <em>Original</em> date, <em>Revised</em> will copy it (editable). Mark <em>Completed</em> to strike through.</div>
      <table>
        <thead>
          <tr>
            <th>Milestone</th>
            <th>Original Date</th>
            <th>Revised Date</th>
            <th>Status</th>
            <th class="center">Add to report</th>
            <th class="no-print">Actions</th>
          </tr>
        </thead>
        <tbody id="milestoneBody"></tbody>
      </table>
    </div>

    <!-- 6. Issues & Risks -->
    <div class="card">
      <h2>6. Issues & Risks</h2>
      <div class="guidance">Capture the top issues and risks. Use <em>Include</em> to control what appears in the report and CSV.</div>
      <div class="grid cols-2">
        <div>
          <div class="row" style="justify-content:space-between;align-items:center">
            <h3>6.1 Significant Issues</h3>
            <button class="btn filled" id="addIssue">Add Issue</button>
          </div>
          <table>
            <thead><tr><th>Issue</th><th>Impact</th><th>Owner</th><th>Status / Next Steps</th><th class="center">Include</th></tr></thead>
            <tbody id="issueBody"></tbody>
          </table>
        </div>
        <div>
          <div class="row" style="justify-content:space-between;align-items:center">
            <h3>6.2 Significant Risks</h3>
            <button class="btn filled" id="addRisk">Add Risk</button>
          </div>
          <table>
            <thead><tr><th>Risk</th><th>Likelihood</th><th>Impact</th><th>Mitigation</th><th class="center">Include</th></tr></thead>
            <tbody id="riskBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- 7. Decisions -->
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h2>7. Key Decisions Required</h2>
        <button class="btn filled" id="addDecision">Add Decision</button>
      </div>
      <div class="guidance">Track key decisions with required-by dates. Set status to <em>Completed</em> to strike through. Use <em>Include</em> to show in the report.</div>
      <table>
        <thead>
          <tr><th>Decision</th><th>Required By</th><th>Owner</th><th>Status</th><th class="center">Include</th><th class="no-print">Actions</th></tr>
        </thead>
        <tbody id="decisionBody"></tbody>
      </table>
    </div>

    <!-- 9. Dependencies & Constraints (include + comment retained) -->
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h2>9. Dependencies & Constraints</h2>
        <button class="btn filled" id="addDep">Add Row</button>
      </div>
      <div class="guidance">Reference dependencies with an ID, capture actions, and set status. Mark <em>Completed</em> to strike through in the preview.</div>
      <table>
        <thead>
          <tr>
            <th>Reference / ID</th>
            <th>Dependency</th>
            <th>Impact if Delayed</th>
            <th>Owner</th>
            <th>Actions</th>
            <th>Status</th>
            <th>Comment</th>
            <th class="center">Include</th>
            <th class="no-print">Controls</th>
          </tr>
        </thead>
        <tbody id="depBody"></tbody>
      </table>
    </div>

    <!-- Report Preview (PRINT-ONLY) -->
    <div class="card" id="reportCard">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h2>Report Preview</h2>
        <div class="row no-print">
          <button class="btn alt" id="refreshPreview">Refresh</button>
          <button class="btn filled" id="refreshPreview2">Build/Refresh Report</button>
          <button class="btn filled" id="printBtn2">Print Report</button>
        </div>
      </div>
      <div class="guidance">The preview mirrors what will print. Use the include checkboxes to curate items.</div>
      <div id="reportPreview" class="report"></div>
    </div>
  </div>

<script>
/* ===== Utilities ===== */
const $ = (sel) => document.querySelector(sel);
const fmtCurrency0 = (n) => '$' + Math.round(+n||0).toLocaleString();
const download = (filename, text, mime='text/plain') => {
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([text], {type:mime}));
  a.download = filename; a.click(); URL.revokeObjectURL(a.href);
};

/* ===== Status rows ===== */
function statusRowDef(){
  return [
    {key:'overall', label:'2.1 Overall Status'},
    {key:'scope',   label:'2.2 Scope Status'},
    {key:'schedule',label:'2.3 Schedule Status'},
    {key:'budget',  label:'2.4 Budget Status'},
    {key:'quality', label:'2.5 Quality Status'},
    {key:'risk',    label:'2.7 Risk Status'},
    {key:'stake',   label:'2.8 Stakeholder Status'},
  ];
}

/* ===== Section 2 (REVERTED) ===== */
function buildStatusTable(){
  const body = $('#statusTableBody');
  body.innerHTML = '';
  for(const row of statusRowDef()){
    const isOverall = row.key === 'overall';
    const tr = document.createElement('tr');
    tr.setAttribute('data-key', row.key);
    tr.innerHTML = `
      <td>${row.label}</td>
      ${radioTd(row.key,'current','G')}
      ${radioTd(row.key,'current','A')}
      ${radioTd(row.key,'current','R')}
      ${radioTd(row.key,'previous','G')}
      ${radioTd(row.key,'previous','A')}
      ${radioTd(row.key,'previous','R')}
      ${isOverall ? '<td></td>' :
        '<td><input data-skey="'+row.key+'" data-field="notes" type="text" placeholder="Path to green / comments" /></td>'}
    `;
    body.appendChild(tr);
  }
  body.addEventListener('change', (e)=>{
    const el = e.target;
    if(el.type === 'radio' && el.name.startsWith('current_')){
      const key = el.name.replace('current_','');
      const notes = document.querySelector(`input[data-skey="${key}"][data-field="notes"]`);
      if(!notes) return;
      if(el.value !== 'G'){ notes.classList.add('needs-comment'); if(!notes.value.trim()) notes.placeholder='Please add path to green'; notes.focus(); }
      else { notes.classList.remove('needs-comment'); }
    }
  });
}
function radioTd(key, section, val){
  const name = `${section}_${key}`;
  const aria = `${section} ${key} ${val}`;
  return `<td class="center"><input class="status-radio" type="radio" name="${name}" value="${val}" aria-label="${aria}"></td>`;
}

/* ===== Milestones ===== */
function rowControlsTD(){
  const td=document.createElement('td'); td.className='no-print';
  const del=document.createElement('button'); del.className='btn filled'; del.textContent='Delete';
  del.onclick=(e)=>e.target.closest('tr').remove(); td.appendChild(del); return td;
}
function milestoneStatusSelect(value){
  const opts = ['On Track','Delayed','Not started','Completed'];
  return `<select class="ms-status">${opts.map(o=>`<option${o===value?' selected':''}>${o}</option>`).join('')}</select>`;
}
function updateMilestoneStrike(tr){
  const nameInput = tr.querySelector('td:nth-child(1) input[type="text"]');
  const statusSel = tr.querySelector('.ms-status');
  if(!nameInput || !statusSel) return;
  if(statusSel.value === 'Completed'){
    nameInput.style.textDecoration = 'line-through';
    nameInput.style.color = '#6b7280';
  }else{
    nameInput.style.textDecoration = '';
    nameInput.style.color = '';
  }
}
function addMilestoneRow(v={}){
  const tr=document.createElement('tr');
  tr.innerHTML=`
    <td><input type="text" value="${v.name||''}" placeholder="Milestone"></td>
    <td><input class="ms-orig" type="date" value="${v.orig||''}"></td>
    <td><input class="ms-rev" type="date" value="${v.rev||''}"></td>
    <td>${milestoneStatusSelect(v.status||'')}</td>
    <td class="center"><label class="checkbox"><input type="checkbox" class="ms-include" ${v.include===false?'':'checked'}> Include</label></td>
  `;
  tr.appendChild(rowControlsTD());
  $('#milestoneBody').appendChild(tr);

  const orig = tr.querySelector('.ms-orig');
  const rev  = tr.querySelector('.ms-rev');
  orig.addEventListener('change', ()=>{
    if(!rev.value){ rev.value = orig.value; rev.dataset.autoset = '1'; }
  });

  updateMilestoneStrike(tr);
  tr.querySelector('.ms-status').addEventListener('change', ()=>updateMilestoneStrike(tr));
}

/* ===== Issues / Risks / Decisions / Deps ===== */
function addIssueRow(v={}){ const tr=document.createElement('tr');
  tr.innerHTML=`<td><input type="text" value="${v.issue||''}"></td>
                <td><input type="text" value="${v.impact||''}"></td>
                <td><input type="text" value="${v.owner||''}"></td>
                <td><input type="text" value="${v.status||''}"></td>
                <td class="center"><input type="checkbox" class="inc" ${v.include===false?'':'checked'}></td>`;
  $('#issueBody').appendChild(tr);
}
function addRiskRow(v={}){ const tr=document.createElement('tr');
  tr.innerHTML=`<td><input type="text" value="${v.risk||''}"></td>
                <td><input type="text" value="${v.like||''}"></td>
                <td><input type="text" value="${v.impact||''}"></td>
                <td><input type="text" value="${v.mit||''}"></td>
                <td class="center"><input type="checkbox" class="inc" ${v.include===false?'':'checked'}></td>`;
  $('#riskBody').appendChild(tr);
}

/* Decisions */
function decisionStatusSelect(value){
  const opts = ['Not started','In progress','Blocked','Deferred','Completed'];
  return `<select class="dc-status">${opts.map(o=>`<option${o===value?' selected':''}>${o}</option>`).join('')}</select>`;
}
function updateDecisionStrike(tr){
  const desc = tr.querySelector('td:nth-child(1) input[type="text"]');
  const sel  = tr.querySelector('.dc-status');
  if(!desc || !sel) return;
  if(sel.value === 'Completed'){ desc.classList.add('strike'); }
  else { desc.classList.remove('strike'); }
}
function addDecisionRow(v={}){ const tr=document.createElement('tr');
  tr.innerHTML=`<td><input type="text" value="${v.desc||''}"></td>
                <td><input type="date" value="${v.req||''}"></td>
                <td><input type="text" value="${v.owner||''}"></td>
                <td>${decisionStatusSelect(v.status||'')}</td>
                <td class="center"><input type="checkbox" class="dc-include" ${v.include===false?'':'checked'}></td>`;
  tr.appendChild(rowControlsTD());
  $('#decisionBody').appendChild(tr);
  updateDecisionStrike(tr);
  tr.querySelector('.dc-status').addEventListener('change', ()=>updateDecisionStrike(tr));
}

/* Dependencies (include + comment) */
function depStatusSelect(value){
  const opts = ['Not started','In progress','Blocked','Deferred','Completed'];
  return `<select class="dep-status">${opts.map(o=>`<option${o===value?' selected':''}>${o}</option>`).join('')}</select>`;
}
function updateDepStrike(tr){
  const depTxt = tr.querySelector('td:nth-child(2) input[type="text"]');
  const sel = tr.querySelector('.dep-status');
  if(!depTxt || !sel) return;
  if(sel.value === 'Completed'){ depTxt.classList.add('strike'); }
  else { depTxt.classList.remove('strike'); }
}
function addDepRow(v={}){ const tr=document.createElement('tr');
  tr.innerHTML=`<td><input type="text" value="${v.id||''}" placeholder="ID / REF"></td>
                <td><input type="text" value="${v.dep||''}" placeholder="Dependency"></td>
                <td><input type="text" value="${v.impact||''}" placeholder="Impact if delayed"></td>
                <td><input type="text" value="${v.owner||''}" placeholder="Owner"></td>
                <td><input type="text" value="${v.actions||''}" placeholder="Actions"></td>
                <td>${depStatusSelect(v.status||'')}</td>
                <td><input type="text" value="${v.comment||''}" placeholder="Comment"></td>
                <td class="center"><input type="checkbox" class="dep-include" ${v.include===false?'':'checked'}></td>`;
  tr.appendChild(rowControlsTD());
  $('#depBody').appendChild(tr);
  updateDepStrike(tr);
  tr.querySelector('.dep-status').addEventListener('change', ()=>updateDepStrike(tr));
}

/* ===== Data extraction / injection ===== */
function getTableRows(tbody){ const rows=[]; tbody.querySelectorAll('tr').forEach(tr=>{
  const inputs=[...tr.querySelectorAll('input,select')]; rows.push(inputs.map(i=>i.type==='checkbox'?i.checked:i.value)); }); return rows; }

function collectData(){
  const status = {};
  for(const row of statusRowDef()){
    const cur = document.querySelector(`input[name="current_${row.key}"]:checked`);
    const prev = document.querySelector(`input[name="previous_${row.key}"]:checked`);
    const notesEl= document.querySelector(`input[data-skey="${row.key}"][data-field="notes"]`);
    const notes = notesEl ? notesEl.value.trim() : '';
    status[row.key] = {current: cur?cur.value:'', previous: prev?prev.value:'', notes};
  }
  const msRows = getTableRows($('#milestoneBody')).map(r=>({
    name:r[0], orig:r[1], rev:r[2], status:r[3], include:r[4]
  }));
  const issueRows = getTableRows($('#issueBody')).map(r=>({issue:r[0],impact:r[1],owner:r[2],status:r[3],include:r[4]}));
  const riskRows  = getTableRows($('#riskBody')).map(r=>({risk:r[0],like:r[1],impact:r[2],mit:r[3],include:r[4]}));
  const decisionRows = getTableRows($('#decisionBody')).map(r=>({desc:r[0],req:r[1],owner:r[2],status:r[3],include:r[4]}));
  const depRows = getTableRows($('#depBody')).map(r=>({id:r[0],dep:r[1],impact:r[2],owner:r[3],actions:r[4],status:r[5],comment:r[6],include:r[7]}));

  return {
    meta:{
      projName:$('#projName').value, projCode:$('#projCode').value, sponsor:$('#sponsor').value, pm:$('#pm').value,
      reportDate:$('#reportDate').value, periodStart:$('#periodStart').value, periodEnd:$('#periodEnd').value, phase:$('#phase').value
    },
    status,
    execSummary:$('#execSummary').value,
    milestones: msRows,
    achText:$('#achText')?.value||'',
    nextText:$('#nextText')?.value||'',
    issues: issueRows,
    risks: riskRows,
    decisions: decisionRows,
    deps: depRows,
    budget:{approved:+($('#budgetApproved').value||0),spent:+($('#budgetSpent').value||0),etc:+($('#budgetEtc').value||0)}
  };
}

function populateData(d){
  $('#projName').value=d.meta?.projName||''; $('#projCode').value=d.meta?.projCode||'';
  $('#sponsor').value=d.meta?.sponsor||''; $('#pm').value=d.meta?.pm||'';
  $('#reportDate').value=d.meta?.reportDate||''; $('#periodStart').value=d.meta?.periodStart||'';
  $('#periodEnd').value=d.meta?.periodEnd||''; $('#phase').value=d.meta?.phase||'Initiation';

  for(const [k,v] of Object.entries(d.status||{})){
    const cur=document.querySelector(`input[name="current_${k}"][value="${v.current}"]`);
    const prev=document.querySelector(`input[name="previous_${k}"][value="${v.previous}"]`);
    const notes=document.querySelector(`input[data-skey="${k}"][data-field="notes"]`);
    if(cur) cur.checked=true; if(prev) prev.checked=true; if(notes && typeof v.notes==='string') notes.value=v.notes;
  }

  $('#execSummary').value=d.execSummary||'';

  const tb = $('#milestoneBody'); tb.innerHTML='';
  (d.milestones||[]).forEach(m=>addMilestoneRow(m));
  if(!d.milestones?.length) addMilestoneRow({});

  const clear=(sel)=>{const t=$(sel); t.innerHTML=''; return t;};
  clear('#issueBody'); (d.issues||[]).forEach(i=>addIssueRow(i)); if(!d.issues?.length){ for(let i=0;i<2;i++) addIssueRow({}); }
  clear('#riskBody'); (d.risks||[]).forEach(r=>addRiskRow(r)); if(!d.risks?.length){ for(let i=0;i<2;i++) addRiskRow({}); }
  clear('#decisionBody'); (d.decisions||[]).forEach(dc=>addDecisionRow(dc)); if(!d.decisions?.length) addDecisionRow({});
  clear('#depBody'); (d.deps||[]).forEach(dp=>addDepRow(dp)); if(!d.deps?.length) addDepRow({});

  $('#budgetApproved').value=d.budget?.approved??0; $('#budgetSpent').value=d.budget?.spent??0; $('#budgetEtc').value=d.budget?.etc??0;
  updateBudgetPills();
}

/* ===== CSV / Preview / Import-Export ===== */
function csvEscape(v){ return `"${String(v??'').replaceAll('"','""')}"`; }
function buildSummaryCsv(d){
  const lines=['Section,Field,Value'], m=d.meta, b=d.budget, push=(s,k,v)=>lines.push(`${s},${csvEscape(k)},${csvEscape(v)}`);
  push('Meta','Project Name',m.projName); push('Meta','Project Code',m.projCode);
  push('Meta','Sponsor',m.sponsor); push('Meta','Project
