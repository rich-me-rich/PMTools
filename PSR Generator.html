<!-- PSR generator - V0.26 - part 1 of 4 : filename=PSR Generator.html
     CHANGE LOG (v0.26):
     - Added theme toggle button (🌗) and dark theme styles.
     - Print: hide the “Report Preview” heading row.
     - Report header: moved Project Phase into the first identity line (ID/Sponsor/PM/Phase),
       leaving dates on the second line to fit everything within two lines.
     - Renamed “Status Summary (detail)” → “Status breakdown”.
     - Removed outer report box (no border/box-shadow/padding on .report) to maximise width in preview/print.
     - Budget: ensured dark theme applies correctly to money inputs and pills.
     - Print: Budget Variance pill set to no-wrap.
     NOTE: Only the requested changes were made; no other behaviour altered. 
-->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Project Status Report — v0.26</title>
<style>
  :root{
    --bg:#ffffff; --card:#ffffff; --border:#e5e7eb;
    --text:#111827; --text-dim:#4b5563;
    --g:#10b981; --a:#f59e0b; --r:#ef4444; --b:#2563eb;
    --g-tint: rgba(16,185,129,.14);
    --a-tint: rgba(245,158,11,.16);
    --r-tint: rgba(239,68,68,.14);
    --shadow: 0 6px 24px rgba(0,0,0,.08), 0 2px 8px rgba(0,0,0,.06);
    --chip:#f8fafc;
    --btn:#2563eb; --btn-text:#ffffff; --btn-hover:#1d4ed8;
    --btn-alt:#10b981; --btn-alt-hover:#059669;
  }
  *{box-sizing:border-box}
  body{margin:0;background:#f8fafc;color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;line-height:1.45}
  h1,h2,h3{margin:0 0 .5rem}
  h2{font-size:1.1rem;font-weight:700}
  h3{font-size:1rem;color:var(--text-dim);font-weight:600}
  .container{max-width:1200px;margin:0 auto;padding:24px}
  .grid{display:grid;gap:16px}
  .cols-2{grid-template-columns:1fr 1fr}
  .cols-2-slim{grid-template-columns:1fr 1fr}
  .cols-4{grid-template-columns:repeat(4,1fr)}
  .cols-5-tight{grid-template-columns:repeat(5,minmax(0,1fr))}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:16px;margin-bottom:12px}
  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .toolbar .spacer{flex:1}
  .field{display:flex;flex-direction:column;gap:6px}
  label{font-size:.85rem;color:var(--text-dim)}
  input[type="text"],input[type="date"],input[type="number"],select,textarea{
    width:100%;border:1px solid var(--border);background:#fff;color:var(--text);padding:10px 12px;border-radius:10px;outline:none
  }
  textarea{min-height:140px}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .center{text-align:center}
  .hidden{display:none}

  .btn{border:1px solid transparent;border-radius:12px;cursor:pointer;padding:10px 14px;font-weight:600}
  .btn.filled{background:var(--btn);color:var(--btn-text)}
  .btn.filled:hover{background:var(--btn-hover)}
  .btn.alt{background:var(--btn-alt);color:#fff}
  .btn.alt:hover{background:var(--btn-alt-hover)}

  table{width:100%;border-collapse:separate;border-spacing:0 8px}
  th,td{padding:10px 12px;background:#fff;border-top:1px solid var(--border);border-bottom:1px solid var(--border);vertical-align:middle}
  th:first-child,td:first-child{border-left:1px solid var(--border);border-top-left-radius:10px;border-bottom-left-radius:10px}
  th:last-child,td:last-child{border-right:1px solid var(--border);border-top-right-radius:10px;border-bottom-right-radius:10px}
  th{font-weight:600;color:#394150}

  .hint,.guidance{font-size:.9rem;color:#6b7280}
  .guidance{font-style:italic;background:#fff;border:0;border-left:3px solid #e5e7eb;border-radius:0;padding:8px 12px;margin:6px 0 10px}

  .money{display:flex;align-items:center;border:1px solid var(--border);border-radius:10px;background:#fff}
  .money > span{display:inline-block;padding:10px 10px;border-right:1px solid var(--border);color:#6b7280}
  .money > input{border:0;flex:1;padding-left:10px}

  /* NUMBER ALIGNMENT (General) */
  input[type=number]{ -moz-appearance:textfield; text-align:right; font-variant-numeric: tabular-nums; }
  input[type=number]::-webkit-outer-spin-button,
  input[type=number]::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0; }
  .tnum{ font-variant-numeric: tabular-nums; }

  .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);border-radius:999px;padding:8px 12px;background:var(--chip)}
  .pill.ok{border-color:#166534;background:rgba(22,101,52,.08);color:#166534;font-weight:700}
  .pill.bad{border-color:#7f1d1d;background:rgba(127,29,29,.08);color:#7f1d1d;font-weight:700}

  .th-g{background:var(--g-tint)}
  .th-a{background:var(--a-tint)}
  .th-r{background:var(--r-tint)}

  <!-- PSR generator - V0.26 - part 2 of 4 : filename=PSR Generator.html -->
  /* ---- PRINT (revised) ---- */
  @media print {
    body * { visibility: hidden !important; }
    #reportPreview, #reportPreview * {
      visibility: visible !important;
    }
    #reportPreview {
      position: absolute;
      left: 0; top: 0;
      width: 100%;
    }
    th,td{background:#fff;border-color:#ddd}
    .budget-row{flex-wrap:nowrap} /* keep in one row on print */
  }

     
  /* Report container (outer box removed per v0.26) */
  .report{
    background:transparent; /* was #fff */
    border:none;            /* removed outer box */
    box-shadow:none;        /* remove drop shadow */
    padding:0;              /* maximise usable width */
  }

  .report-section{border:1px solid #e5e7eb;border-radius:12px;padding:14px;margin:12px 0}
  .split-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .status-milestones{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .issues-risks{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .status-chip{display:inline-flex;align-items:center;gap:10px;border:1px solid #e5e7eb;border-radius:999px;padding:10px 14px;font-weight:700;font-size:1.05rem}
  .chip-g{background:rgba(16,185,129,.12);border-color:#10b981;color:#065f46}
  .chip-a{background:rgba(245,158,11,.12);border-color:#f59e0b;color:#7c2d12}
  .chip-r{background:rgba(239,68,68,.12);border-color:#ef4444;color:#7f1d1d}
  .chip-b{background:rgba(37,99,235,.12);border-color:#2563eb;color:#1e3a8a}
  .strike{text-decoration:line-through;color:#6b7280}
  .small{font-size:.9rem}

  .ico{display:inline-block;vertical-align:middle;line-height:0}
  .ico svg{width:24px;height:24px} /* 2x icons */

  .meta-row{display:flex;gap:18px;flex-wrap:wrap;color:#6b7280;margin-top:4px}
  .meta-row span{display:inline-block;margin-right:10px;white-space:nowrap}

  .tight-table table{border-collapse:collapse;margin:8px 0}
  .tight-table th,.tight-table td{border:1px solid #e5e7eb;background:#fff}

  .budget-row .status-chip, .budget-row .pill{white-space:nowrap}

  /* ===== v0.26 ADDITIONS ONLY (minimal) ===== */

  /* A) Dark theme (toggle) */
  body.dark{ background:#0b1220; color:#e5e7eb }
  body.dark .card,
  body.dark .report,
  body.dark th, body.dark td{ background:#0f172a; color:#e5e7eb }
  body.dark input[type="text"], body.dark input[type="date"],
  body.dark input[type="number"], body.dark select, body.dark textarea{
    background:#0b1220; color:#e5e7eb; border-color:#1e293b
  }
  body.dark .guidance{ background:#0f172a; color:#94a3b8; border-left-color:#334155 }

  /* v0.26: Dark theme fixes for Budget inputs (.money) and pills */
  body.dark .money{ background:#0b1220; border-color:#1e293b }
  body.dark .money > span{ border-right-color:#1e293b; color:#94a3b8 }
  body.dark .pill{ background:#0f172a; border-color:#334155; color:#e5e7eb }
  body.dark .pill.ok{ border-color:#166534; background:rgba(22,101,52,.18); color:#34d399 }
  body.dark .pill.bad{ border-color:#7f1d1d; background:rgba(127,29,29,.18); color:#fca5a5 }

  /* B) Print tables: avoid page breaks inside rows/cells */
  .report-section table, .report-section tr, .report-section td, .report-section th{
    break-inside: avoid; page-break-inside: avoid;
  }

  /* C) Budget Variance pill: never wrap (explicit) */
  @media print{
    #variancePill{ white-space:nowrap }
  }
</style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="toolbar">
        <h1>Project Status Report — Builder</h1>
        <div class="spacer"></div>
        <button class="btn filled" id="themeBtn" title="Toggle light/dark theme">🌗 Theme</button>
        <small class="hint">v0.26</small>
      </div>

      <div class="guidance small">
        <strong>How to use:</strong> Fill Base Info → Budget → Narrative → Status → Milestones → Issues/Risks → Decisions → Dependencies.
        Preview updates automatically; print only outputs the report.
      </div>

      <div class="toolbar no-print" style="margin-top:8px">
        <button class="btn filled" id="newBtn">New</button>

        <label class="btn filled" for="importFile" id="importLabel">Import save data</label>
        <input class="hidden" type="file" id="importFile" accept="application/json,text/json" />
        <span id="importName" class="hint"></span>

        <button class="btn filled" id="saveJsonBtn">Save JSON</button>
        <button class="btn alt" id="exportCsvBtn">Export CSV (Summary)</button>
        <div class="spacer"></div>
        <button class="btn filled" id="jumpReportBtn" title="Scroll to Report Preview">Jump to Report</button>
        <button class="btn filled" id="printBtn">Print Report</button>
      </div>
    </div>
    <!-- 1. Base Project Information -->
    <div class="card">
      <h2>1. Base Project Information</h2>
      <div class="guidance">Enter the key identifiers and reporting dates used to label the report and period covered.</div>
      <div class="grid cols-5-tight" style="align-items:end">
        <div class="field"><label>Project Name</label><input id="projName" type="text" /></div>
        <div class="field"><label>Project ID / Code</label><input id="projCode" type="text" /></div>
        <div class="field"><label>Sponsor Name</label><input id="sponsor" type="text" /></div>
        <div class="field"><label>Project Manager</label><input id="pm" type="text" /></div>
        <div class="field"><label>Project Phase</label>
          <select id="phase"><option>Initiation</option><option>Discovery</option><option>Planning</option><option>Execution</option><option>Closure</option></select>
        </div>
      </div>
      <div class="grid cols-4" style="margin-top:12px">
        <div class="field"><label>Report Date</label><input id="reportDate" type="date" /></div>
        <div class="field"><label>Reporting Period (Start)</label><input id="periodStart" type="date" /></div>
        <div class="field"><label>Reporting Period (End)</label><input id="periodEnd" type="date" /></div>
      </div>
    </div>

    <!-- 2. Budget Summary (000’s) -->
    <div class="card">
      <h2>2. Budget (000’s)</h2>
      <div class="guidance">Enter values in thousands. Budget includes contingency and all <em>approved</em> change requests.</div>

      <div class="grid cols-5-tight" style="margin-top:8px">
        <div class="field">
          <label>Approved Budget</label>
          <div class="money"><span>$</span><input id="budgetApproved" type="number" min="0" step="1" placeholder="0" /></div>
        </div>
        <div class="field">
          <label>Spend to Date</label>
          <div class="money"><span>$</span><input id="budgetSpent" type="number" min="0" step="1" placeholder="0" /></div>
        </div>
        <div class="field">
          <label>Current ETC</label>
          <div class="money"><span>$</span><input id="budgetEtc" type="number" min="0" step="1" placeholder="0" /></div>
        </div>
        <div class="field">
          <label>Estimate at Completion (EAC)</label>
          <span class="pill" id="eacPill"><strong id="eacText" class="tnum">$0</strong></span>
        </div>
        <div class="field">
          <label>Variance (Approved – EAC)</label>
          <span class="pill" id="variancePill"><strong id="varianceText" class="tnum">$0</strong></span>
        </div>
      </div>

      <div class="guidance small">EAC = <strong>Spend to Date + Current ETC</strong>. Variance ≥ 0 shows as underrun, &lt; 0 as overrun.</div>
    </div>

    <!-- 3. Narrative -->
    <div class="card">
      <h2>3. Narrative</h2>
      <div class="grid cols-2-slim">
        <div class="field">
          <h3>3.1 Key Achievements This Period</h3>
          <textarea id="achText" style="min-height:180px" placeholder="Free text…"></textarea>
        </div>
        <div class="field">
          <h3>3.2 Key Activities planned for Next Period</h3>
          <textarea id="nextText" style="min-height:180px" placeholder="Free text…"></textarea>
        </div>
      </div>
    </div>

    <!-- 4. Status Summary -->
    <div class="card">
      <h2>4. Status Summary</h2>
      <div class="field" style="margin:10px 0">
        <label>Status summary</label>
        <textarea id="execSummary" placeholder="2–3 sentences on outcomes, variances, and asks."></textarea>
      </div>
      <table id="statusTable">
        <thead>
          <tr>
            <th rowspan="2">Item</th>
            <th colspan="3">Current</th>
            <th colspan="3">Previous</th>
            <th rowspan="2">Path to green / comments</th>
          </tr>
          <tr>
            <th class="th-g">Green</th><th class="th-a">Amber</th><th class="th-r">Red</th>
            <th class="th-g">Green</th><th class="th-a">Amber</th><th class="th-r">Red</th>
          </tr>
        </thead>
        <tbody id="statusTableBody"></tbody>
      </table>
      <div class="row no-print" style="margin-top:8px">
        <button class="btn filled" id="copyCurrentToPrev">Copy Current → Previous</button>
      </div>
    </div>
<!-- PSR generator - V0.26 - part 3 of 4 : filename=PSR Generator.html -->
    <!-- 5. Milestones -->
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h2>5. Milestone Status</h2>
        <button class="btn filled" id="addMilestone">Add Milestone</button>
      </div>
      <table>
        <thead>
          <tr>
            <th>Milestone</th>
            <th>Original Date</th>
            <th>Revised Date</th>
            <th>Status</th>
            <th class="center">Add to report</th>
            <th class="no-print">Actions</th>
          </tr>
        </thead>
        <tbody id="milestoneBody"></tbody>
      </table>
    </div>

    <!-- 6–7. Issues & Risks -->
    <div class="card">
      <h2>6–7. Issues & Risks</h2>
      <div class="grid cols-2">
        <div>
          <div class="row" style="justify-content:space-between;align-items:center">
            <h3>6. Significant Issues</h3>
            <button class="btn filled" id="addIssue">Add Issue</button>
          </div>
          <table>
            <thead>
              <tr>
                <th>Issue ID</th>
                <th>Issue description</th>
                <th>Impact</th>
                <th>Owner</th>
                <th>Status</th>
                <th>Next steps</th>
                <th class="center">Include</th>
              </tr>
            </thead>
            <tbody id="issueBody"></tbody>
          </table>
        </div>
        <div>
          <div class="row" style="justify-content:space-between;align-items:center">
            <h3>7. Significant Risks</h3>
            <button class="btn filled" id="addRisk">Add Risk</button>
          </div>
          <table>
            <thead>
              <tr>
                <th>Risk ID</th>
                <th>Risk description</th>
                <th>Risk rating</th>
                <th>Mitigation</th>
                <th class="center">Include</th>
              </tr>
            </thead>
            <tbody id="riskBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- 7. Decisions -->
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h2>7. Key Decisions Required</h2>
        <button class="btn filled" id="addDecision">Add Decision</button>
      </div>
      <table>
        <thead>
          <tr><th>Decision</th><th>Required By</th><th>Owner</th><th>Status</th><th class="center">Include</th><th class="no-print">Actions</th></tr>
        </thead>
        <tbody id="decisionBody"></tbody>
      </table>
    </div>

    <!-- 8. Dependencies -->
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h2>8. Dependencies & Constraints</h2>
        <button class="btn filled" id="addDep">Add Row</button>
      </div>
      <table>
        <thead>
          <tr>
            <th>Reference / ID</th>
            <th>Dependency</th>
            <th>Impact if Delayed</th>
            <th>Owner</th>
            <th>Actions</th>
            <th>Status</th>
            <th class="center">Include</th>
            <th class="no-print">Controls</th>
          </tr>
        </thead>
        <tbody id="depBody"></tbody>
      </table>
    </div>

    <!-- Report Preview -->
    <div class="card" id="reportCard">
      <!-- v0.26: mark heading row as no-print to hide on print -->
      <div class="row no-print" style="justify-content:space-between;align-items:center">
        <h2>Report Preview</h2>
        <div class="row">
          <button class="btn filled" id="jumpTopBtn">Jump to Top</button>
          <button class="btn filled" id="printBtn2">Print Report</button>
        </div>
      </div>
      <div class="guidance no-print">The preview mirrors what will print. Use the include checkboxes to curate items.</div>
      <div id="reportPreview" class="report"></div>
    </div>
  </div>
<script>
/* =========================
   PSR Generator — v0.24 JS
   (v0.26 changes limited to: theme toggle, print heading hide, status header rename,
    phase on first meta line, no-wrap variance on print, outer report box removed, 
    dark theme fixes for budget inputs/pills)
   ========================= */

const $ = (sel) => document.querySelector(sel);
const $$ = (sel) => [...document.querySelectorAll(sel)];
const fmtCurrency0 = (n) => '$' + Math.round(+n||0).toLocaleString();
const download = (filename, text, mime='text/plain') => {
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([text], {type:mime}));
  a.download = filename; a.click(); URL.revokeObjectURL(a.href);
};
const sanitizeFilename = (s) => String(s||'').trim().replace(/[\\\/:*?"<>|]+/g,'').replace(/\s+/g,'_').slice(0,120);

/* ===== Status rows ===== */
function statusRowDef(){
  return [
    {key:'overall', label:'Overall Status'},
    {key:'scope',   label:'Scope Status'},
    {key:'schedule',label:'Schedule Status'},
    {key:'budget',  label:'Budget Status'},
    {key:'quality', label:'Quality Status'},
    {key:'risk',    label:'Risk Status'},
    {key:'stake',   label:'Stakeholder Status'},
  ];
}

/* ===== Icons (SVG) ===== */
const SVG = {
  circle: (fill)=>`<span class="ico"><svg viewBox="0 0 16 16" aria-hidden="true"><circle cx="8" cy="8" r="6" fill="${fill}"/></svg></span>`,
  triangle: (fill)=>`<span class="ico"><svg viewBox="0 0 16 16" aria-hidden="true"><polygon points="8,3 14,13 2,13" fill="${fill}"/></svg></span>`,
  square: (fill)=>`<span class="ico"><svg viewBox="0 0 16 16" aria-hidden="true"><rect x="3" y="3" width="10" height="10" fill="${fill}"/></svg></span>`,
  star: (fill)=>`<span class="ico"><svg viewBox="0 0 16 16" aria-hidden="true"><path d="M8 1.5l2 4 4.5.6-3.3 3.1.9 4.6L8 11.7 3.9 13.8l.9-4.6L1.5 6.1 6 5.5l2-4z" fill="${fill}"/></svg></span>`
};
function statusIcon(code){
  const c = (code||'').toUpperCase();
  if(c==='G') return SVG.circle('#10b981');
  if(c==='A') return SVG.triangle('#f59e0b');
  if(c==='R') return SVG.square('#ef4444');
  if(c==='B') return SVG.star('#2563eb');
  return SVG.square('#9ca3af');
}
function completedIcon(){ return SVG.star('#2563eb'); }

/* ===== Section 4 table (builder) ===== */
function buildStatusTable(){
  const body = $('#statusTableBody');
  body.innerHTML = '';
  for(const row of statusRowDef()){
    const isOverall = row.key === 'overall';
    const tr = document.createElement('tr');
    tr.setAttribute('data-key', row.key);
    tr.innerHTML = `
      <td>${row.label}</td>
      ${radioTd(row.key,'current','G')}
      ${radioTd(row.key,'current','A')}
      ${radioTd(row.key,'current','R')}
      ${radioTd(row.key,'previous','G')}
      ${radioTd(row.key,'previous','A')}
      ${radioTd(row.key,'previous','R')}
      ${isOverall ? '<td></td>' :
        '<td><input data-skey="'+row.key+'" data-field="notes" type="text" placeholder="Path to green / comments" /></td>'}
    `;
    body.appendChild(tr);
  }
  body.addEventListener('change', (e)=>{
    const el = e.target;
    if(el.type === 'radio' && el.name.startsWith('current_')){
      const key = el.name.replace('current_','');
      const notes = document.querySelector(`input[data-skey="${key}"][data-field="notes"]`);
      if(!notes) return;
      if(el.value !== 'G'){ notes.classList.add('needs-comment'); if(!notes.value.trim()) notes.placeholder='Please add path to green'; }
      else { notes.classList.remove('needs-comment'); }
    }
    schedulePreview();
  });
}
function radioTd(key, section, val){
  const name = `${section}_${key}`;
  const aria = `${section} ${key} ${val}`;
  return `<td class="center"><input class="status-radio" type="radio" name="${name}" value="${val}" aria-label="${aria}"></td>`;
}
<!-- PSR generator - V0.26 - part 4 of 4 : filename=PSR Generator.html -->
/* ===== Row helpers ===== */
function rowControlsTD(){
  const td=document.createElement('td'); td.className='no-print';
  const del=document.createElement('button'); del.className='btn filled'; del.textContent='Delete';
  del.onclick=(e)=>{ e.target.closest('tr').remove(); schedulePreview(); };
  td.appendChild(del); return td;
}

/* Milestones */
function milestoneStatusSelect(value){
  const opts = ['On Track','Delayed','Not started','Completed'];
  return `<select class="ms-status">${opts.map(o=>`<option${o===value?' selected':''}>${o}</option>`).join('')}</select>`;
}
function updateMilestoneStrike(tr){
  const nameInput = tr.querySelector('td:nth-child(1) input[type="text"]');
  const statusSel = tr.querySelector('.ms-status');
  if(!nameInput || !statusSel) return;
  if(statusSel.value === 'Completed'){ nameInput.classList.add('strike'); }
  else { nameInput.classList.remove('strike'); }
}
function addMilestoneRow(v={}){ const tr=document.createElement('tr');
  tr.innerHTML=`
    <td><input type="text" value="${v.name||''}" placeholder="Milestone"></td>
    <td><input class="ms-orig" type="date" value="${v.orig||''}"></td>
    <td><input class="ms-rev" type="date" value="${v.rev||''}"></td>
    <td>${milestoneStatusSelect(v.status||'')}</td>
    <td class="center"><label class="checkbox"><input type="checkbox" class="ms-include" ${v.include===false?'':'checked'}> Include</label></td>
  `;
  tr.appendChild(rowControlsTD());
  $('#milestoneBody').appendChild(tr);

  const orig = tr.querySelector('.ms-orig');
  const rev  = tr.querySelector('.ms-rev');
  orig.addEventListener('change', ()=>{
    if(!rev.value){ rev.value = orig.value; rev.dataset.autoset = '1'; schedulePreview(); }
  });

  tr.querySelectorAll('input,select').forEach(el=>el.addEventListener('input', schedulePreview));
  updateMilestoneStrike(tr);
  tr.querySelector('.ms-status').addEventListener('change', ()=>{ updateMilestoneStrike(tr); schedulePreview(); });
}

/* Issues */
function addIssueRow(v={}){ const tr=document.createElement('tr');
  const impactSel = (val)=>`<select class="iss-impact">${['Schedule','Budget','Scope','Quality'].map(o=>`<option${o===(val||'')?' selected':''}>${o}</option>`).join('')}</select>`;
  const statusSel = (val)=>`<select class="iss-status">${[['G','Green'],['A','Amber'],['R','Red'],['B','Complete']].map(([k,l])=>`<option value="${k}"${k===(val||'')?' selected':''}>${l}</option>`).join('')}</select>`;
  tr.innerHTML=`<td><input type="text" value="${v.id||''}" placeholder="ID"></td>
                <td><input type="text" value="${v.issue||v.desc||''}" placeholder="Issue description"></td>
                <td>${impactSel(v.impact||'')}</td>
                <td><input type="text" value="${v.owner||''}" placeholder="Owner"></td>
                <td>${statusSel(v.status||'')}</td>
                <td><input type="text" value="${v.next||v['next steps']||v.notes||''}" placeholder="Next steps"></td>
                <td class="center"><input type="checkbox" class="inc" ${v.include===false?'':'checked'}></td>`;
  $('#issueBody').appendChild(tr);
  tr.querySelectorAll('input,select').forEach(el=>el.addEventListener('input', schedulePreview));
}

/* Risks */
function addRiskRow(v={}){ const tr=document.createElement('tr');
  const ratingSel = (val)=>`<select class="risk-rating">${['Critical','High','Medium','Low','Very Low'].map(o=>`<option${o===(val||'')?' selected':''}>${o}</option>`).join('')}</select>`;
  tr.innerHTML=`<td><input type="text" value="${v.id||''}" placeholder="ID"></td>
                <td><input type="text" value="${v.risk||v.desc||''}" placeholder="Risk description"></td>
                <td>${ratingSel(v.rating||'')}</td>
                <td><input type="text" value="${v.mit||''}" placeholder="Mitigation"></td>
                <td class="center"><input type="checkbox" class="inc" ${v.include===false?'':'checked'}></td>`;
  $('#riskBody').appendChild(tr);
  tr.querySelectorAll('input,select').forEach(el=>el.addEventListener('input', schedulePreview));
}

/* Decisions */
function decisionStatusSelect(value){
  const opts = ['Not started','In progress','Blocked','Deferred','Completed'];
  return `<select class="dc-status">${opts.map(o=>`<option${o===value?' selected':''}>${o}</option>`).join('')}</select>`;
}
function updateDecisionStrike(tr){
  const desc = tr.querySelector('td:nth-child(1) input[type="text"]');
  const sel  = tr.querySelector('.dc-status');
  if(!desc || !sel) return;
  if(sel.value === 'Completed'){ desc.classList.add('strike'); }
  else { desc.classList.remove('strike'); }
}
function addDecisionRow(v={}){ const tr=document.createElement('tr');
  tr.innerHTML=`<td><input type="text" value="${v.desc||''}"></td>
                <td><input type="date" value="${v.req||''}"></td>
                <td><input type="text" value="${v.owner||''}"></td>
                <td>${decisionStatusSelect(v.status||'')}</td>
                <td class="center"><input type="checkbox" class="dc-include" ${v.include===false?'':'checked'}></td>`;
  tr.appendChild(rowControlsTD());
  $('#decisionBody').appendChild(tr);
  tr.querySelectorAll('input,select').forEach(el=>el.addEventListener('input', schedulePreview));
  updateDecisionStrike(tr);
  tr.querySelector('.dc-status').addEventListener('change', ()=>{ updateDecisionStrike(tr); schedulePreview(); });
}

/* Dependencies */
function depStatusSelect(value){
  const opts = [['G','Green'],['A','Amber'],['R','Red'],['B','Blue/Complete']];
  return `<select class="dep-status">${opts.map(([k,l])=>`<option value="${k}"${k===(value||'')?' selected':''}>${l}</option>`).join('')}</select>`;
}
function updateDepStrike(tr){
  const depTxt = tr.querySelector('td:nth-child(2) input[type="text"]');
  const sel = tr.querySelector('.dep-status');
  if(!depTxt || !sel) return;
  if(sel.value === 'B'){ depTxt.classList.add('strike'); }
  else { depTxt.classList.remove('strike'); }
}
function addDepRow(v={}){ const tr=document.createElement('tr');
  tr.innerHTML=`<td><input type="text" value="${v.id||''}" placeholder="ID / REF"></td>
                <td><input type="text" value="${v.dep||''}" placeholder="Dependency"></td>
                <td><input type="text" value="${v.impact||''}" placeholder="Impact if delayed"></td>
                <td><input type="text" value="${v.owner||''}" placeholder="Owner"></td>
                <td><input type="text" value="${v.actions||''}" placeholder="Actions"></td>
                <td>${depStatusSelect(v.status||'')}</td>
                <td class="center"><input type="checkbox" class="dep-include" ${v.include===false?'':'checked'}></td>`;
  tr.appendChild(rowControlsTD());
  $('#depBody').appendChild(tr);
  tr.querySelectorAll('input,select').forEach(el=>el.addEventListener('input', schedulePreview));
  updateDepStrike(tr);
  tr.querySelector('.dep-status').addEventListener('change', ()=>{ updateDepStrike(tr); schedulePreview(); });
}

/* ===== Data extraction / injection ===== */
function getTableRows(tbody){
  const rows=[];
  tbody.querySelectorAll('tr').forEach(tr=>{
    const inputs=[...tr.querySelectorAll('input,select')];
    rows.push(inputs.map(i=>i.type==='checkbox'?i.checked:i.value));
  });
  return rows;
}

function collectData(){
  const status = {};
  for(const row of statusRowDef()){
    const cur = document.querySelector(`input[name="current_${row.key}"]:checked`);
    const prev = document.querySelector(`input[name="previous_${row.key}"]:checked`);
    const notesEl= document.querySelector(`input[data-skey="${row.key}"][data-field="notes"]`);
    const notes = notesEl ? notesEl.value.trim() : '';
    status[row.key] = {current: cur?cur.value:'', previous: prev?prev.value:'', notes};
  }

  const msRows = getTableRows($('#milestoneBody')).map(r=>({
    name:r[0], orig:r[1], rev:r[2], status:r[3], include:r[4]
  }));

  const issueRows = getTableRows($('#issueBody')).map(r=>({
    id:r[0], issue:r[1], impact:r[2], owner:r[3], status:r[4], next:r[5], include:r[6]
  }));

  const riskRows  = getTableRows($('#riskBody')).map(r=>({
    id:r[0], risk:r[1], rating:r[2], mit:r[3], include:r[4]
  }));

  const decisionRows = getTableRows($('#decisionBody')).map(r=>({
    desc:r[0], req:r[1], owner:r[2], status:r[3], include:r[4]
  }));

  const depRows = getTableRows($('#depBody')).map(r=>({
    id:r[0], dep:r[1], impact:r[2], owner:r[3], actions:r[4], status:r[5], include:r[6]
  }));

  return {
    meta:{
      projName:$('#projName').value, projCode:$('#projCode').value, sponsor:$('#sponsor').value, pm:$('#pm').value,
      reportDate:$('#reportDate').value, periodStart:$('#periodStart').value, periodEnd:$('#periodEnd').value, phase:$('#phase').value
    },
    status,
    execSummary:$('#execSummary').value,
    milestones: msRows,
    achText:$('#achText')?.value||'',
    nextText:$('#nextText')?.value||'',
    issues: issueRows,
    risks: riskRows,
    decisions: decisionRows,
    deps: depRows,
    budget:{approved:+($('#budgetApproved').value||0),spent:+($('#budgetSpent').value||0),etc:+($('#budgetEtc').value||0)}
  };
}

function populateData(d){
  $('#projName').value=d.meta?.projName||''; $('#projCode').value=d.meta?.projCode||'';
  $('#sponsor').value=d.meta?.sponsor||''; $('#pm').value=d.meta?.pm||'';
  $('#reportDate').value=d.meta?.reportDate||''; $('#periodStart').value=d.meta?.periodStart||'';
  $('#periodEnd').value=d.meta?.periodEnd||''; $('#phase').value=d.meta?.phase||'Initiation';

  for(const [k,v] of Object.entries(d.status||{})){
    const cur=document.querySelector(`input[name="current_${k}"][value="${v.current}"]`);
    const prev=document.querySelector(`input[name="previous_${k}"][value="${v.previous}"]`);
    const notes=document.querySelector(`input[data-skey="${k}"][data-field="notes"]`);
    if(cur) cur.checked=true; if(prev) prev.checked=true; if(notes && typeof v.notes==='string') notes.value=v.notes;
  }

  $('#execSummary').value=d.execSummary||'';

  const tb = $('#milestoneBody'); tb.innerHTML='';
  (d.milestones||[]).forEach(m=>addMilestoneRow(m));
  if(!d.milestones?.length) addMilestoneRow({});

  const clear=(sel)=>{const t=$(sel); t.innerHTML=''; return t;};
  clear('#issueBody'); (d.issues||[]).forEach(i=>addIssueRow(i)); if(!d.issues?.length){ for(let i=0;i<2;i++) addIssueRow({}); }
  clear('#riskBody'); (d.risks||[]).forEach(r=>addRiskRow(r)); if(!d.risks?.length){ for(let i=0;i<2;i++) addRiskRow({}); }
  clear('#decisionBody'); (d.decisions||[]).forEach(dc=>addDecisionRow(dc)); if(!d.decisions?.length) addDecisionRow({});
  clear('#depBody'); (d.deps||[]).forEach(dp=>addDepRow(dp)); if(!d.deps?.length) addDepRow({});

  $('#budgetApproved').value=d.budget?.approved??0; $('#budgetSpent').value=d.budget?.spent??0; $('#budgetEtc').value=d.budget?.etc??0;
  updateBudgetPills(); schedulePreview();
}

/* ===== CSV (summary) ===== */
function csvEscape(v){ return `"${String(v??'').replaceAll('"','""')}"`; }
function buildSummaryCsv(d){
  const lines=['Section,Field,Value'], m=d.meta, b=d.budget, push=(s,k,v)=>lines.push(`${s},${csvEscape(k)},${csvEscape(v)}`);
  push('Meta','Project Name',m.projName); push('Meta','Project Code',m.projCode);
  push('Meta','Sponsor',m.sponsor); push('Meta','Project Manager',m.pm);
  push('Meta','Report Date',m.reportDate); push('Meta','Period Start',m.periodStart);
  push('Meta','Period End',m.periodEnd); push('Meta','Project Phase',m.phase);

  for(const row of statusRowDef()){
    const s=d.status[row.key]||{};
    push('Status',`${row.label} (Current)`,s.current||'');
    push('Status',`${row.label} (Previous)`,s.previous||'');
  }
  if(d.execSummary) push('Status','Overall Project Status Summary',d.execSummary);

  (d.milestones||[]).forEach(ms=>{
    lines.push(`Milestone,${csvEscape(ms.name)},${csvEscape(JSON.stringify({orig:ms.orig,rev:ms.rev,status:ms.status,include:ms.include}))}`);
  });
  (d.issues||[]).forEach((i,idx)=>{
    lines.push(`Issue ${idx+1},${csvEscape(i.issue)},${csvEscape(JSON.stringify({id:i.id,impact:i.impact,owner:i.owner,status:i.status,next:i.next,include:i.include}))}`);
  });
  (d.risks||[]).forEach((r,idx)=>{
    lines.push(`Risk ${idx+1},${csvEscape(r.risk)},${csvEscape(JSON.stringify({id:r.id,rating:r.rating,mitigation:r.mit,include:r.include}))}`);
  });
  (d.decisions||[]).forEach((dc,idx)=>{ lines.push(`Decision ${idx+1},${csvEscape(dc.desc)},${csvEscape(JSON.stringify({requiredBy:dc.req,owner:dc.owner,status:dc.status,include:dc.include}))}`); });
  (d.deps||[]).forEach((dp,idx)=>{ lines.push(`Dependency ${idx+1},${csvEscape(dp.dep)},${csvEscape(JSON.stringify({id:dp.id,impact:dp.impact,owner:dp.owner,actions:dp.actions,status:dp.status,include:dp.include}))}`); });

  const eac = (b.spent||0) + (b.etc||0);
  push('Budget','Approved (000s)',b.approved);
  push('Budget','Spend to Date (000s)',b.spent);
  push('Budget','Current ETC (000s)',b.etc);
  push('Budget','EAC (000s)', eac);
  push('Budget','Variance (000s)', (b.approved||0) - eac);
  return lines.join('\n');
}

/* ===== Report builder ===== */
function buildReportHTML(d){
  const m=d.meta||{};
  const h=[];

  // Title & identity
  const projName = m.projName || 'Untitled Project';
  h.push(`<div class="report-section">`);
  h.push(`<h1>Project Status Report - Project ${projName}</h1>`);
  // Meta row: ID + Sponsor + PM + Phase (phase moved into first line)
  const metaBits=[];
  if(m.projCode) metaBits.push(`Project ID ${m.projCode}`);
  if(m.sponsor)  metaBits.push(`Sponsor: ${m.sponsor}`);
  if(m.pm)       metaBits.push(`Project Manager: ${m.pm}`);
  if(m.phase)    metaBits.push(`Phase: ${m.phase}`);
  if(metaBits.length){ h.push(`<div class="meta-row" style="margin-top:6px"><span>${metaBits.join('</span><span>')}</span></div>`); }
  // Second line: dates (phase removed from here)
  h.push(`<div class="meta-row"><span>Report date: ${m.reportDate || ''}</span><span>Reporting period: ${m.periodStart || ''} → ${m.periodEnd || ''}</span></div>`);
  const overall = d.status?.overall?.current || '';
  h.push(`</div>`); // end header section

  // Budget
  const eac = (d.budget?.spent||0) + (d.budget?.etc||0);
  const variance = (d.budget?.approved||0) - eac;
  const varClass = variance >= 0 ? 'ok' : 'bad';
  h.push(`<div class="report-section tight-table">`);
  h.push(`<h2>Budget Summary (000’s)</h2>
    <div class="budget-row" style="display:flex;gap:12px;flex-wrap:wrap;margin:8px 0">
      <span class="status-chip"><strong>Approved:</strong> <span class="tnum">${fmtCurrency0(d.budget?.approved||0)}</span></span>
      <span class="status-chip"><strong>Spend to Date:</strong> <span class="tnum">${fmtCurrency0(d.budget?.spent||0)}</span></span>
      <span class="status-chip"><strong>Current ETC:</strong> <span class="tnum">${fmtCurrency0(d.budget?.etc||0)}</span></span>
      <span class="pill"><strong>EAC:</strong> <span class="tnum">${fmtCurrency0(eac)}</span></span>
      <span class="pill ${varClass}" id="variancePill"><strong>Variance:</strong> <span class="tnum" id="varianceText">${fmtCurrency0(variance)}</span></span>
    </div>`);
  h.push(`</div>`);

  // Achievements & Next (side-by-side)
  if((d.achText||'').trim() || (d.nextText||'').trim()){
    h.push(`<div class="report-section split-2">`);
    h.push(`<div><h2>Key Achievements This Period</h2><p>${(d.achText||'').replace(/\n/g,'<br>')}</p></div>`);
    h.push(`<div><h2>Key Activities Next Period</h2><p>${(d.nextText||'').replace(/\n/g,'<br>')}</p></div>`);
    h.push(`</div>`);
  }

  // Overall commentary (chip)
  if((d.execSummary||'').trim()){
    const oc = (d.status?.overall?.current||'').toUpperCase();
    const ocName = ({'G':'Green','A':'Amber','R':'Red','B':'Complete'})[oc] || oc || '';
    const chipCls = ({'G':'chip-g','A':'chip-a','R':'chip-r','B':'chip-b'})[oc] || '';
    h.push(`<div class="report-section"><h2 style="display:flex;align-items:center;gap:10px">Overall Project Status Summary <span class="status-chip ${chipCls}">${statusIcon(oc)} ${ocName}</span></h2><p>${(d.execSummary||'').replace(/\n/g,'<br>')}</p></div>`);  }

  // Status + Milestones
  h.push(`<div class="report-section status-milestones">`);
  h.push(`<div><h2>Status breakdown</h2>
    <table style="width:100%;border-collapse:collapse;margin:8px 0">
      <colgroup><col style="width:55%"><col style="width:22.5%"><col style="width:22.5%"></colgroup>
      <thead><tr><th>Item</th><th>Current</th><th>Previous</th></tr></thead><tbody>`);
  for(const row of statusRowDef()){
    const s=d.status?.[row.key]||{};
    h.push(`<tr><td style="white-space:nowrap">${row.label}</td><td>${statusIcon(s.current)} ${s.current||''}</td><td>${statusIcon(s.previous)} ${s.previous||''}</td></tr>`);
  }
  h.push(`</tbody></table></div>`);

  const msShown = (d.milestones||[]).filter(ms => ms.include !== false);
  h.push(`<div>`);
  if(msShown.length){
    h.push(`<h2>Milestone Status</h2>
      <table style="width:100%;border-collapse:collapse;margin:8px 0">
        <thead><tr><th>Milestone</th><th>Original</th><th>Revised</th><th>Status</th></tr></thead><tbody>`);
    msShown.forEach(ms=>{
      const isDone = String(ms.status||'').toLowerCase()==='completed';
      const star = isDone ? `${completedIcon()} ` : '';
      const strikeClass = isDone ? 'class="strike"' : '';
      h.push(`<tr ${strikeClass}><td>${ms.name||''}</td><td>${ms.orig||''}</td><td>${ms.rev||''}</td><td>${star}${ms.status||''}</td></tr>`);
    });
    h.push(`</tbody></table>`);
  }
  h.push(`</div>`);
  h.push(`</div>`);

  // Issues & Risks
  h.push(`<div class="report-section issues-risks">`);
  const issuesIncluded = (d.issues||[]).filter(i=>i.include!==false);
  h.push(`<div>`);
  if(issuesIncluded.length){
    h.push(`<h2>Top Issues</h2>
      <table style="width:100%;border-collapse:collapse;margin:8px 0"><thead>
        <tr><th>Issue ID</th><th>Issue description</th><th>Impact</th><th>Owner</th><th>Next steps</th></tr></thead><tbody>`);
    issuesIncluded.forEach(i=>h.push(`<tr><td>${i.id||''}</td><td>${i.issue||''}</td><td>${i.impact||''}</td><td>${i.owner||''}</td><td>${i.next||''}</td></tr>`));
    h.push(`</tbody></table>`);
  }
  h.push(`</div>`);

  const risksIncluded = (d.risks||[]).filter(r=>r.include!==false);
  h.push(`<div>`);
  if(risksIncluded.length){
    h.push(`<h2>Top Risks</h2>
      <table style="width:100%;border-collapse:collapse;margin:8px 0"><thead>
        <tr><th>Risk ID</th><th>Risk description</th><th>Risk rating</th><th>Mitigation</th></tr></thead><tbody>`);
    risksIncluded.forEach(r=>h.push(`<tr><td>${r.id||''}</td><td>${r.risk||''}</td><td>${r.rating||''}</td><td>${r.mit||''}</td></tr>`));
    h.push(`</tbody></table>`);
  }
  h.push(`</div>`);
  h.push(`</div>`);

  // Decisions
  const decisionsIncluded = (d.decisions||[]).filter(dc=>dc.include!==false);
  if(decisionsIncluded.length){
    h.push(`<div class="report-section"><h2>Key Decisions</h2>
      <table style="width:100%;border-collapse:collapse;margin:8px 0"><thead>
        <tr><th>Decision</th><th>Required By</th><th>Owner</th><th>Status</th></tr></thead><tbody>`);
    decisionsIncluded.forEach(dc=>{
      const isDone = String(dc.status||'').toLowerCase()==='completed';
      const star = isDone ? `${completedIcon()} ` : '';
      h.push(`<tr><td>${dc.desc||''}</td><td>${dc.req||''}</td><td>${dc.owner||''}</td><td>${star}${dc.status||''}</td></tr>`);
    });
    h.push(`</tbody></table></div>`);
  }

  // Dependencies
  const depsIncluded = (d.deps||[]).filter(dp=>dp.include!==false);
  if(depsIncluded.length){
    h.push(`<div class="report-section"><h2>Dependencies & Constraints</h2>
      <table style="width:100%;border-collapse:collapse;margin:8px 0"><thead>
        <tr><th>ID</th><th>Dependency</th><th>Impact</th><th>Owner</th><th>Actions</th><th>Status</th></tr></thead><tbody>`);
    depsIncluded.forEach(dp=>{
      const isBlue = String(dp.status||'').toUpperCase()==='B';
      const star = isBlue ? `${completedIcon()} ` : '';
      const strike = isBlue ? 'class="strike"' : '';
      h.push(`<tr ${strike}><td>${dp.id||''}</td><td>${dp.dep||''}</td><td>${dp.impact||''}</td><td>${dp.owner||''}</td><td>${dp.actions||''}</td><td>${star}${dp.status||''}</td></tr>`);
    });
    h.push(`</tbody></table></div>`);
  }

  return h.join('');
}

function refreshPreview(){ $('#reportPreview').innerHTML = buildReportHTML(collectData()); }

/* Debounced live preview */
let previewTimer=null;
function schedulePreview(){ clearTimeout(previewTimer); previewTimer=setTimeout(refreshPreview, 120); }

/* ===== Budget pills (EAC + Variance) ===== */
function updateBudgetPills(){
  const a=+($('#budgetApproved').value||0), s=+($('#budgetSpent').value||0), e=+($('#budgetEtc').value||0);
  const eac = s+e;
  const v = a - eac;
  $('#eacText').textContent = fmtCurrency0(eac);
  const pill=$('#variancePill'); const txt=$('#varianceText');
  txt.textContent = fmtCurrency0(v);
  pill.classList.remove('ok','bad'); pill.classList.add(v>=0?'ok':'bad');
  schedulePreview();
}

/* ===== Import / Export ===== */
function saveJSON(){
  const data=collectData();
  const projName = $('#projName').value.trim();
  if(!projName){
    alert('Please enter a Project Name before saving.');
    $('#projName').focus();
    return;
  }
  const safeName = sanitizeFilename(projName);
  const datePart = data.meta.reportDate || 'undated';
  const filename = `${safeName}_status_${datePart}.json`;
  download(filename, JSON.stringify(data,null,2), 'application/json');
}
function importJSON(file){
  const reader=new FileReader();
  reader.onload=(e)=>{
    try{
      const d=JSON.parse(e.target.result);
      if(d?.status){
        for(const [k,v] of Object.entries(d.status)){
          d.status[k].previous = v.previous || v.current || '';
        }
      }
      populateData(d);
    }catch(err){ alert('Failed to parse JSON: '+err.message); }
  };
  reader.readAsText(file);
}

/* ===== Copy Current → Previous ===== */
function copyCurrentToPrevious(){
  for(const row of statusRowDef()){
    const cur = document.querySelector(`input[name="current_${row.key}"]:checked`);
    const prevVal = cur ? cur.value : '';
    const prevRadio = prevVal ? document.querySelector(`input[name="previous_${row.key}"][value="${prevVal}"]`) : null;
    if(prevRadio) prevRadio.checked = true;
    if(!prevVal){
      const checkedPrev = document.querySelector(`input[name="previous_${row.key}"]:checked`);
      if(checkedPrev) checkedPrev.checked = false;
    }
  }
  schedulePreview();
}

/* ===== Wire up ===== */
buildStatusTable();
addMilestoneRow({});
for(let i=0;i<2;i++){ addIssueRow({}); addRiskRow({}); }
addDecisionRow({}); addDepRow({});

/* Default dates + sync */
(function initDates(){
  const report = $('#reportDate'), start = $('#periodStart'), end = $('#periodEnd');
  const setTodayIfEmpty = (input)=>{
    if(!input.value){
      const t=new Date(); const m=String(t.getMonth()+1).padStart(2,'0'); const d=String(t.getDate()).padStart(2,'0');
      input.value=`${t.getFullYear()}-${m}-${d}`;
    }
  };
  setTodayIfEmpty(report);
  if(!start.value) start.value = report.value;
  if(!end.value) end.value = report.value;

  report.addEventListener('change', ()=>{
    if(!start.value || start.dataset.synced==='1'){ start.value = report.value; start.dataset.synced='1'; }
    if(!end.value || end.dataset.synced==='1'){ end.value = report.value; end.dataset.synced='1'; }
    schedulePreview();
  });
  start.addEventListener('change', ()=>{ start.dataset.synced='0'; schedulePreview(); });
  end.addEventListener('change',   ()=>{ end.dataset.synced='0';   schedulePreview(); });
})();

/* Global auto-preview */
document.body.addEventListener('input', (e)=>{ if(e.target.closest('.card')) schedulePreview(); }, {passive:true});
document.body.addEventListener('change', (e)=>{ if(e.target.closest('.card')) schedulePreview(); }, {passive:true});

/* Buttons */
$('#addMilestone').onclick=()=>addMilestoneRow({});
$('#addIssue').onclick=()=>addIssueRow({});
$('#addRisk').onclick=()=>addRiskRow({});
$('#addDecision').onclick=()=>addDecisionRow({});
$('#addDep').onclick=()=>addDepRow({});
['#budgetApproved','#budgetSpent','#budgetEtc'].forEach(id=>$(id).addEventListener('input', updateBudgetPills));
$('#printBtn').onclick=()=>{ refreshPreview(); window.print(); };
$('#printBtn2').onclick=()=>{ refreshPreview(); window.print(); };
$('#jumpTopBtn').onclick=()=>{ window.scrollTo({top:0, behavior:'smooth'}); };
$('#saveJsonBtn').onclick=saveJSON;
$('#exportCsvBtn').onclick=()=>download('summary.csv', buildSummaryCsv(collectData()), 'text/csv');
$('#importFile').addEventListener('change',(e)=>{ const f=e.target.files[0]; if(f){ $('#importName').textContent = f.name; importJSON(f); } });
$('#newBtn').onclick=()=>{ if(confirm('Clear all fields and start a new report?')) location.reload(); };
$('#copyCurrentToPrev').onclick=copyCurrentToPrevious;
$('#jumpReportBtn').onclick=()=>{ document.getElementById('reportCard')?.scrollIntoView({behavior:'smooth', block:'start'}); };

/* Initial calc + preview */
updateBudgetPills(); refreshPreview();

/* ===== v0.26 THEME TOGGLE (added) ===== */
(function(){
  const KEY='psrTheme';
  function apply(theme){ document.body.classList.toggle('dark', theme==='dark'); }
  function current(){ return document.body.classList.contains('dark') ? 'dark' : 'light'; }

  try{ if(localStorage.getItem(KEY)==='dark') apply('dark'); }catch(e){}
  const btn = document.getElementById('themeBtn');
  if(btn){
    btn.addEventListener('click', ()=>{
      const next = current()==='dark' ? 'light' : 'dark';
      apply(next);
      try{ localStorage.setItem(KEY, next); }catch(e){}
    });
  }
})();
</script>
</body>
</html>
<!-- END: PSR generator - V0.26 - part 4 of 4 -->


