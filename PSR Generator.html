<!--
Mini Change Log:
v0.24 â€“ Print: keep Budget Variance on one line; removed preview... ID row; removed 4.x numbering from Status labels. Version bump.
v0.23 â€“ Section 6: Issue Impact & Status now dropdowns; Risk Rat...h full names; Status & Milestones now equal width. Version bump.
v0.22 â€“ General: right-align numeric fields (inputs & report) wi...ort. Import label text updated. Save filename uses Project Name.
v0.21 â€“ Issues/Risks IDs + rating; larger icons; wider Item col; emphasize Overall status; removed per-item comments in report.
v0.20 â€“ Report wording/ordering updates; jump-to-report; print-only shows report.
v0.19 â€“ Initial canvas build.
-->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Project Status Report â€” v0.25</title>
<style>
  :root{
    --bg:#ffffff; --card:#ffffff; --border:#e5e7eb;
    --text:#111827; --text-dim:#4b5563;
    --g:#10b981; --a:#f59e0b; --r:#ef4444; --b:#2563eb;
    --g-tint: rgba(16,185,129,.14);
    --a-tint: rgba(245,158,11,.16);
    --r-tint: rgba(239,68,68,.14);
    --shadow: 0 6px 24px rgba(0,0,0,.08), 0 2px 8px rgba(0,0,0,.06);
    --chip:#f8fafc;
    --btn:#2563eb; --btn-text:#ffffff; --btn-hover:#1d4ed8;
    --btn-alt:#10b981; --btn-alt-hover:#059669;
  }
  *{box-sizing:border-box}
  body{margin:0;background:#f8fafc;color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;line-height:1.45}
  h1,h2,h3{margin:0 0 .5rem}
  h2{font-size:1.1rem;font-weight:700}
  h3{font-size:1rem;color:var(--text-dim);font-weight:600}
  .container{max-width:1200px;margin:0 auto;padding:24px}
  .grid{display:grid;gap:16px}
  .cols-2{grid-template-columns:1fr 1fr}
  .cols-2-slim{grid-template-columns:1fr 1fr}
  .cols-4{grid-template-columns:repeat(4,1fr)}
  .cols-5-tight{grid-template-columns:repeat(5,minmax(0,1fr))}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:16px;margin-bottom:12px}
  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .toolbar .spacer{flex:1}
  .field{display:flex;flex-direction:column;gap:6px}
  label{font-size:.85rem;color:var(--text-dim)}
  input[type="text"],input[type="date"],input[type="number"],select,textarea{
    width:100%;border:1px solid var(--border);background:#fff;color:var(--text);border-radius:12px;padding:10px 12px
  }
  textarea{min-height:80px}
  table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--border);border-radius:14px;overflow:hidden}
  th,td{border-bottom:1px solid var(--border);padding:10px;background:#fff}
  th{background:#f8fafc;font-weight:700;text-align:left}
  tr:last-child td{border-bottom:none}

  .hint,.guidance{font-size:.9rem;color:#6b7280}
  .guidance{font-style:italic;background:#fff;border:0;border-left:3px solid #e5e7eb;border-radius:0;padding:8px 12px;margin:6px 0 10px}

  .money{display:flex;align-items:center;border:1px solid var(--border);border-radius:10px;background:#fff}
  .money > span{display:inline-block;padding:10px 10px;border-right:1px solid var(--border);color:#6b7280}
  .money > input{border:0;flex:1;padding-left:10px}

  /* NUMBER ALIGNMENT (General) */
  input[type=number]{ -moz-appearance:textfield; text-align:right; font-variant-numeric: tabular-nums; }
  input[type=number]::-webkit-outer-spin-button,
  input[type=number]::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0; }
  .tnum{ font-variant-numeric: tabular-nums; }

  .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);border-radius:999px;padding:8px 12px;background:var(--chip)}
  .pill.ok{border-color:#166534;background:rgba(22,163,74,.08)}
  .pill.warn{border-color:#a16207;background:rgba(245,158,11,.10)}
  .pill.bad{border-color:#991b1b;background:rgba(239,68,68,.08)}
  .pill.blue{border-color:#1e40af;background:rgba(37,99,235,.10)}

  .budget-row{display:flex;flex-wrap:wrap;gap:10px;margin-top:8px}

  .status-chip{display:inline-flex;align-items:center;gap:10px;border:1px solid var(--border);border-radius:999px;padding:10px 14px;font-weight:700;font-size:1.05rem}
  .chip-g{background:rgba(16,185,129,.12);border-color:#10b981;color:#065f46}
  .chip-a{background:rgba(245,158,11,.14);border-color:#f59e0b;color:#92400e}
  .chip-r{background:rgba(239,68,68,.12);border-color:#ef4444;color:#7f1d1d}
  .chip-b{background:rgba(37,99,235,.12);border-color:#2563eb;color:#1e3a8a}

  .report{background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.08);padding:20px}
  .report-section{border:1px solid #e5e7eb;border-radius:12px;padding:14px;margin:12px 0}
  .split-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .status-milestones{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .issues-risks{display:grid;grid-template-columns:1fr 1fr;gap:12px}

  .btn{appearance:none;border:1px solid var(--border);background:var(--btn);color:var(--btn-text);padding:9px 12px;border-radius:12px;font-weight:600;cursor:pointer}
  .btn:hover{background:var(--btn-hover)}
  .btn.alt{background:var(--btn-alt)}
  .btn.alt:hover{background:var(--btn-alt-hover)}
  .btn.ghost{background:transparent;color:var(--text);border-color:var(--border)}

  @media print{
    .no-print{display:none !important}
    .card{display:none !important}
    #reportCard{display:block !important}
    #reportCard .report{box-shadow:none;border:none}
    .container{padding:0}
    th,td{background:#fff;border-color:#ddd}
    .budget-row{flex-wrap:nowrap} /* keep in one row on print */
  }

  .report{background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.08);padding:20px}
  .report-section{border:1px solid #e5e7eb;border-radius:12px;padding:14px;margin:12px 0}
  .split-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .status-milestones{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .issues-risks{display:grid;grid-template-columns:1fr 1fr;gap:12px}

  /* === Dark Theme (scoped) === */
  body.dark{ background:#0b1220; color:#e5e7eb; }
  body.dark .card, body.dark table th, body.dark table td, body.dark .report{ background:#0f172a; }
  body.dark .card, body.dark table, body.dark th, body.dark td, body.dark .report, body.dark .report-section{ border-color:#1e293b !important; }
  body.dark input[type="text"], body.dark input[type="date"], body.dark input[type="number"], body.dark select, body.dark textarea{
    background:#0b1220; color:#e5e7eb; border-color:#243244;
  }
  body.dark .guidance{ background:#0f172a; color:#94a3b8; border-left-color:#334155; }
  body.dark .btn{ border-color:#334155; }

  /* === Print tighten: Budget Variance never wraps === */
  @media print{
    .budget-row{flex-wrap:nowrap; gap:8px}
    .budget-row .pill, .budget-row .status-chip{white-space:nowrap}
    .budget-row strong{margin-right:4px}
  }

  /* === Print: Risks truncation fix (no page-break inside; stack columns) === */
  .report-section table, .report-section tr, .report-section td, .report-section th{ break-inside: avoid; page-break-inside: avoid; }
  @media print{
    .issues-risks{ grid-template-columns:1fr !important; }
  }
</style>
</head>
<body>
<div class="container">
  <div class="toolbar no-print" style="margin-top:8px">
        <button class="btn" id="themeToggle" title="Toggle light/dark theme">ðŸŒ— Theme</button>
        <button class="btn filled" id="newBtn">New</button>

        <label class="btn filled" for="importFile" id="importLabel">Import save data
          <input id="importFile" type="file" accept="application/json" style="display:none" />
        </label>

        <button class="btn" id="saveBtn">Save JSON</button>
        <button class="btn alt" id="exportBtn">Export CSV (Summary)</button>
        <div class="spacer"></div>
        <button class="btn ghost" id="jumpReportBtn">Jump to Report</button>
        <button class="btn" id="printBtn">Print Report</button>
        <span class="pill">v0.25</span>
  </div>

  <div class="card no-print">
    <h2>Base Project Information</h2>
    <div class="grid cols-4">
      <div class="field"><label>Project Name</label><input id="projectName" type="text" placeholder="e.g., Core Banking Upgrade"/></div>
      <div class="field"><label>Project ID</label><input id="projectId" type="text" placeholder="e.g., PRJ-042"/></div>
      <div class="field"><label>Sponsor</label><input id="sponsor" type="text"/></div>
      <div class="field"><label>Project Manager</label><input id="pm" type="text"/></div>
      <div class="field"><label>Phase</label><input id="phase" type="text" placeholder="e.g., Execution"/></div>
      <div class="field"><label>Report Date</label><input id="reportDate" type="date"/></div>
      <div class="field"><label>Reporting Period</label><input id="reportPeriod" type="text" placeholder="e.g., 4â€“10 Aug 2025"/></div>
    </div>
  </div>

  <div class="card no-print">
    <h2>Budget (000â€™s)</h2>
    <div class="grid cols-4">
      <div class="field"><label>Approved</label><input type="number" id="budgetApproved" value="0"/></div>
      <div class="field"><label>Spent</label><input type="number" id="budgetSpent" value="0"/></div>
      <div class="field"><label>ETC</label><input type="number" id="budgetETC" value="0"/></div>
      <div class="field"><label>Variance (auto)</label><input type="text" id="budgetVariance" disabled/></div>
    </div>
    <div class="budget-row">
      <span class="pill"><strong>Approved</strong> <span class="tnum" id="pillApproved">0</span></span>
      <span class="pill"><strong>Spent</strong> <span class="tnum" id="pillSpent">0</span></span>
      <span class="pill"><strong>ETC</strong> <span class="tnum" id="pillETC">0</span></span>
      <span class="pill"><strong>EAC</strong> <span class="tnum" id="pillEAC">0</span></span>
      <span class="pill"><strong>Variance</strong> <span class="tnum" id="pillVariance">0</span></span>
    </div>
    <div class="hint">Numbers shown in thousands (000â€™s); EAC = Spent + ETC; Variance = Approved â€“ EAC.</div>
  </div>

  <div class="card no-print">
    <h2>Narrative</h2>
    <div class="grid cols-2">
      <div class="field"><label>Key achievements</label><textarea id="achievements"></textarea></div>
      <div class="field"><label>Next period activities</label><textarea id="nextActivities"></textarea></div>
    </div>
  </div>

  <div class="card no-print">
    <h2>Status Summary</h2>
    <div class="grid cols-2-slim">
      <table>
        <thead><tr><th>Area</th><th>Current</th><th>Previous</th><th>Notes</th></tr></thead>
        <tbody id="statusBody"></tbody>
      </table>
      <div>
        <div class="guidance">Use <em>Copy Current â†’ Previous</em> to roll last weekâ€™s status forward.</div>
        <button class="btn" id="copyCurrentToPrev">Copy Current â†’ Previous</button>
      </div>
    </div>
  </div>

  <div class="card no-print">
    <h2>Milestones</h2>
    <table id="milestonesTable">
      <thead><tr><th>Milestone</th><th>Date</th><th>Status</th><th>Include</th><th></th></tr></thead>
      <tbody></tbody>
    </table>
    <div class="toolbar" style="margin-top:8px"><button class="btn" id="addMilestone">Add Milestone</button></div>
  </div>

  <div class="grid split-2 no-print">
    <div class="card">
      <h2>Issues</h2>
      <table id="issuesTable">
        <thead><tr><th>ID</th><th>Description</th><th>Impact</th><th>Owner</th><th>Status</th><th>Next Steps</th><th>Include</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="toolbar" style="margin-top:8px"><button class="btn" id="addIssue">Add Issue</button></div>
    </div>
    <div class="card">
      <h2>Risks</h2>
      <table id="risksTable">
        <thead><tr><th>ID</th><th>Description</th><th>Rating</th><th>Mitigation</th><th>Include</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="toolbar" style="margin-top:8px"><button class="btn" id="addRisk">Add Risk</button></div>
    </div>
  </div>

  <div class="card no-print">
    <h2>Decisions</h2>
    <table id="decisionsTable">
      <thead><tr><th>Decision</th><th>Required By</th><th>Owner</th><th>Status</th><th>Include</th><th></th></tr></thead>
    <tbody></tbody></table>
    <div class="toolbar" style="margin-top:8px"><button class="btn" id="addDecision">Add Decision</button></div>
  </div>

  <div class="card no-print">
    <h2>Dependencies & Constraints</h2>
    <table id="depsTable">
      <thead><tr><th>Ref/ID</th><th>Dependency</th><th>Impact</th><th>Owner</th><th>Actions</th><th>Status</th><th>Include</th><th></th></tr></thead>
      <tbody></tbody>
    </table>
    <div class="toolbar" style="margin-top:8px"><button class="btn" id="addDep">Add Dependency</button></div>
  </div>

  <div class="toolbar no-print" style="margin-top:8px">
    <div class="spacer"></div>
    <span class="pill">Report preview â€” print shows only the report</span>
  </div>

  <div id="reportCard" class="report no-print">
    <h1>Project Status Report â€“ Project <span id="rProjectName"></span></h1>
    <div><span id="rProjectId"></span> â€¢ <span id="rSponsor"></span> â€¢ <span id="rPM"></span></div>
    <div style="margin-top:4px"><span id="rReportDate"></span> â€¢ <span id="rReportPeriod"></span> â€¢ <span id="rPhase"></span></div>

    <div style="margin-top:10px" class="budget-row">
      <span class="pill"><strong>Approved</strong> <span class="tnum" id="rApproved"></span></span>
      <span class="pill"><strong>Spent</strong> <span class="tnum" id="rSpent"></span></span>
      <span class="pill"><strong>ETC</strong> <span class="tnum" id="rETC"></span></span>
      <span class="pill"><strong>EAC</strong> <span class="tnum" id="rEAC"></span></span>
      <span class="pill"><strong>Variance</strong> <span class="tnum" id="rVariance"></span></span>
    </div>

    <h2 style="margin-top:12px">Overall Project Status</h2>
    <div class="status-chip chip-g" id="rOverallChip"><span id="rOverallIcon">ðŸŸ¢</span><span id="rOverallText">Green</span></div>

    <div class="status-milestones" style="margin-top:12px">
      <div>
        <h3>Status (detail)</h3>
        <div class="report-section">
          <table>
            <thead><tr><th>Area</th><th>Current</th><th>Previous</th><th>Notes</th></tr></thead>
            <tbody id="rStatusBody"></tbody>
          </table>
        </div>
      </div>
      <div>
        <h3>Milestones</h3>
        <div class="report-section">
          <table>
            <thead><tr><th>Milestone</th><th>Date</th><th>Status</th></tr></thead>
            <tbody id="rMilestones"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="issues-risks" style="margin-top:12px">
      <div>
        <h3>Issues</h3>
        <div class="report-section">
          <table>
            <thead><tr><th>ID</th><th>Description</th><th>Impact</th><th>Owner</th><th>Status</th><th>Next Steps</th></tr></thead>
            <tbody id="rIssues"></tbody>
          </table>
        </div>
      </div>
      <div>
        <h3>Risks</h3>
        <div class="report-section">
          <table>
            <thead><tr><th>ID</th><th>Description</th><th>Rating</th><th>Mitigation</th></tr></thead>
            <tbody id="rRisks"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div style="margin-top:12px">
      <h3>Decisions</h3>
      <div class="report-section">
        <table>
          <thead><tr><th>Decision</th><th>Required By</th><th>Owner</th><th>Status</th></tr></thead>
          <tbody id="rDecisions"></tbody>
        </table>
      </div>
    </div>

    <div style="margin-top:12px">
      <h3>Dependencies & Constraints</h3>
      <div class="report-section">
        <table>
          <thead><tr><th>Ref/ID</th><th>Dependency</th><th>Impact</th><th>Owner</th><th>Actions</th><th>Status</th></tr></thead>
          <tbody id="rDeps"></tbody>
        </table>
      </div>
    </div>

  </div>
</div>

<script>
const $=sel=>document.querySelector(sel);
const $$=sel=>Array.from(document.querySelectorAll(sel));

const statusAreas=["Overall","Scope","Schedule","Budget","Quality","Risk","Stakeholder"];
const rag=["Green","Amber","Red","Blue"];

const statusSelect=(id)=>`<select data-id="${id}" class="rag">${rag.map(r=>`<option value="${r}">${r}</option>`).join('')}</select>`;

function addRow(tbody, cells){
  const tr=document.createElement('tr');
  cells.forEach(html=>{const td=document.createElement('td');td.innerHTML=html;tr.appendChild(td)});
  tbody.appendChild(tr);
}

function initStatus(){
  const body=$('#statusBody');
  body.innerHTML='';
  statusAreas.forEach(a=>{
    addRow(body,[`<strong>${a}</strong>`,statusSelect(`${a}-current`),statusSelect(`${a}-prev`),`<input type="text" placeholder="Notes"/>`])
  })
}

function addMilestoneRow(){
  addRow($('#milestonesTable tbody'),[
    `<input type="text" placeholder="Milestone"/>`,
    `<input type="date"/>`,
    `<select><option>Not Started</option><option>On Track</option><option>At Risk</option><option>Complete</option></select>`,
    `<input type="checkbox" checked/>`,
    `<button class="btn ghost del">Remove</button>`
  ])
}
function addIssueRow(){
  addRow($('#issuesTable tbody'),[
    `<input type="text" placeholder="ID" style="max-width:80px"/>`,
    `<input type="text" placeholder="Description"/>`,
    `<select><option>Schedule</option><option>Budget</option><option>Scope</option><option>Quality</option></select>`,
    `<input type="text" placeholder="Owner"/>`,
    `<select><option>Open</option><option>In Progress</option><option>Closed</option></select>`,
    `<input type="text" placeholder="Next steps"/>`,
    `<input type="checkbox" checked/>`,
    `<button class="btn ghost del">Remove</button>`
  ])
}
function addRiskRow(){
  addRow($('#risksTable tbody'),[
    `<input type="text" placeholder="ID" style="max-width:80px"/>`,
    `<input type="text" placeholder="Description"/>`,
    `<select><option>1 (VL)</option><option>2 (L)</option><option>3 (M)</option><option>4 (H)</option><option>5 (C)</option></select>`,
    `<input type="text" placeholder="Mitigation"/>`,
    `<input type="checkbox" checked/>`,
    `<button class="btn ghost del">Remove</button>`
  ])
}
function addDecisionRow(){
  addRow($('#decisionsTable tbody'),[
    `<input type="text" placeholder="Decision"/>`,
    `<input type="date"/>`,
    `<input type="text" placeholder="Owner"/>`,
    `<select><option>Open</option><option>In Progress</option><option>Closed</option></select>`,
    `<input type="checkbox" checked/>`,
    `<button class="btn ghost del">Remove</button>`
  ])
}
function addDepRow(){
  addRow($('#depsTable tbody'),[
    `<input type="text" placeholder="Ref/ID" style="max-width:100px"/>`,
    `<input type="text" placeholder="Dependency"/>`,
    `<input type="text" placeholder="Impact"/>`,
    `<input type="text" placeholder="Owner"/>`,
    `<input type="text" placeholder="Actions"/>`,
    `<select><option>Open</option><option>In Progress</option><option>Closed</option></select>`,
    `<input type="checkbox" checked/>`,
    `<button class="btn ghost del">Remove</button>`
  ])
}

function tnum(n){return Number(n||0).toLocaleString()}
function updateBudgetPills(){
  const a=+$('#budgetApproved').value||0;
  const s=+$('#budgetSpent').value||0;
  const e=+$('#budgetETC').value||0;
  const eac=s+e;
  const varc=a-(s+e);
  $('#budgetVariance').value=tnum(varc);
  $('#pillApproved').textContent=tnum(a);
  $('#pillSpent').textContent=tnum(s);
  $('#pillETC').textContent=tnum(e);
  $('#pillEAC').textContent=tnum(eac);
  $('#pillVariance').textContent=tnum(varc);
}

function refreshPreview(){
  $('#rProjectName').textContent=$('#projectName').value||'[Project Name]';
  $('#rProjectId').textContent=$('#projectId').value||'ID â€”';
  $('#rSponsor').textContent=$('#sponsor').value||'Sponsor â€”';
  $('#rPM').textContent=$('#pm').value||'PM â€”';
  $('#rPhase').textContent=$('#phase').value||'Phase â€”';
  $('#rReportDate').textContent=$('#reportDate').value||'Report Date â€”';
  $('#rReportPeriod').textContent=$('#reportPeriod').value||'Reporting Period â€”';

  const rBody=$('#rStatusBody');
  rBody.innerHTML='';
  $$('#statusBody tr').forEach(tr=>{
    const area=tr.children[0].innerText;
    const cur=tr.children[1].querySelector('select').value;
    const prev=tr.children[2].querySelector('select').value;
    const notes=tr.children[3].querySelector('input').value;
    addRow(rBody,[`<strong>${area}</strong>`,cur,prev,notes]);
  });

  const rM=$('#rMilestones'); rM.innerHTML='';
  $$('#milestonesTable tbody tr').forEach(tr=>{
    const inc=tr.children[3].querySelector('input[type="checkbox"]').checked;
    if(!inc) return;
    const name=tr.children[0].querySelector('input').value;
    const date=tr.children[1].querySelector('input').value;
    const status=tr.children[2].querySelector('select').value;
    addRow(rM,[name,date,status]);
  });

  const rI=$('#rIssues'); rI.innerHTML='';
  $$('#issuesTable tbody tr').forEach(tr=>{
    const inc=tr.children[6].querySelector('input[type="checkbox"]').checked;
    if(!inc) return;
    const id=tr.children[0].querySelector('input').value;
    const desc=tr.children[1].querySelector('input').value;
    const impact=tr.children[2].querySelector('select').value;
    const owner=tr.children[3].querySelector('input').value;
    const status=tr.children[4].querySelector('select').value;
    const next=tr.children[5].querySelector('input').value;
    addRow(rI,[id,desc,impact,owner,status,next]);
  });

  const rR=$('#rRisks'); rR.innerHTML='';
  $$('#risksTable tbody tr').forEach(tr=>{
    const inc=tr.children[4].querySelector('input[type="checkbox"]').checked;
    if(!inc) return;
    const id=tr.children[0].querySelector('input').value;
    const desc=tr.children[1].querySelector('input').value;
    const rating=tr.children[2].querySelector('select').value;
    const mit=tr.children[3].querySelector('input').value;
    addRow(rR,[id,desc,rating,mit]);
  });

  const rD=$('#rDecisions'); rD.innerHTML='';
  $$('#decisionsTable tbody tr').forEach(tr=>{
    const inc=tr.children[4].querySelector('input[type="checkbox"]').checked;
    if(!inc) return;
    const dec=tr.children[0].querySelector('input').value;
    const req=tr.children[1].querySelector('input').value;
    const owner=tr.children[2].querySelector('input').value;
    const status=tr.children[3].querySelector('select').value;
    addRow(rD,[dec,req,owner,status]);
  });

  const rDep=$('#rDeps'); rDep.innerHTML='';
  $$('#depsTable tbody tr').forEach(tr=>{
    const inc=tr.children[6].querySelector('input[type="checkbox"]').checked;
    if(!inc) return;
    const ref=tr.children[0].querySelector('input').value;
    const dep=tr.children[1].querySelector('input').value;
    const impact=tr.children[2].querySelector('input').value;
    const owner=tr.children[3].querySelector('input').value;
    const actions=tr.children[4].querySelector('input').value;
    const status=tr.children[5].querySelector('select').value;
    addRow(rDep,[ref,dep,impact,owner,actions,status]);
  });

  // Overall chip (from Current Overall)
  const currentOverall = $$('#statusBody tr')[0].children[1].querySelector('select').value;
  const icon = {Green:'ðŸŸ¢',Amber:'ðŸŸ ',Red:'ðŸ”´',Blue:'ðŸ”µ'}[currentOverall]||'â¬¤';
  $('#rOverallIcon').textContent=icon;
  $('#rOverallText').textContent=currentOverall;
}

function saveJSON(){
  const data={
    projectName:$('#projectName').value,projectId:$('#projectId').value,sponsor:$('#sponsor').value,pm:$('#pm').value,phase:$('#phase').value,reportDate:$('#reportDate').value,reportPeriod:$('#reportPeriod').value,
    budget:{approved:+$('#budgetApproved').value||0,spent:+$('#budgetSpent').value||0,etc:+$('#budgetETC').value||0},
    status:$$('#statusBody tr').map(tr=>({area:tr.children[0].innerText,current:tr.children[1].querySelector('select').value,previous:tr.children[2].querySelector('select').value,notes:tr.children[3].querySelector('input').value})),
    milestones:$$('#milestonesTable tbody tr').map(tr=>({name:tr.children[0].querySelector('input').value,date:tr.children[1].querySelector('input').value,status:tr.children[2].querySelector('select').value,include:tr.children[3].querySelector('input[type="checkbox"]').checked})),
    issues:$$('#issuesTable tbody tr').map(tr=>({id:tr.children[0].querySelector('input').value,desc:tr.children[1].querySelector('input').value,impact:tr.children[2].querySelector('select').value,owner:tr.children[3].querySelector('input').value,status:tr.children[4].querySelector('select').value,next:tr.children[5].querySelector('input').value,include:tr.children[6].querySelector('input[type="checkbox"]').checked})),
    risks:$$('#risksTable tbody tr').map(tr=>({id:tr.children[0].querySelector('input').value,desc:tr.children[1].querySelector('input').value,rating:tr.children[2].querySelector('select').value,mit:tr.children[3].querySelector('input').value,include:tr.children[4].querySelector('input[type="checkbox"]').checked})),
    decisions:$$('#decisionsTable tbody tr').map(tr=>({decision:tr.children[0].querySelector('input').value,required:tr.children[1].querySelector('input').value,owner:tr.children[2].querySelector('input').value,status:tr.children[3].querySelector('select').value,include:tr.children[4].querySelector('input[type="checkbox"]').checked})),
    deps:$$('#depsTable tbody tr').map(tr=>({ref:tr.children[0].querySelector('input').value,dep:tr.children[1].querySelector('input').value,impact:tr.children[2].querySelector('input').value,owner:tr.children[3].querySelector('input').value,actions:tr.children[4].querySelector('input').value,status:tr.children[5].querySelector('select').value,include:tr.children[6].querySelector('input[type="checkbox"]').checked}))
  };
  const name=$('#projectName').value?.trim()||prompt('Filename (uses Project Name if set):','psr_data');
  if(!name) return;
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=`${name}.json`;
  a.click();
}

function exportCSV(){
  const esc=s=>`"${String(s||'').replace(/"/g,'""')}"`;
  const lines=[];
  lines.push(['Project Name','Project ID','Sponsor','PM','Phase','Report Date','Reporting Period','Approved','Spent','ETC','EAC','Variance'].map(esc).join(','));
  const approved=+$('#budgetApproved').value||0, spent=+$('#budgetSpent').value||0, etc=+$('#budgetETC').value||0, eac=spent+etc, variance=approved-eac;
  lines.push([$('#projectName').value,$('#projectId').value,$('#sponsor').value,$('#pm').value,$('#phase').value,$('#reportDate').value,$('#reportPeriod').value,approved,spent,etc,eac,variance].map(esc).join(','));

  lines.push('
Status');
  lines.push(['Area','Current','Previous','Notes'].map(esc).join(','));
  $$('#statusBody tr').forEach(tr=>{
    lines.push([tr.children[0].innerText,tr.children[1].querySelector('select').value,tr.children[2].querySelector('select').value,tr.children[3].querySelector('input').value].map(esc).join(','))
  });

  lines.push('
Milestones');
  lines.push(['Milestone','Date','Status','Include'].map(esc).join(','));
  $$('#milestonesTable tbody tr').forEach(tr=>{
    lines.push([
      tr.children[0].querySelector('input').value,
      tr.children[1].querySelector('input').value,
      tr.children[2].querySelector('select').value,
      tr.children[3].querySelector('input[type="checkbox"]').checked
    ].map(esc).join(','))
  })

  lines.push('
Issues');
  lines.push(['ID','Description','Impact','Owner','Status','Next Steps','Include'].map(esc).join(','));
  $$('#issuesTable tbody tr').forEach(tr=>{
    lines.push([
      tr.children[0].querySelector('input').value,
      tr.children[1].querySelector('input').value,
      tr.children[2].querySelector('select').value,
      tr.children[3].querySelector('input').value,
      tr.children[4].querySelector('select').value,
      tr.children[5].querySelector('input').value,
      tr.children[6].querySelector('input[type="checkbox"]').checked
    ].map(esc).join(','))
  })

  lines.push('
Risks');
  lines.push(['ID','Description','Rating','Mitigation','Include'].map(esc).join(','));
  $$('#risksTable tbody tr').forEach(tr=>{
    lines.push([
      tr.children[0].querySelector('input').value,
      tr.children[1].querySelector('input').value,
      tr.children[2].querySelector('select').value,
      tr.children[3].querySelector('input').value,
      tr.children[4].querySelector('input[type="checkbox"]').checked
    ].map(esc).join(','))
  })

  lines.push('
Decisions');
  lines.push(['Decision','Required By','Owner','Status','Include'].map(esc).join(','));
  $$('#decisionsTable tbody tr').forEach(tr=>{
    lines.push([
      tr.children[0].querySelector('input').value,
      tr.children[1].querySelector('input').value,
      tr.children[2].querySelector('input').value,
      tr.children[3].querySelector('select').value,
      tr.children[4].querySelector('input[type="checkbox"]').checked
    ].map(esc).join(','))
  })

  lines.push('
Dependencies & Constraints');
  lines.push(['Ref/ID','Dependency','Impact','Owner','Actions','Status','Include'].map(esc).join(','));
  $$('#depsTable tbody tr').forEach(tr=>{
    lines.push([
      tr.children[0].querySelector('input').value,
      tr.children[1].querySelector('input').value,
      tr.children[2].querySelector('input').value,
      tr.children[3].querySelector('input').value,
      tr.children[4].querySelector('input').value,
      tr.children[5].querySelector('select').value,
      tr.children[6].querySelector('input[type="checkbox"]').checked
    ].map(esc).join(','))
  })

  const blob=new Blob([lines.join('
')],{type:'text/csv'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=($('#projectName').value||'psr_summary')+`.csv`;
  a.click();
}

function attachDelHandlers(){
  $$('.del').forEach(btn=>btn.onclick=()=>btn.closest('tr').remove());
}

function wireTables(){
  $('#addMilestone').onclick=()=>{addMilestoneRow();attachDelHandlers()}
  $('#addIssue').onclick=()=>{addIssueRow();attachDelHandlers()}
  $('#addRisk').onclick=()=>{addRiskRow();attachDelHandlers()}
  $('#addDecision').onclick=()=>{addDecisionRow();attachDelHandlers()}
  $('#addDep').onclick=()=>{addDepRow();attachDelHandlers()}
}

function loadJSON(file){
  const r=new FileReader();
  r.onload=()=>{
    const d=JSON.parse(r.result);
    $('#projectName').value=d.projectName||'';$('#projectId').value=d.projectId||'';$('#sponsor').value=d.sponsor||'';$('#pm').value=d.pm||'';$('#phase').value=d.phase||'';$('#reportDate').value=d.reportDate||'';$('#reportPeriod').value=d.reportPeriod||'';

    $('#budgetApproved').value=d.budget?.approved||0;$('#budgetSpent').value=d.budget?.spent||0;$('#budgetETC').value=d.budget?.etc||0;updateBudgetPills();

    initStatus();
    if(Array.isArray(d.status)){
      d.status.forEach((s,i)=>{
        const tr=$$('#statusBody tr')[i];
        if(!tr) return;
        tr.children[1].querySelector('select').value=s.current||'Green';
        tr.children[2].querySelector('select').value=s.previous||'Green';
        tr.children[3].querySelector('input').value=s.notes||'';
      })
    }

    $('#milestonesTable tbody').innerHTML='';
    (d.milestones||[]).forEach(m=>{addMilestoneRow();const tr=$$('#milestonesTable tbody tr').pop();
      tr.children[0].querySelector('input').value=m.name||'';
      tr.children[1].querySelector('input').value=m.date||'';
      tr.children[2].querySelector('select').value=m.status||'Not Started';
      tr.children[3].querySelector('input[type="checkbox"]').checked=!!m.include;
    });

    $('#issuesTable tbody').innerHTML='';
    (d.issues||[]).forEach(it=>{addIssueRow();const tr=$$('#issuesTable tbody tr').pop();
      tr.children[0].querySelector('input').value=it.id||'';
      tr.children[1].querySelector('input').value=it.desc||'';
      tr.children[2].querySelector('select').value=it.impact||'Schedule';
      tr.children[3].querySelector('input').value=it.owner||'';
      tr.children[4].querySelector('select').value=it.status||'Open';
      tr.children[5].querySelector('input').value=it.next||'';
      tr.children[6].querySelector('input[type="checkbox"]').checked=!!it.include;
    });

    $('#risksTable tbody').innerHTML='';
    (d.risks||[]).forEach(r=>{addRiskRow();const tr=$$('#risksTable tbody tr').pop();
      tr.children[0].querySelector('input').value=r.id||'';
      tr.children[1].querySelector('input').value=r.desc||'';
      tr.children[2].querySelector('select').value=r.rating||'3 (M)';
      tr.children[3].querySelector('input').value=r.mit||'';
      tr.children[4].querySelector('input[type="checkbox"]').checked=!!r.include;
    });

    $('#decisionsTable tbody').innerHTML='';
    (d.decisions||[]).forEach(dd=>{addDecisionRow();const tr=$$('#decisionsTable tbody tr').pop();
      tr.children[0].querySelector('input').value=dd.decision||'';
      tr.children[1].querySelector('input').value=dd.required||'';
      tr.children[2].querySelector('input').value=dd.owner||'';
      tr.children[3].querySelector('select').value=dd.status||'Open';
      tr.children[4].querySelector('input[type="checkbox"]').checked=!!dd.include;
    });

    $('#depsTable tbody').innerHTML='';
    (d.deps||[]).forEach(dp=>{addDepRow();const tr=$$('#depsTable tbody tr').pop();
      tr.children[0].querySelector('input').value=dp.ref||'';
      tr.children[1].querySelector('input').value=dp.dep||'';
      tr.children[2].querySelector('input').value=dp.impact||'';
      tr.children[3].querySelector('input').value=dp.owner||'';
      tr.children[4].querySelector('input').value=dp.actions||'';
      tr.children[5].querySelector('select').value=dp.status||'Open';
      tr.children[6].querySelector('input[type="checkbox"]').checked=!!dp.include;
    });

    refreshPreview();
  };
  r.readAsText(file);
}

function copyCurrentToPrevious(){
  $$('#statusBody tr').forEach(tr=>{
    tr.children[2].querySelector('select').value=tr.children[1].querySelector('select').value;
  });
  refreshPreview();
}

function init(){
  initStatus();
  wireTables();
  $('#budgetApproved').addEventListener('input',updateBudgetPills);
  $('#budgetSpent').addEventListener('input',updateBudgetPills);
  $('#budgetETC').addEventListener('input',updateBudgetPills);
  $$('#statusBody, #milestonesTable, #issuesTable, #risksTable, #decisionsTable, #depsTable').forEach(el=>{
    el.addEventListener('input',refreshPreview);
    el.addEventListener('change',refreshPreview);
  });
  $('#saveBtn').onclick=saveJSON;
  $('#exportBtn').onclick=exportCSV;
  $('#importFile').addEventListener('change',e=>{const f=e.target.files[0]; if(f) loadJSON(f)});
  $('#printBtn').onclick=()=>{ window.print() };
  $('#newBtn').onclick=()=>{ if(confirm('Clear current data and start a new report?')) location.reload(); };
  $('#copyCurrentToPrev').onclick=copyCurrentToPrevious;
  $('#jumpReportBtn').onclick=()=>{ document.getElementById('reportCard')?.scrollIntoView({behavior:'smooth', block:'start'}); };

  updateBudgetPills(); refreshPreview();
}

document.addEventListener('DOMContentLoaded',init);

/* === Theme Toggle (persisted) === */
(function(){
  const KEY='psrTheme';
  function apply(theme){ document.body.classList.toggle('dark', theme==='dark'); }
  function current(){ return document.body.classList.contains('dark') ? 'dark' : 'light'; }
  document.addEventListener('DOMContentLoaded', function(){
    try{
      const saved = localStorage.getItem(KEY);
      if(saved==='dark') apply('dark');
    }catch(e){}
    const btn=document.getElementById('themeToggle');
    if(btn){
      btn.addEventListener('click', function(){
        const next = current()==='dark' ? 'light' : 'dark';
        apply(next);
        try{ localStorage.setItem(KEY, next); }catch(e){}
      });
    }
  });
})();
</script>
</body>
</html>
