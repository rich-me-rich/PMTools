<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PM Budget Sheet — v0.3 (Budget tab, Baselines & CRs)</title>
<style>
  :root {
    --bg: #ffffff;
    --fg: #1e1f23;
    --muted: #6b7280;
    --accent: #3b82f6;
    --ok: #16a34a;
    --warn: #f59e0b;
    --err: #dc2626;
    --card: #f8fafc;
    --border: #e5e7eb;
  }
  [data-theme="dark"] {
    --bg: #0b0d12;
    --fg: #e5e7eb;
    --muted: #9ca3af;
    --accent: #60a5fa;
    --ok: #22c55e;
    --warn: #fbbf24;
    --err: #ef4444;
    --card: #0f131a;
    --border: #1f2937;
  }
  html,body{height:100%}
  body {
    margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    background: var(--bg); color: var(--fg);
    transition: background .2s ease, color .2s ease;
  }
  header {
    position: sticky; top:0; z-index:10;
    background: var(--bg); border-bottom: 1px solid var(--border);
    padding: 10px 16px; display:flex; align-items:center; gap:16px; flex-wrap: wrap;
  }
  .title { font-weight: 700; }
  .spacer { flex: 1 1 auto; }
  .pill { padding:6px 10px; border:1px solid var(--border); border-radius:8px; background: var(--card); font-size: 13px; }
  .btn { padding:8px 12px; border:1px solid var(--border); border-radius:8px; background: var(--card); cursor:pointer; }
  .btn.primary { background: var(--accent); color:white; border-color: transparent; }
  .btn:hover { opacity:.9 }
  .tabs { display:flex; gap:4px; border-bottom:1px solid var(--border); padding: 0 16px; }
  .tab { padding:12px 14px; cursor:pointer; border-bottom: 2px solid transparent; }
  .tab[aria-selected="true"] { border-bottom-color: var(--accent); color: var(--accent); font-weight: 600; }
  main { padding: 16px; }
  .toolbar { display:flex; gap:8px; align-items:center; margin-bottom: 10px; flex-wrap: wrap; }
  .table { width:100%; border-collapse: collapse; }
  .table th, .table td { padding:10px; border-bottom:1px solid var(--border); text-align:left; vertical-align: top; }
  .table th { font-size: 13px; color: var(--muted); font-weight:600; }
  .kpis { display:grid; grid-template-columns: repeat(6, minmax(180px,1fr)); gap:12px; margin-bottom:16px; }
  .kpi { padding:12px; border:1px solid var(--border); background: var(--card); border-radius:10px; }
  .kpi .label { font-size:12px; color: var(--muted); }
  .kpi .value { font-size:20px; font-weight:700; margin-top:6px; }
  .muted { color: var(--muted); font-size: 12px; }
  .row-actions button { margin-right:6px; }
  .chip { padding:2px 8px; border-radius: 999px; font-size: 12px; border:1px solid var(--border); background: var(--card); }
  .chip.ok { color: var(--ok); border-color: var(--ok); }
  .chip.warn { color: var(--warn); border-color: var(--warn); }
  .chip.err { color: var(--err); border-color: var(--err); }
  dialog { border:1px solid var(--border); border-radius:12px; background: var(--bg); color: var(--fg); width: min(820px, 96vw); }
  form .grid { display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:12px; }
  form label { font-size:12px; color: var(--muted); display:block; margin-bottom:6px; }
  form input, form select, form textarea {
    width:100%; padding:10px; border:1px solid var(--border); border-radius:8px; background: var(--card); color: var(--fg);
  }
  .section { margin-bottom: 20px; }
  .note { font-size:12px; color: var(--muted); }
  .footer-totals { margin-top: 8px; font-size: 13px; color: var(--muted); }
  .psr { white-space: pre-wrap; background: var(--card); border:1px solid var(--border); border-radius:8px; padding:12px; }
  .subtle { font-size: 12px; color: var(--muted); }
  .right { text-align:right; }
</style>
</head>
<body>
<!--
PM Budget Sheet — CHANGE LOG
v0.3 (2025-08-25)
- New Budget tab (Baselines & CRs):
  • Labour baseline rows (resource-level) using Hours × Rate or Lump Sum.
  • Non‑Labour baseline rows (category-level) as cost-only.
  • Change Requests: only Approved hit Approved Budget.
  • Baseline metadata (version/date/reason). Simple re-baseline replaces baseline & bumps version.
- Summary KPIs now compute Approved = Baseline + Approved CRs.
- Timesheets/Invoices toolbars include shortcuts to Budget tab.
v0.2 (2025-08-18)
- Timesheets & Invoices add flows; daily ledger allocation; CSV export; summary wiring.
v0.1 (2025-08-18)
- Initial scaffold.
-->
<header>
  <div class="title">PM Budget Sheet <span class="muted">v0.3</span></div>
  <div class="pill">As of <input id="asOf" type="date" /></div>
  <div class="pill">Reporting <select id="reportingMode"><option>Weekly</option><option selected>Monthly</option></select></div>
  <label class="pill"><input type="checkbox" id="workingDaysOnly" checked /> Working days only (Mon–Fri)</label>
  <div class="spacer"></div>
  <button id="themeBtn" class="btn">Toggle theme</button>
</header>

<nav class="tabs" role="tablist" aria-label="Main tabs">
  <div class="tab" role="tab" aria-selected="true" aria-controls="tab-summary" id="tabbtn-summary">Summary</div>
  <div class="tab" role="tab" aria-selected="false" aria-controls="tab-budget" id="tabbtn-budget">Budget</div>
  <div class="tab" role="tab" aria-selected="false" aria-controls="tab-timesheets" id="tabbtn-timesheets">Timesheets</div>
  <div class="tab" role="tab" aria-selected="false" aria-controls="tab-invoices" id="tabbtn-invoices">Invoices</div>
</nav>

<main>
  <!-- SUMMARY TAB -->
  <section id="tab-summary" role="tabpanel" aria-labelledby="tabbtn-summary">
    <div class="kpis">
      <div class="kpi"><div class="label">Approved Budget</div><div class="value" id="kpiApproved">$0</div><div class="muted" id="kpiApprovedSub">Baseline v— + CRs</div></div>
      <div class="kpi"><div class="label">Spent to Date</div><div class="value" id="kpiSpent">$0</div><div class="muted" id="kpiSpentSub">—</div></div>
      <div class="kpi"><div class="label">Forecast Remaining</div><div class="value" id="kpiForecast">$0</div><div class="muted">Manual (not set)</div></div>
      <div class="kpi"><div class="label">EAC</div><div class="value" id="kpiEAC">$0</div><div class="muted">= Spent + Forecast</div></div>
      <div class="kpi"><div class="label">Variance</div><div class="value" id="kpiVariance">$0</div><div class="muted">= EAC − Approved</div></div>
      <div class="kpi"><div class="label">RAG</div><div class="value" id="kpiRAG">—</div><div class="muted">±5%/10% thresholds</div></div>
    </div>
    <div class="section">
      <h3>PSR Copy</h3>
      <div id="psrCopy" class="psr"></div>
      <div style="margin-top:8px;">
        <button id="copyBtn" class="btn">Copy to clipboard</button>
      </div>
    </div>
  </section>

  <!-- BUDGET TAB -->
  <section id="tab-budget" role="tabpanel" aria-labelledby="tabbtn-budget" hidden>
    <div class="toolbar">
      <strong>Baseline</strong>
      <span class="subtle">Version:</span> <span id="baseVersion" class="pill">—</span>
      <span class="subtle">Dated:</span> <span id="baseDate" class="pill">—</span>
      <button id="saveBaselineBtn" class="btn primary">Save / Re‑baseline</button>
      <span class="spacer"></span>
      <span class="note">Labour baseline uses resource rows (Hours × Rate). Non‑Labour baseline uses cost-only rows by category.</span>
    </div>

    <div class="section">
      <h3>Labour Baseline (Resource rows)</h3>
      <div class="toolbar">
        <button id="addLabourBaseBtn" class="btn">Add Labour row</button>
      </div>
      <table class="table" id="labourBaseTable">
        <thead>
          <tr>
            <th>Resource Name</th><th>Resource ID</th><th>Role</th><th>Period</th><th class="right">Hours</th><th class="right">Rate</th><th class="right">Cost</th><th>Notes</th><th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="footer-totals" id="labourBaseTotals">Totals — Hours: 0 • Cost: $0</div>
    </div>

    <div class="section">
      <h3>Non‑Labour Baseline (Category rows)</h3>
      <div class="toolbar">
        <button id="addNonLabourBaseBtn" class="btn">Add Non‑Labour row</button>
      </div>
      <table class="table" id="nonLabourBaseTable">
        <thead>
          <tr>
            <th>Category</th><th>Label</th><th>Period</th><th class="right">Cost</th><th>Notes</th><th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="footer-totals" id="nonLabourBaseTotals">Totals — Cost: $0</div>
    </div>

    <div class="section">
      <h3>Change Requests (CRs)</h3>
      <div class="toolbar">
        <button id="addCrBtn" class="btn">Add CR</button>
      </div>
      <table class="table" id="crTable">
        <thead>
          <tr>
            <th>CR ID</th><th>Title</th><th>Category</th><th class="right">Amount (+/−)</th><th>Status</th><th>Approved Date</th><th>Owner</th><th>Link</th><th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="footer-totals" id="crTotals">Totals — Approved impact: $0</div>
    </div>
  </section>

  <!-- TIMESHEETS TAB -->
  <section id="tab-timesheets" role="tabpanel" aria-labelledby="tabbtn-timesheets" hidden>
    <div class="toolbar">
      <button id="addTsBtn" class="btn primary">Add Entry</button>
      <button id="exportTsBtn" class="btn">Export CSV</button>
      <button id="tsToBudget" class="btn">Add Labour baseline…</button>
      <span class="spacer"></span>
      <span class="note">Raw entries → allocated to daily ledger automatically.</span>
    </div>
    <table class="table" id="tsTable">
      <thead>
        <tr>
          <th>Period</th><th>Resource</th><th>Role</th><th>Hours</th><th>Rate</th><th>Cost</th><th>Source</th><th>Batch</th><th>Notes</th><th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="footer-totals" id="tsTotals"></div>
  </section>

  <!-- INVOICES TAB -->
  <section id="tab-invoices" role="tabpanel" aria-labelledby="tabbtn-invoices" hidden>
    <div class="toolbar">
      <button id="addInvBtn" class="btn primary">Add Invoice</button>
      <button id="exportInvBtn" class="btn">Export CSV</button>
      <button id="invToBudget" class="btn">Add Non‑labour baseline…</button>
      <span class="spacer"></span>
      <span class="note">Accrual mode supported: post on received date or split across a service window.</span>
    </div>
    <table class="table" id="invTable">
      <thead>
        <tr>
          <th>Invoice #</th><th>Vendor</th><th>Category</th><th>Description</th><th>Amount</th><th>Invoice</th><th>Received</th><th>Paid</th><th>Status</th><th>Accrual</th><th>Posted Period(s)</th><th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="footer-totals" id="invTotals"></div>
  </section>
</main>

<!-- DIALOGS -->
<!-- Timesheet -->
<dialog id="tsDialog">
  <form id="tsForm" method="dialog">
    <h3>Add Timesheet Entry</h3>
    <div class="grid">
      <div><label>Resource Name</label><input name="resource_name" required placeholder="e.g., Alice Tran" /></div>
      <div><label>Resource ID</label><input name="resource_id" required placeholder="e.g., R001" /></div>
      <div><label>Role</label><input name="role" required placeholder="e.g., Senior Dev" /></div>
      <div><label>Hours</label><input name="hours" type="number" min="0" step="0.1" required /></div>
      <div><label>Rate per hour (optional override)</label><input name="rate" type="number" min="0" step="0.01" placeholder="leave blank to use default 0" /></div>
      <div><label>Period start</label><input name="start" type="date" required /></div>
      <div><label>Period end</label><input name="end" type="date" required /></div>
      <div><label>Notes</label><input name="notes" placeholder="optional" /></div>
    </div>
    <div style="margin-top:12px; display:flex; gap:8px; justify-content:flex-end;">
      <button type="button" id="tsCancel" class="btn">Cancel</button>
      <button type="submit" class="btn primary">Save</button>
    </div>
  </form>
</dialog>

<!-- Invoice -->
<dialog id="invDialog">
  <form id="invForm" method="dialog">
    <h3>Add Invoice</h3>
    <div class="grid">
      <div><label>Invoice #</label><input name="invoice_number" required /></div>
      <div><label>Vendor</label><input name="vendor" required /></div>
      <div>
        <label>Category</label>
        <select name="category" required>
          <option value="">— select —</option>
          <option>Labour</option>
          <option>Software</option>
          <option>Hardware</option>
          <option>Travel</option>
          <option>Other</option>
          <option>Contingency</option>
        </select>
      </div>
      <div><label>Description</label><input name="description" /></div>
      <div><label>Amount</label><input name="amount" type="number" min="0.01" step="0.01" required /></div>
      <div><label>Invoice date</label><input name="invoice_date" type="date" required /></div>
      <div><label>Received date</label><input name="received_date" type="date" required /></div>
      <div><label>Paid date (optional)</label><input name="paid_date" type="date" /></div>
      <div>
        <label>Status</label>
        <select name="status" required>
          <option>Pending</option>
          <option>Paid</option>
          <option>Disputed</option>
        </select>
      </div>
      <div>
        <label>Accrual mode</label>
        <select name="accrual">
          <option value="none">None (post on received date)</option>
          <option value="window">Service window split</option>
        </select>
      </div>
      <div><label>Service start (if window)</label><input name="svc_start" type="date" /></div>
      <div><label>Service end (if window)</label><input name="svc_end" type="date" /></div>
    </div>
    <div class="grid">
      <div><label>CR/PO Ref (optional)</label><input name="ref" /></div>
      <div><label>Notes</label><input name="notes" /></div>
    </div>
    <div style="margin-top:12px; display:flex; gap:8px; justify-content:flex-end;">
      <button type="button" id="invCancel" class="btn">Cancel</button>
      <button type="submit" class="btn primary">Save</button>
    </div>
  </form>
</dialog>

<!-- Budget: Labour baseline row -->
<dialog id="labourBaseDialog">
  <form id="labourBaseForm" method="dialog">
    <h3>Add Labour Baseline Row</h3>
    <div class="grid">
      <div><label>Resource Name</label><input name="resource_name" required /></div>
      <div><label>Resource ID</label><input name="resource_id" required /></div>
      <div><label>Role</label><input name="role" required /></div>
      <div><label>Period start</label><input name="start" type="date" required /></div>
      <div><label>Period end</label><input name="end" type="date" required /></div>
      <div><label>Budget hours</label><input name="hours" type="number" min="0" step="0.1" required /></div>
      <div><label>Rate per hour</label><input name="rate" type="number" min="0" step="0.01" required /></div>
      <div><label>Notes</label><input name="notes" /></div>
    </div>
    <div style="margin-top:12px; display:flex; gap:8px; justify-content:flex-end;">
      <button type="button" id="labourBaseCancel" class="btn">Cancel</button>
      <button type="submit" class="btn primary">Save</button>
    </div>
  </form>
</dialog>

<!-- Budget: Non‑labour baseline row -->
<dialog id="nonLabourBaseDialog">
  <form id="nonLabourBaseForm" method="dialog">
    <h3>Add Non‑Labour Baseline Row</h3>
    <div class="grid">
      <div>
        <label>Category</label>
        <select name="category" required>
          <option value="">— select —</option>
          <option>Software</option>
          <option>Hardware</option>
          <option>Travel</option>
          <option>Other</option>
          <option>Contingency</option>
        </select>
      </div>
      <div><label>Label</label><input name="label" required placeholder="e.g., Vendor X annual sub" /></div>
      <div><label>Period start (optional)</label><input name="start" type="date" /></div>
      <div><label>Period end (optional)</label><input name="end" type="date" /></div>
      <div><label>Budget cost</label><input name="cost" type="number" min="0" step="0.01" required /></div>
      <div><label>Notes</label><input name="notes" /></div>
    </div>
    <div style="margin-top:12px; display:flex; gap:8px; justify-content:flex-end;">
      <button type="button" id="nonLabourBaseCancel" class="btn">Cancel</button>
      <button type="submit" class="btn primary">Save</button>
    </div>
  </form>
</dialog>

<!-- Budget: CR row -->
<dialog id="crDialog">
  <form id="crForm" method="dialog">
    <h3>Add Change Request (CR)</h3>
    <div class="grid">
      <div><label>CR ID</label><input name="cr_id" required placeholder="CR-001" /></div>
      <div><label>Title</label><input name="title" required /></div>
      <div>
        <label>Category</label>
        <select name="category" required>
          <option>Labour</option>
          <option>Software</option>
          <option>Hardware</option>
          <option>Travel</option>
          <option>Other</option>
          <option>Contingency</option>
        </select>
      </div>
      <div><label>Amount (+/−)</label><input name="amount" type="number" step="0.01" required /></div>
      <div>
        <label>Status</label>
        <select name="status" required>
          <option>Proposed</option>
          <option selected>Approved</option>
          <option>Rejected</option>
        </select>
      </div>
      <div><label>Approved Date</label><input name="approved_date" type="date" /></div>
      <div><label>Owner</label><input name="owner" /></div>
      <div><label>Link</label><input name="link" placeholder="URL" /></div>
    </div>
    <div style="margin-top:12px; display:flex; gap:8px; justify-content:flex-end;">
      <button type="button" id="crCancel" class="btn">Cancel</button>
      <button type="submit" class="btn primary">Save</button>
    </div>
  </form>
</dialog>

<script>
/* ---------------------------
   Minimal Data Layer (v0.3)
----------------------------*/
const LS_KEY = "pm_budget_v03";
const state = loadState() || {
  settings: {
    currency: "AUD",
    reportingMode: "Monthly",
    workingDaysOnly: true,
    rag: { green: 5, amber: 10 }
  },
  resources: {},         // default rates per resource_id
  baseline: {
    version: 0, date: "", reason: "",
    labour_rows: [],      // resource rows: hours × rate
    nonlabour_rows: []    // category cost rows
  },
  crs: [],               // change requests
  timesheets: [],        // raw timesheet rows
  invoices: [],          // raw invoice rows
  ledger: [],            // daily facts
  batches: []
};

function persist(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }
function loadState(){
  try{ const s = localStorage.getItem(LS_KEY); return s ? JSON.parse(s) : null; }
  catch(e){ console.warn("Failed to load state", e); return null; }
}

/* Utilities */
const fmt0 = new Intl.NumberFormat(undefined, { style:'currency', currency: 'AUD', maximumFractionDigits: 0 });
const fmt2 = new Intl.NumberFormat(undefined, { style:'currency', currency: 'AUD', maximumFractionDigits: 2 });
function fmt(x){ return fmt0.format(x||0); }
function toISO(d){ return (new Date(d)).toISOString().slice(0,10); }
function daysBetween(start,end, workingOnly=true){
  if(!start || !end) return [];
  const s = new Date(start); const e = new Date(end);
  const out = [];
  for(let d=new Date(s); d<=e; d.setDate(d.getDate()+1)){
    const day = d.getDay(); // 0 Sun ... 6 Sat
    if(!workingOnly || (day>=1 && day<=5)){
      out.push(toISO(d));
    }
  }
  return out;
}
function uid(prefix){ return prefix + "-" + Math.random().toString(36).slice(2,9); }

/* ---------------------------
   Ledger Allocation
----------------------------*/
function clearLedgerByRef(ref_id){ state.ledger = state.ledger.filter(r => r.ref_id !== ref_id); }
function addLedgerRow(row){ state.ledger.push(row); }

function allocateTimesheet(ts){
  const days = daysBetween(ts.start, ts.end, state.settings.workingDaysOnly);
  const n = Math.max(1, days.length);
  const defaultRate = (state.resources[ts.resource_id]?.rate) ?? 0;
  const rate = ts.rate != null && ts.rate !== "" ? Number(ts.rate) : defaultRate;
  const perDayHours = Number(ts.hours) / n;
  let remaining = Number(ts.hours);
  days.forEach((date, idx) => {
    const hours = (idx === days.length-1) ? remaining : Number((perDayHours).toFixed(2));
    remaining = Number((remaining - hours).toFixed(2));
    const cost = hours * rate;
    addLedgerRow({
      date, category:"Labour", resource_id: ts.resource_id, hours, rate_applied: rate, cost,
      source: "Timesheet", ref_id: ts.id, meta: { resource_name: ts.resource_name, role: ts.role }
    });
  });
}

function allocateInvoice(inv){
  const amount = Number(inv.amount);
  if(inv.accrual === "window"){
    if(!inv.svc_start || !inv.svc_end){ alert("Service window requires start/end dates."); return; }
    const days = daysBetween(inv.svc_start, inv.svc_end, state.settings.workingDaysOnly);
    const n = Math.max(1, days.length);
    const perDay = amount / n;
    let remaining = amount;
    days.forEach((date, idx) => {
      const cost = (idx === days.length-1) ? remaining : Number(perDay.toFixed(2));
      remaining = Number((remaining - cost).toFixed(2));
      addLedgerRow({ date, category: inv.category, cost, source: "Invoice", ref_id: inv.id,
        meta: { invoice_number: inv.invoice_number, vendor: inv.vendor } });
    });
  } else {
    const date = inv.received_date;
    addLedgerRow({ date, category: inv.category, cost: amount, source: "Invoice", ref_id: inv.id,
      meta: { invoice_number: inv.invoice_number, vendor: inv.vendor } });
  }
}

/* ---------------------------
   Budget math
----------------------------*/
function labourBaselineTotals(){
  let hours = 0, cost = 0;
  for(const r of state.baseline.labour_rows){
    hours += Number(r.hours)||0;
    cost += Number(r.hours||0) * Number(r.rate||0);
  }
  return {hours, cost};
}
function nonLabourBaselineTotal(){
  let cost = 0; for(const r of state.baseline.nonlabour_rows){ cost += Number(r.cost)||0; }
  return cost;
}
function crApprovedTotal(){
  let total = 0;
  for(const c of state.crs){ if(c.status === "Approved"){ total += Number(c.amount)||0; } }
  return total;
}
function approvedBudgetByCategory(){
  // Labour treated as a category for reporting
  const map = new Map();
  // Labour baseline
  const labourCost = labourBaselineTotals().cost;
  if(labourCost) map.set("Labour", (map.get("Labour")||0) + labourCost);
  // Non-labour baseline
  for(const r of state.baseline.nonlabour_rows){
    map.set(r.category, (map.get(r.category)||0) + (Number(r.cost)||0));
  }
  // CRs (approved)
  for(const c of state.crs){
    if(c.status !== "Approved") continue;
    map.set(c.category, (map.get(c.category)||0) + (Number(c.amount)||0));
  }
  return map;
}

/* ---------------------------
   KPIs (Summary)
----------------------------*/
function computeKPIs(){
  const approvedByCat = approvedBudgetByCategory();
  let approved = 0; approvedByCat.forEach(v => approved += v);
  const asOf = document.getElementById("asOf").value || toISO(new Date());
  let spent = 0;
  for(const row of state.ledger){ if(row.date <= asOf) spent += Number(row.cost); }
  const forecast = 0; // to be added in Forecast tab
  const eac = spent + forecast;
  const variance = eac - approved;

  // RAG
  let rag = "—";
  if(approved > 0){
    const varPct = (variance / approved) * 100;
    const abs = Math.abs(varPct);
    rag = abs <= state.settings.rag.green ? "Green" : (abs <= state.settings.rag.amber ? "Amber" : "Red");
  }

  document.getElementById("kpiApproved").textContent = fmt(approved);
  const vText = state.baseline.version ? "Baseline v"+state.baseline.version : "No baseline";
  document.getElementById("kpiApprovedSub").textContent = vText + " • CRs (Approved): " + fmt(crApprovedTotal());
  document.getElementById("kpiSpent").textContent = fmt(spent);
  document.getElementById("kpiForecast").textContent = fmt(forecast);
  document.getElementById("kpiEAC").textContent = fmt(eac);
  document.getElementById("kpiVariance").textContent = fmt(variance);
  document.getElementById("kpiRAG").textContent = rag;

  const psr = `Budget: Approved ${fmt(approved)}; Spent to date ${fmt(spent)}; Forecast remaining ${fmt(forecast)}; EAC ${fmt(eac)} (Variance ${fmt(variance)}; RAG: ${rag}). As-of ${asOf}.`;
  document.getElementById("psrCopy").textContent = psr;
  // baseline meta
  document.getElementById("baseVersion").textContent = state.baseline.version || "—";
  document.getElementById("baseDate").textContent = state.baseline.date || "—";
}

/* ---------------------------
   Rendering Tables
----------------------------*/
function renderLabourBaseline(){
  const tbody = document.querySelector("#labourBaseTable tbody");
  tbody.innerHTML = "";
  let totH=0, totC=0;
  for(const r of state.baseline.labour_rows){
    const cost = Number(r.hours||0) * Number(r.rate||0);
    totH += Number(r.hours||0); totC += cost;
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.resource_name}</td>
      <td>${r.resource_id}</td>
      <td>${r.role}</td>
      <td>${r.start} → ${r.end}</td>
      <td class="right">${(Number(r.hours)||0).toFixed(1)}</td>
      <td class="right">${fmt2.format(Number(r.rate)||0)}</td>
      <td class="right">${fmt2.format(cost)}</td>
      <td>${r.notes||""}</td>
      <td>
        <div class="row-actions">
          <button class="btn" data-del-lb="${r.id}">Delete</button>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  }
  document.getElementById("labourBaseTotals").textContent = `Totals — Hours: ${totH.toFixed(1)} • Cost: ${fmt2.format(totC)}`;
  tbody.querySelectorAll("[data-del-lb]").forEach(btn => {
    btn.addEventListener("click",(e)=>{
      const id = e.currentTarget.getAttribute("data-del-lb");
      state.baseline.labour_rows = state.baseline.labour_rows.filter(x=>x.id!==id);
      persist(); renderLabourBaseline(); computeKPIs();
    });
  });
}
function renderNonLabourBaseline(){
  const tbody = document.querySelector("#nonLabourBaseTable tbody");
  tbody.innerHTML = "";
  let totC=0;
  for(const r of state.baseline.nonlabour_rows){
    const cost = Number(r.cost)||0; totC += cost;
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.category}</td>
      <td>${r.label}</td>
      <td>${(r.start||"")} ${(r.start||r.end)? "→": ""} ${(r.end||"")}</td>
      <td class="right">${fmt2.format(cost)}</td>
      <td>${r.notes||""}</td>
      <td><div class="row-actions"><button class="btn" data-del-nb="${r.id}">Delete</button></div></td>
    `;
    tbody.appendChild(tr);
  }
  document.getElementById("nonLabourBaseTotals").textContent = `Totals — Cost: ${fmt2.format(totC)}`;
  tbody.querySelectorAll("[data-del-nb]").forEach(btn => {
    btn.addEventListener("click",(e)=>{
      const id = e.currentTarget.getAttribute("data-del-nb");
      state.baseline.nonlabour_rows = state.baseline.nonlabour_rows.filter(x=>x.id!==id);
      persist(); renderNonLabourBaseline(); computeKPIs();
    });
  });
}
function renderCRs(){
  const tbody = document.querySelector("#crTable tbody");
  tbody.innerHTML = "";
  let tot = 0;
  for(const c of state.crs){
    if(c.status === "Approved") tot += Number(c.amount)||0;
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${c.cr_id}</td>
      <td>${c.title}</td>
      <td>${c.category}</td>
      <td class="right">${fmt2.format(Number(c.amount)||0)}</td>
      <td>${c.status}</td>
      <td>${c.approved_date||""}</td>
      <td>${c.owner||""}</td>
      <td>${c.link? `<a href="${c.link}" target="_blank">link</a>`:""}</td>
      <td><div class="row-actions"><button class="btn" data-del-cr="${c.cr_id}">Delete</button></div></td>
    `;
    tbody.appendChild(tr);
  }
  document.getElementById("crTotals").textContent = `Totals — Approved impact: ${fmt2.format(tot)}`;
  tbody.querySelectorAll("[data-del-cr]").forEach(btn => {
    btn.addEventListener("click",(e)=>{
      const id = e.currentTarget.getAttribute("data-del-cr");
      state.crs = state.crs.filter(x=>x.cr_id!==id);
      persist(); renderCRs(); computeKPIs();
    });
  });
}

function renderTimesheets(){
  const tbody = document.querySelector("#tsTable tbody");
  tbody.innerHTML = "";
  let totH = 0, totC = 0;
  for(const ts of state.timesheets){
    const rate = (ts.rate != null && ts.rate !== "") ? Number(ts.rate) : (state.resources[ts.resource_id]?.rate ?? 0);
    const cost = Number(ts.hours) * rate;
    totH += Number(ts.hours);
    totC += cost;
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${ts.start} → ${ts.end}</td>
      <td>${ts.resource_name} <span class="muted">(${ts.resource_id})</span></td>
      <td>${ts.role}</td>
      <td>${Number(ts.hours).toFixed(2)}</td>
      <td>${rate? fmt2.format(rate) : "—"}</td>
      <td>${fmt2.format(cost)}</td>
      <td>${ts.source}</td>
      <td>${ts.batch_id}</td>
      <td>${ts.notes || ""}</td>
      <td>
        <div class="row-actions">
          <button data-view-ledger="${ts.id}" class="btn">View ledger</button>
          <button data-delete-ts="${ts.id}" class="btn">Delete</button>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  }
  document.getElementById("tsTotals").textContent = `Totals — Hours: ${totH.toFixed(2)} • Cost: ${fmt2.format(totC)}`;

  tbody.querySelectorAll("[data-delete-ts]").forEach(btn => {
    btn.addEventListener("click", (e) => {
      const id = e.currentTarget.getAttribute("data-delete-ts");
      state.timesheets = state.timesheets.filter(r => r.id !== id);
      clearLedgerByRef(id);
      persist(); renderTimesheets(); renderInvoices(); computeKPIs();
    });
  });
  tbody.querySelectorAll("[data-view-ledger]").forEach(btn => {
    btn.addEventListener("click", (e)=>{
      const id = e.currentTarget.getAttribute("data-view-ledger");
      const rows = state.ledger.filter(r => r.ref_id === id).sort((a,b)=>a.date.localeCompare(b.date));
      const details = rows.map(r => `${r.date} — ${fmt2.format(r.cost)} (${r.hours?.toFixed?.(2) ?? "-"}h @ ${r.rate_applied ?? "-"} )`).join("\n");
      alert(details || "No ledger rows.");
    });
  });
}

function renderInvoices(){
  const tbody = document.querySelector("#invTable tbody");
  tbody.innerHTML = "";
  let tot = 0;
  for(const inv of state.invoices){
    tot += Number(inv.amount);
    const postedPeriods = summarizePostedPeriods(inv.id);
    const accrualLabel = inv.accrual === "window" ? "Service window" : "Received date";
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${inv.invoice_number}</td>
      <td>${inv.vendor}</td>
      <td>${inv.category}</td>
      <td>${inv.description || ""}</td>
      <td>${fmt2.format(inv.amount)}</td>
      <td>${inv.invoice_date}</td>
      <td>${inv.received_date}</td>
      <td>${inv.paid_date || ""}</td>
      <td><span class="chip ${inv.status==='Paid'?'ok':(inv.status==='Disputed'?'err':'warn')}">${inv.status}</span></td>
      <td>${accrualLabel}</td>
      <td>${postedPeriods}</td>
      <td>
        <div class="row-actions">
          <button data-view-ledger="${inv.id}" class="btn">View ledger</button>
          <button data-delete-inv="${inv.id}" class="btn">Delete</button>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  }
  document.getElementById("invTotals").textContent = `Totals — Count: ${state.invoices.length} • Amount: ${fmt2.format(tot)}`;

  tbody.querySelectorAll("[data-delete-inv]").forEach(btn => {
    btn.addEventListener("click", (e)=>{
      const id = e.currentTarget.getAttribute("data-delete-inv");
      state.invoices = state.invoices.filter(r => r.id !== id);
      clearLedgerByRef(id);
      persist(); renderInvoices(); renderTimesheets(); computeKPIs();
    });
  });
  tbody.querySelectorAll("[data-view-ledger]").forEach(btn => {
    btn.addEventListener("click", (e)=>{
      const id = e.currentTarget.getAttribute("data-view-ledger");
      const rows = state.ledger.filter(r => r.ref_id === id).sort((a,b)=>a.date.localeCompare(b.date));
      const details = rows.map(r => `${r.date} — ${fmt2.format(r.cost)}`).join("\n");
      alert(details || "No ledger rows.");
    });
  });
}

function summarizePostedPeriods(ref_id){
  const byMonth = new Map();
  const rows = state.ledger.filter(r => r.ref_id === ref_id);
  rows.forEach(r => {
    const k = r.date.slice(0,7); // YYYY-MM
    byMonth.set(k, (byMonth.get(k)||0) + Number(r.cost));
  });
  return [...byMonth.entries()].map(([k,v])=>`${k} (${fmt2.format(v)})`).join(", ");
}

/* ---------------------------
   UI Wiring
----------------------------*/
function switchTab(id){
  document.querySelectorAll("main > section").forEach(sec => sec.hidden = true);
  document.querySelectorAll(".tab").forEach(t => t.setAttribute("aria-selected","false"));
  document.getElementById("tab-"+id).hidden = false;
  document.getElementById("tabbtn-"+id).setAttribute("aria-selected","true");
}

document.getElementById("tabbtn-summary").addEventListener("click", ()=>switchTab("summary"));
document.getElementById("tabbtn-budget").addEventListener("click", ()=>switchTab("budget"));
document.getElementById("tabbtn-timesheets").addEventListener("click", ()=>switchTab("timesheets"));
document.getElementById("tabbtn-invoices").addEventListener("click", ()=>switchTab("invoices"));

document.getElementById("tsToBudget").addEventListener("click", ()=>switchTab("budget"));
document.getElementById("invToBudget").addEventListener("click", ()=>switchTab("budget"));

const themeBtn = document.getElementById("themeBtn");
themeBtn.addEventListener("click", ()=>{
  const d = document.documentElement;
  const dark = d.getAttribute("data-theme")==="dark";
  d.setAttribute("data-theme", dark? "": "dark");
});

// As-of date default = today
document.getElementById("asOf").value = toISO(new Date());
document.getElementById("asOf").addEventListener("change", ()=>computeKPIs());

// Reporting mode toggle
document.getElementById("reportingMode").value = state.settings.reportingMode;
document.getElementById("reportingMode").addEventListener("change", (e)=>{
  state.settings.reportingMode = e.target.value; persist();
  computeKPIs();
});

// Working days switch
const wdo = document.getElementById("workingDaysOnly");
wdo.checked = state.settings.workingDaysOnly;
wdo.addEventListener("change", ()=>{
  state.settings.workingDaysOnly = wdo.checked;
  const tsCopy = [...state.timesheets];
  const invCopy = [...state.invoices];
  state.ledger = [];
  tsCopy.forEach(allocateTimesheet);
  invCopy.forEach(allocateInvoice);
  persist(); renderTimesheets(); renderInvoices(); computeKPIs();
});

/* Timesheet modal */
const tsDialog = document.getElementById("tsDialog");
document.getElementById("addTsBtn").addEventListener("click", ()=>tsDialog.showModal());
document.getElementById("tsCancel").addEventListener("click", ()=>tsDialog.close());
document.getElementById("tsForm").addEventListener("submit", (e)=>{
  e.preventDefault();
  const fd = new FormData(e.target);
  const hours = Number(fd.get("hours"));
  const start = fd.get("start"); const end = fd.get("end");
  if(!start || !end){ alert("Please provide a period start and end."); return; }
  if(new Date(end) < new Date(start)){ alert("End date must be on/after start date."); return; }
  if(!(hours >= 0)){ alert("Hours must be ≥ 0."); return; }
  const ts = {
    id: uid("TS"),
    resource_name: fd.get("resource_name").trim(),
    resource_id: fd.get("resource_id").trim(),
    role: fd.get("role").trim(),
    hours: hours,
    rate: fd.get("rate") ? Number(fd.get("rate")) : "",
    start, end,
    notes: fd.get("notes")?.trim(),
    source: "Manual",
    batch_id: "manual-" + new Date().toISOString().slice(0,19)
  };
  state.timesheets.push(ts);
  if(!state.resources[ts.resource_id]){
    state.resources[ts.resource_id] = { name: ts.resource_name, role: ts.role, rate: ts.rate || 0 };
  }
  allocateTimesheet(ts);
  persist(); renderTimesheets(); computeKPIs();
  tsDialog.close(); e.target.reset();
});

/* Invoice modal */
const invDialog = document.getElementById("invDialog");
document.getElementById("addInvBtn").addEventListener("click", ()=>invDialog.showModal());
document.getElementById("invCancel").addEventListener("click", ()=>invDialog.close());
document.getElementById("invForm").addEventListener("submit", (e)=>{
  e.preventDefault();
  const fd = new FormData(e.target);
  const inv = {
    id: uid("INV"),
    invoice_number: fd.get("invoice_number").trim(),
    vendor: fd.get("vendor").trim(),
    category: fd.get("category"),
    description: fd.get("description")?.trim(),
    amount: Number(fd.get("amount")),
    invoice_date: fd.get("invoice_date"),
    received_date: fd.get("received_date"),
    paid_date: fd.get("paid_date") || "",
    status: fd.get("status"),
    accrual: fd.get("accrual"),
    svc_start: fd.get("svc_start") || "",
    svc_end: fd.get("svc_end") || "",
    ref: fd.get("ref")?.trim() || "",
    notes: fd.get("notes")?.trim() || "",
    batch_id: "manual-" + new Date().toISOString().slice(0,19)
  };
  if(!inv.invoice_number || !inv.vendor || !inv.category || !(inv.amount>0) || !inv.invoice_date || !inv.received_date || !inv.status){
    alert("Please complete all required fields (Invoice #, Vendor, Category, Amount, Invoice date, Received date, Status).");
    return;
  }
  if(inv.paid_date && (new Date(inv.paid_date) < new Date(inv.received_date))){
    alert("Paid date must be on/after received date."); return;
  }
  if(inv.accrual === "window"){
    if(!inv.svc_start || !inv.svc_end || new Date(inv.svc_end) < new Date(inv.svc_start)){
      alert("Service window requires a valid start and end date."); return;
    }
  }
  state.invoices.push(inv);
  allocateInvoice(inv);
  persist(); renderInvoices(); computeKPIs();
  invDialog.close(); e.target.reset();
});

/* Budget: Labour baseline modal */
const labourBaseDialog = document.getElementById("labourBaseDialog");
document.getElementById("addLabourBaseBtn").addEventListener("click", ()=>labourBaseDialog.showModal());
document.getElementById("labourBaseCancel").addEventListener("click", ()=>labourBaseDialog.close());
document.getElementById("labourBaseForm").addEventListener("submit",(e)=>{
  e.preventDefault();
  const fd = new FormData(e.target);
  const start = fd.get("start"); const end = fd.get("end");
  if(!start || !end || new Date(end) < new Date(start)){ alert("Please provide a valid period."); return; }
  const row = {
    id: uid("LB"),
    resource_name: fd.get("resource_name").trim(),
    resource_id: fd.get("resource_id").trim(),
    role: fd.get("role").trim(),
    start, end,
    hours: Number(fd.get("hours")),
    rate: Number(fd.get("rate")),
    notes: fd.get("notes")?.trim()
  };
  state.baseline.labour_rows.push(row);
  // seed resource rate directory
  if(!state.resources[row.resource_id]){
    state.resources[row.resource_id] = { name: row.resource_name, role: row.role, rate: row.rate || 0 };
  }
  persist(); renderLabourBaseline(); computeKPIs();
  labourBaseDialog.close(); e.target.reset();
});

/* Budget: Non‑labour baseline modal */
const nonLabourBaseDialog = document.getElementById("nonLabourBaseDialog");
document.getElementById("addNonLabourBaseBtn").addEventListener("click", ()=>nonLabourBaseDialog.showModal());
document.getElementById("nonLabourBaseCancel").addEventListener("click", ()=>nonLabourBaseDialog.close());
document.getElementById("nonLabourBaseForm").addEventListener("submit",(e)=>{
  e.preventDefault();
  const fd = new FormData(e.target);
  const row = {
    id: uid("NB"),
    category: fd.get("category"),
    label: fd.get("label").trim(),
    start: fd.get("start") || "",
    end: fd.get("end") || "",
    cost: Number(fd.get("cost")),
    notes: fd.get("notes")?.trim()
  };
  if(!row.category || !row.label || !(row.cost>=0)){ alert("Please complete Category, Label and Cost."); return; }
  if(row.start && row.end && new Date(row.end) < new Date(row.start)){ alert("End date must be after start."); return; }
  state.baseline.nonlabour_rows.push(row);
  persist(); renderNonLabourBaseline(); computeKPIs();
  nonLabourBaseDialog.close(); e.target.reset();
});

/* Budget: CR modal */
const crDialog = document.getElementById("crDialog");
document.getElementById("addCrBtn").addEventListener("click", ()=>crDialog.showModal());
document.getElementById("crCancel").addEventListener("click", ()=>crDialog.close());
document.getElementById("crForm").addEventListener("submit",(e)=>{
  e.preventDefault();
  const fd = new FormData(e.target);
  const cr = {
    cr_id: fd.get("cr_id").trim(),
    title: fd.get("title").trim(),
    category: fd.get("category"),
    amount: Number(fd.get("amount")),
    status: fd.get("status"),
    approved_date: fd.get("approved_date") || "",
    owner: fd.get("owner") || "",
    link: fd.get("link") || ""
  };
  if(!cr.cr_id || !cr.title || !cr.category || isNaN(cr.amount)){ alert("Please complete CR ID, Title, Category and Amount."); return; }
  state.crs.push(cr);
  persist(); renderCRs(); computeKPIs();
  crDialog.close(); e.target.reset();
});

/* Save / Re-baseline */
document.getElementById("saveBaselineBtn").addEventListener("click", ()=>{
  // very simple versioning: bump version, stamp date
  const v = (state.baseline.version||0) + 1;
  state.baseline.version = v;
  state.baseline.date = toISO(new Date());
  const reason = prompt("Baseline saved. Enter a reason (optional):","Initial baseline");
  if(reason!=null) state.baseline.reason = reason;
  persist(); computeKPIs();
  alert(`Baseline saved as v${v}.`);
});

/* Export (CSV) basic */
document.getElementById("exportTsBtn").addEventListener("click", ()=>{
  const header = ["resource_id","resource_name","role","period_start","period_end","hours","rate_per_hour","notes","source","batch_id","id"];
  const rows = state.timesheets.map(r => [r.resource_id,r.resource_name,r.role,r.start,r.end,r.hours,r.rate||"",r.notes||"",r.source,r.batch_id,r.id]);
  const csv = [header.join(","), ...rows.map(a=>a.map(x=>String(x).replaceAll('"','""')).map(x=>/[,\"\n]/.test(x)?`"${x}"`:x).join(","))].join("\n");
  const blob = new Blob([csv], {type:"text/csv"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a"); a.href = url; a.download = "timesheets_export.csv"; a.click(); URL.revokeObjectURL(url);
});
document.getElementById("exportInvBtn").addEventListener("click", ()=>{
  const header = ["invoice_number","vendor","category","description","amount","invoice_date","received_date","paid_date","status","accrual_mode","service_start","service_end","ref","notes","batch_id","id"];
  const rows = state.invoices.map(r => [r.invoice_number,r.vendor,r.category,r.description||"",r.amount,r.invoice_date,r.received_date,r.paid_date||"",r.status,r.accrual,r.svc_start||"",r.svc_end||"",r.ref||"",r.notes||"",r.batch_id,r.id]);
  const csv = [header.join(","), ...rows.map(a=>a.map(x=>String(x).replaceAll('"','""')).map(x=>/[,\"\n]/.test(x)?`"${x}"`:x).join(","))].join("\n");
  const blob = new Blob([csv], {type:"text/csv"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a"); a.href = url; a.download = "invoices_export.csv"; a.click(); URL.revokeObjectURL(url);
});

/* Copy PSR text */
document.getElementById("copyBtn").addEventListener("click", async ()=>{
  const txt = document.getElementById("psrCopy").textContent;
  try{ await navigator.clipboard.writeText(txt); alert("Copied!"); } catch(e){ alert("Copy failed. Select the text and copy manually."); }
});

/* Initial render */
document.getElementById("asOf").value = toISO(new Date());
renderLabourBaseline();
renderNonLabourBaseline();
renderCRs();
renderTimesheets();
renderInvoices();
computeKPIs();
</script>
</body>
</html>
